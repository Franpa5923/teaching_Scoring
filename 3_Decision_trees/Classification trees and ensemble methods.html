<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Louis OLIVE">

<title>Classification trees and ensemble methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Classification trees and ensemble methods_files/libs/clipboard/clipboard.min.js"></script>
<script src="Classification trees and ensemble methods_files/libs/quarto-html/quarto.js"></script>
<script src="Classification trees and ensemble methods_files/libs/quarto-html/popper.min.js"></script>
<script src="Classification trees and ensemble methods_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Classification trees and ensemble methods_files/libs/quarto-html/anchor.min.js"></script>
<link href="Classification trees and ensemble methods_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Classification trees and ensemble methods_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Classification trees and ensemble methods_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Classification trees and ensemble methods_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Classification trees and ensemble methods_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script>
  MathJax = {
    tex: {
      tags: 'ams'  // should be 'ams', 'none', or 'all'
    }
  };
</script>

<link href="Classification trees and ensemble methods_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="Classification trees and ensemble methods_files/libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-decision-tree" id="toc-sec-decision-tree" class="nav-link active" data-scroll-target="#sec-decision-tree"><span class="header-section-number">1</span> Decision tree implementation: CART</a>
  <ul class="collapse">
  <li><a href="#splitting-criterion" id="toc-splitting-criterion" class="nav-link" data-scroll-target="#splitting-criterion"><span class="header-section-number">1.1</span> Splitting criterion</a></li>
  <li><a href="#tree-building-process" id="toc-tree-building-process" class="nav-link" data-scroll-target="#tree-building-process"><span class="header-section-number">1.2</span> Tree-building process</a></li>
  <li><a href="#building-strategy---pruning" id="toc-building-strategy---pruning" class="nav-link" data-scroll-target="#building-strategy---pruning"><span class="header-section-number">1.3</span> Building strategy - Pruning</a></li>
  <li><a href="#additional-ressources" id="toc-additional-ressources" class="nav-link" data-scroll-target="#additional-ressources"><span class="header-section-number">1.4</span> Additional ressources</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">1.5</span> Exercises</a>
  <ul class="collapse">
  <li><a href="#exercice-1-completed-in-case-study" id="toc-exercice-1-completed-in-case-study" class="nav-link" data-scroll-target="#exercice-1-completed-in-case-study"><span class="header-section-number">1.5.1</span> Exercice 1 (completed in Case Study)</a></li>
  <li><a href="#exercice-2-inspired-from-a.-géron-book" id="toc-exercice-2-inspired-from-a.-géron-book" class="nav-link" data-scroll-target="#exercice-2-inspired-from-a.-géron-book"><span class="header-section-number">1.5.2</span> Exercice 2 (Inspired from A. Géron book)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#ensemble-methods---boosting" id="toc-ensemble-methods---boosting" class="nav-link" data-scroll-target="#ensemble-methods---boosting"><span class="header-section-number">2</span> Ensemble methods - Boosting</a>
  <ul class="collapse">
  <li><a href="#adaboost" id="toc-adaboost" class="nav-link" data-scroll-target="#adaboost"><span class="header-section-number">2.1</span> Adaboost</a></li>
  <li><a href="#derivation-of-adaboost-statistical-view" id="toc-derivation-of-adaboost-statistical-view" class="nav-link" data-scroll-target="#derivation-of-adaboost-statistical-view"><span class="header-section-number">2.2</span> Derivation of AdaBoost: statistical view</a>
  <ul class="collapse">
  <li><a href="#adaboost-fits-an-additive-model" id="toc-adaboost-fits-an-additive-model" class="nav-link" data-scroll-target="#adaboost-fits-an-additive-model"><span class="header-section-number">2.2.1</span> AdaBoost fits an additive model</a></li>
  <li><a href="#forward-stagewise-additive-model-fsam" id="toc-forward-stagewise-additive-model-fsam" class="nav-link" data-scroll-target="#forward-stagewise-additive-model-fsam"><span class="header-section-number">2.2.2</span> Forward Stagewise Additive Model (FSAM)</a></li>
  <li><a href="#adaboost-fits-a-fsam-for-exponential-loss" id="toc-adaboost-fits-a-fsam-for-exponential-loss" class="nav-link" data-scroll-target="#adaboost-fits-a-fsam-for-exponential-loss"><span class="header-section-number">2.2.3</span> AdaBoost fits a FSAM for exponential loss</a></li>
  <li><a href="#loss-functions-for-binary-classification-margin" id="toc-loss-functions-for-binary-classification-margin" class="nav-link" data-scroll-target="#loss-functions-for-binary-classification-margin"><span class="header-section-number">2.2.4</span> Loss functions for binary classification / margin</a></li>
  </ul></li>
  <li><a href="#introducing-logitboost-algorithm" id="toc-introducing-logitboost-algorithm" class="nav-link" data-scroll-target="#introducing-logitboost-algorithm"><span class="header-section-number">2.3</span> Introducing LogitBoost algorithm</a></li>
  <li><a href="#gradientnewton-boosted-trees" id="toc-gradientnewton-boosted-trees" class="nav-link" data-scroll-target="#gradientnewton-boosted-trees"><span class="header-section-number">2.4</span> Gradient/Newton Boosted Trees</a></li>
  <li><a href="#sec-gradboost" id="toc-sec-gradboost" class="nav-link" data-scroll-target="#sec-gradboost"><span class="header-section-number">2.5</span> (Logit)Boost as an optimisation method in “function space”</a></li>
  <li><a href="#additional-ressources-1" id="toc-additional-ressources-1" class="nav-link" data-scroll-target="#additional-ressources-1"><span class="header-section-number">2.6</span> Additional ressources</a></li>
  <li><a href="#practical-implementations-of-logitboost" id="toc-practical-implementations-of-logitboost" class="nav-link" data-scroll-target="#practical-implementations-of-logitboost"><span class="header-section-number">2.7</span> Practical Implementations of LogitBoost</a>
  <ul class="collapse">
  <li><a href="#sec-logitboost_imp" id="toc-sec-logitboost_imp" class="nav-link" data-scroll-target="#sec-logitboost_imp"><span class="header-section-number">2.7.1</span> Original LogitBoost</a></li>
  <li><a href="#sec-gradboost_imp" id="toc-sec-gradboost_imp" class="nav-link" data-scroll-target="#sec-gradboost_imp"><span class="header-section-number">2.7.2</span> MART: Gradient Boosting version of LogitBoost</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise"><span class="header-section-number">2.7.3</span> Exercise</a></li>
  <li><a href="#sec-robust-logitboost_imp" id="toc-sec-robust-logitboost_imp" class="nav-link" data-scroll-target="#sec-robust-logitboost_imp"><span class="header-section-number">2.7.4</span> Ping Li Robust LogitBoost</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#sec-case-study" id="toc-sec-case-study" class="nav-link" data-scroll-target="#sec-case-study"><span class="header-section-number">3</span> Case Study</a>
  <ul class="collapse">
  <li><a href="#cart" id="toc-cart" class="nav-link" data-scroll-target="#cart"><span class="header-section-number">3.1</span> CART</a></li>
  <li><a href="#gradient-boosting" id="toc-gradient-boosting" class="nav-link" data-scroll-target="#gradient-boosting"><span class="header-section-number">3.2</span> Gradient boosting</a></li>
  </ul></li>
  <li><a href="#sec-appendix" id="toc-sec-appendix" class="nav-link" data-scroll-target="#sec-appendix"><span class="header-section-number">4</span> Appendix</a>
  <ul class="collapse">
  <li><a href="#checking-our-decision-tree-implementation-vs-scikit-learn" id="toc-checking-our-decision-tree-implementation-vs-scikit-learn" class="nav-link" data-scroll-target="#checking-our-decision-tree-implementation-vs-scikit-learn"><span class="header-section-number">4.1</span> Checking our Decision tree implementation vs scikit-learn</a></li>
  <li><a href="#checking-our-adaboost-implementation-vs-r-packages-and-scikit-learn" id="toc-checking-our-adaboost-implementation-vs-r-packages-and-scikit-learn" class="nav-link" data-scroll-target="#checking-our-adaboost-implementation-vs-r-packages-and-scikit-learn"><span class="header-section-number">4.2</span> Checking our AdaBoost implementation vs R packages and scikit-learn</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">5</span> References</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Classification trees and ensemble methods.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Classification trees and ensemble methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Louis OLIVE </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>Below we remind some theoretical and practical elements about Decision trees and Ensemble methods (here Boosting).</p>
<p>You don’t have to read everything about this material, but <a href="#sec-decision-tree">Section&nbsp;1</a> is of interest to understand how a decision tree is fitted and has been presented in class. Also the case study in <a href="#sec-case-study">Section&nbsp;3</a> shows how to “implement” Decision trees and Gradient Boosting with <code>R</code> packages <code>rpart</code> and <code>xgboost</code>.</p>
<p>In the first lessons, we have mainly used a Logistic Regression model to deal with a binary classification / scoring problem.</p>
<p>Logistic regression models may not be sufficient<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> when dealing with possible non-linearity in the input-output relationship or when there are interactions among the input variables.</p>
<p>Decision trees recursively partition the data by applying specific cutoff values to the features. This process creates various subsets of the data set, with each data point belonging to one of these subsets. The final subsets are known as Terminal or Leaf nodes, while the intermediate ones are referred to as Internal, Split or Decision nodes.</p>
<p><img src="../images/decison_tree.png" class="img-fluid"></p>
<p>In order to make predictions within each leaf node, the average outcome of the training data contained in that node is utilized.</p>
<p>Numerous algorithms exist for growing decision trees, each differing in aspects such as the potential structure of the tree, the criteria for identifying splits, when to cease the splitting process…</p>
<section id="sec-decision-tree" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Decision tree implementation: CART</h1>
<p>We describe bellow a popular method for tree-based regression and classification called CART. We follow the terminology of <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> (chapter 9.2).</p>
<p>Classification And Regression Tree (CART) (<span class="citation" data-cites="Breiman83">Breiman et al. (<a href="#ref-Breiman83" role="doc-biblioref">1983</a>)</span>), is a recursive method:</p>
<ul>
<li><p>At the root of the tree we find the entire sample.</p></li>
<li><p>Each node of the tree divides the sample into 2 branches, according to a feature variable (discrete, continuous or ordinal variable (threshold) or a nominal variable (set of categories).</p></li>
<li><p>A terminal node is called a leaf. Usually the tree is represented upside down with its root at the top</p></li>
</ul>
<p>The tree is built by the following process: first the single variable is found which best splits the data into two groups (‘best’ will be defined later). The data is separated, and then this process is applied separately to each sub-group, and so on recursively until a stopping rule occurs (either no improvement can be made or the subgroups reach a minimum size).</p>
<p>To illustrate the process we start with a Classification Tree on <span class="math inline">\(x_1,x_2\in\mathbb R^2\)</span> for the <strong>Mixture</strong> data set:</p>
<p>The 10 centers for BLUE/ORANGE classes:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulated mixture (ORANGE/BLUE) from ESLII/ISLR</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> change path</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file=</span><span class="st">'../data/mixture.example.RData'</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>x1_means <span class="ot">&lt;-</span> mixture.example<span class="sc">$</span>means[,<span class="dv">1</span>]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>x2_means <span class="ot">&lt;-</span> mixture.example<span class="sc">$</span>means[,<span class="dv">2</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>mixture_means <span class="ot">&lt;-</span> <span class="fu">tibble</span>(x1_means, x2_means) <span class="sc">%&gt;%</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowid_to_column</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(rowid <span class="sc">&lt;=</span> <span class="dv">10</span>, <span class="st">"BLUE"</span>, <span class="st">"ORANGE"</span>))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mixture_means) <span class="sc">+</span> </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1_means, <span class="at">y =</span> x2_means, <span class="at">col =</span> Y), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The 100 originals samples for each class from <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009, 12–16</a>)</span>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">=</span> mixture.example<span class="sc">$</span>y</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">=</span> mixture.example<span class="sc">$</span>x[,<span class="dv">1</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>x2 <span class="ot">=</span> mixture.example<span class="sc">$</span>x[,<span class="dv">2</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data_mixture_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(Y, x1, x2) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as_factor</span>(Y))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot raw dataset</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_mixture_example) <span class="sc">+</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">shape =</span> <span class="st">"o"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">stroke =</span> <span class="dv">2</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>250 additional samples for each class simulated using <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> recipe, we show them together with the class centers:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>new_mixture <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"../data/new_mixture.rds"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(new_mixture[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">250</span>,<span class="dv">5001</span><span class="sc">:</span><span class="dv">5251</span>),]) <span class="sc">+</span> <span class="co"># we plot only the first 250 of each class</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">shape =</span> <span class="st">"o"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">stroke =</span> <span class="dv">2</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> mixture_means, <span class="fu">aes</span>(<span class="at">x =</span> x1_means, <span class="at">y =</span> x2_means, <span class="at">col =</span>Y),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>, <span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We use the R package <code>rpart</code> (Recursive PARTitioning), an open source implementation closely following the ideas from CART (<span class="citation" data-cites="Breiman83">Breiman et al. (<a href="#ref-Breiman83" role="doc-biblioref">1983</a>)</span>). Details on the implementation are available <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">here</a>.</p>
<p>We use here the default parameters, for each node we display the class label BLUE/ORANGE (B/O), the observed probabilities/populations of classes B/O per node:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot) </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>mixture_example_CART <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>., <span class="at">data =</span> data_mixture_example, <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># rpart.plot(mixture_example_CART, digits=4)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>mixture_example_CART_plot <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">data =</span> data_mixture_example <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="st">"BLUE"</span>, <span class="st">"ORANGE"</span>)),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(mixture_example_CART_plot, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)[mixture_example_CART<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                                                       x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                                                       x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Starting from the top of the tree and going down the <code>CART/rpart</code> algorithm splits at each node according to a binary decision.</p>
<p>It ends up splitting the space into six regions, and then models the output by the mode/majority (classification) or proportion (scoring/probability) of <span class="math inline">\(Y\)</span> in each region. The result is the following:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>At each step, the input variable and splitting rule is chosen to achieve a best fit given some criterion. Then one or both of the resulting regions are split into two more regions, and this process is continued, until some stopping rule is applied.</p>
<p>For example, with the Mixture data, <code>CART/rpart</code> first splits at <span class="math inline">\(x_2=s_1=0.14\)</span>:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then, the region <span class="math inline">\(x_2 \geq s_1\)</span> is split at <span class="math inline">\(x_1 = s_2 = 2.2\)</span>:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then, the region <span class="math inline">\(x_2 \geq s_1, \mbox{ } x_1 &gt; s_2\)</span> is split at <span class="math inline">\(x_1 = s_3 = 3.1\)</span>:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And the region <span class="math inline">\(x_2 \geq s_1, \mbox{ } x_1 \leq s_2\)</span> is split at <span class="math inline">\(x_2 = s_4 = 0.98\)</span>:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally only the region <span class="math inline">\(x_2 \geq s_1, \mbox{ } x_1 \leq s_2, \mbox{ } x_2 &lt; s_4\)</span> is split at <span class="math inline">\(x_1 = s_5 = 1\)</span>.</p>
<p>The result of this process is a partition into the six regions <span class="math inline">\(R_1, R_2, . . . , R_6\)</span> shown below:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_mixture_example) <span class="sc">+</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> cutoff_1) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>r1x, <span class="at">y=</span>r1y, <span class="at">label =</span> <span class="st">"R[1]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>x1_min<span class="fl">-0.25</span>, <span class="at">y=</span>cutoff_1, <span class="at">label =</span> <span class="st">"s[1]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> cutoff_2, <span class="at">y =</span> cutoff_1, <span class="at">xend =</span> cutoff_2, <span class="at">yend =</span> x2_max)) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>cutoff_2, <span class="at">y=</span>x2_max<span class="fl">+0.2</span>, <span class="at">label =</span> <span class="st">"s[2]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> cutoff_3, <span class="at">y =</span> cutoff_1, <span class="at">xend =</span> cutoff_3, <span class="at">yend =</span> x2_max)) <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>r2x, <span class="at">y=</span>r2y, <span class="at">label =</span> <span class="st">"R[2]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>cutoff_3, <span class="at">y=</span>x2_max<span class="fl">+0.2</span>, <span class="at">label =</span> <span class="st">"s[3]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>r3x, <span class="at">y=</span>r3y, <span class="at">label =</span> <span class="st">"R[3]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1_min, <span class="at">y =</span> cutoff_4, <span class="at">xend =</span> cutoff_2, <span class="at">yend =</span> cutoff_4)) <span class="sc">+</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>x1_min<span class="fl">-0.25</span>, <span class="at">y=</span>cutoff_4, <span class="at">label =</span> <span class="st">"s[4]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>r4x, <span class="at">y=</span>r4y, <span class="at">label =</span> <span class="st">"R[4]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> cutoff_5, <span class="at">y =</span> cutoff_1, <span class="at">xend =</span> cutoff_5, <span class="at">yend =</span> cutoff_4)) <span class="sc">+</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>r5x, <span class="at">y=</span>r5y, <span class="at">label =</span> <span class="st">"R[5]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>cutoff_5, <span class="at">y=</span>x2_max<span class="fl">+0.2</span>, <span class="at">label =</span> <span class="st">"s[5]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x=</span>r6x, <span class="at">y=</span>r6y, <span class="at">label =</span> <span class="st">"R[6]"</span>, <span class="at">parse=</span><span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(x1_min, x1_max, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(x2_min, x2_max, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(x1_min, x1_max),</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(x2_min, x2_max),</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>, <span class="at">clip =</span> <span class="st">'off'</span>) <span class="sc">+</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>),</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"inches"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We now seek to understand how <code>CART/rpart</code> proceeds to grow a decision tree.</p>
<p>The data set consists of <span class="math inline">\(p\)</span> inputs or predictors and a response variable or output <span class="math inline">\(Y\)</span>, with <span class="math inline">\(n\)</span> observations: <span class="math inline">\((x_i, y_i)\)</span> for <span class="math inline">\(i = 1,\cdots,n\)</span>, and <span class="math inline">\(x_i = (x_{i1},\cdots,x_{ip})\)</span>.</p>
<p>The CART algorithm needs to automatically decide which variables to split on and which split points or threshold to use.</p>
<p>Suppose first that we have a partition into <span class="math inline">\(M\)</span> regions <span class="math inline">\(R_1, R_2, . . . , R_M\)</span>. Given a leaf node <span class="math inline">\(m\)</span> representing a region <span class="math inline">\(R_m\)</span> containing <span class="math inline">\(n_m\)</span> observations, we define for <span class="math inline">\(k \in \{0,1\}\)</span>:</p>
<p><span class="math display">\[
\hat p^m_{k}=\frac{1}{\textrm{Card}\{x_i \in R_m\}}\sum_{x_i \in R_m}\mathbb{1}_{y_i=k}
\]</span></p>
<p>the proportion of response <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span> in leaf node <span class="math inline">\(m\)</span>.</p>
<p>CART models the class of output variable as a constant in each region <span class="math inline">\(m\)</span>.</p>
<p>Let <span class="math inline">\(C_m\)</span> be the class of output variable in region <span class="math inline">\(m\)</span>, for <span class="math inline">\(k \in \{0,1\}\)</span> we estimate <span class="math inline">\(\mathbf P(C_m=k)\)</span> with <span class="math inline">\(\hat p^m_{k}\)</span>.</p>
<p>And we classify the region <span class="math inline">\(m\)</span> with <span class="math inline">\(\hat C_m = \underset{k \in \{0,1\}}{\operatorname{argmax}}\hat p^m_{k}\)</span>.</p>
<p>The CART algorithm is recursive (we will propose below a simplified implementation) so that we just have to understand how CART splits a node at any step and more precisely what criterion is used.</p>
<section id="splitting-criterion" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="splitting-criterion"><span class="header-section-number">1.1</span> Splitting criterion</h2>
<p>In order to classify well the data, CART seeks as much as possible to obtain pure leaf nodes (i.e.&nbsp;high probability for one class).</p>
<p>At each step CART selects a predictor <span class="math inline">\(X_j\)</span> and a split-point <span class="math inline">\(s\)</span> such that splitting the current region <span class="math inline">\(\mathcal R\)</span> into the regions <span class="math inline">\(\mathcal R_L(j,s)=\{X|Xj &lt; s\}\)</span> and <span class="math inline">\(\mathcal R_R(j,s)=\{X|Xj ≥ s\}\)</span> leads to the greatest possible reduction in a well chosen measure of impurity.</p>
<p>Given a leaf node <span class="math inline">\(m\)</span> representing a region <span class="math inline">\(R_m\)</span> containing <span class="math inline">\(n_m\)</span> observations we denote <span class="math inline">\(\mathcal I_m\)</span> a measure of node impurity, three measures are usually retained:</p>
<ul>
<li><p>the misclassification error: <span class="math inline">\(\mathcal I_m =\frac{1}{n_m}\sum_{x_i \in R_m}\mathbb{1}_{y_i\neq \hat C_m}= 1-\hat p^m_{\hat C_m}=1-\max(\hat p^m, 1-\hat p^m)\)</span> the fraction of observations in the region that do not belong to the most common class</p></li>
<li><p>the Gini index: <span class="math inline">\(\mathcal I_m=\sum_{k}\hat p^m_{k}(1-\hat p^m_{k})=2\hat p^m(1-\hat p^m)\)</span></p></li>
<li><p>the cross-entropy or deviance: <span class="math inline">\(\mathcal I_m=-\sum_{k} \hat p^m_{k}\log(1-\hat p^m_{k})=-\hat p^m\log(\hat p^m)- (1-\hat p^m)\log(1-\hat p^m)\)</span></p></li>
</ul>
<p>where we have denoted <span class="math inline">\(\hat p^m=\hat p^m_{1}=1-\hat p^m_{0}\)</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>imp_plot <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">by=</span><span class="fl">0.01</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>imp_gini <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span><span class="sc">*</span>p<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>p)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>imp_gini_V <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(imp_gini)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>imp_entropy <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(p<span class="sc">==</span><span class="dv">0</span> <span class="sc">|</span> p<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ent <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    ent <span class="ot">=</span> <span class="sc">-</span>p<span class="sc">*</span><span class="fu">log</span>(p) <span class="sc">-</span> (<span class="dv">1</span><span class="sc">-</span>p)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>p)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  ent</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>imp_entropy_V <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(imp_entropy)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>imp_misclass <span class="ot">&lt;-</span> <span class="cf">function</span>(p){</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">-</span><span class="fu">max</span>(p,<span class="dv">1</span><span class="sc">-</span>p)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>imp_misclass_V <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(imp_misclass)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>imp_plot <span class="ot">&lt;-</span> imp_plot  <span class="sc">%&gt;%</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gini =</span> <span class="fu">imp_gini_V</span>(x),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">entropy =</span> <span class="fu">imp_entropy_V</span>(x),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">misclass =</span> <span class="fu">imp_misclass_V</span>(x)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">!</span>x, <span class="at">names_to =</span> <span class="st">"impurity"</span>, <span class="at">values_to =</span> <span class="st">"val"</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(imp_plot, <span class="fu">aes</span>(<span class="at">x=</span>x,<span class="at">y=</span>val, <span class="at">col=</span>impurity))<span class="sc">+</span><span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We consider <span class="math inline">\(\mathcal R_L(j,s)\)</span> and <span class="math inline">\(\mathcal R_R(j,s)\)</span> two nodes/regions corresponding to a potential node/region <span class="math inline">\(\mathcal R\)</span> split. Having chosen an impurity measure CART seeks to minimize the weighted average of <span class="math inline">\(\mathcal R_L(j,s)\)</span> and <span class="math inline">\(\mathcal R_R(j,s)\)</span> impurities :</p>
<p><span class="math display">\[
n_L\mathcal I(\mathcal R_L(j,s))+n_R\mathcal I(\mathcal R_R(j,s))
\]</span></p>
<p>A justification to use Gini or Entropy instead of Misclassification is given in <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span>: first these two measures are differentiable, hence more amenable to numerical optimization, also considering the following example they favor purity within the nodes:</p>
<ul>
<li>a binary classification problem with <span class="math inline">\(400\)</span> observations per class <span class="math inline">\((400, 400)\)</span></li>
<li>first split: <span class="math inline">\((300, 100)\)</span> with <span class="math inline">\(\hat p^m_0=0.75\)</span> and <span class="math inline">\((100, 300)\)</span> with <span class="math inline">\(\hat p^m_1=0.75\)</span></li>
<li>second split: <span class="math inline">\((200, 400)\)</span> with <span class="math inline">\(\hat p^m_1=0.666\)</span> and <span class="math inline">\((200, 0)\)</span> with with <span class="math inline">\(\hat p^m_0=1\)</span></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>n_l_1 <span class="ot">&lt;-</span> <span class="dv">400</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>n_r_1 <span class="ot">&lt;-</span> <span class="dv">400</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>p_l_1 <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>p_r_1<span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>gini_1 <span class="ot">&lt;-</span> (n_l_1 <span class="sc">*</span> <span class="fu">imp_gini</span>(p_l_1) <span class="sc">+</span> n_r_1 <span class="sc">*</span> <span class="fu">imp_gini</span>(p_r_1)) <span class="sc">/</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>          (n_l_1  <span class="sc">+</span> n_r_1 )</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>entropy_1 <span class="ot">&lt;-</span> (n_l_1 <span class="sc">*</span> <span class="fu">imp_entropy</span>(p_l_1) <span class="sc">+</span> n_r_1 <span class="sc">*</span> <span class="fu">imp_entropy</span>(p_r_1)) <span class="sc">/</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>          (n_l_1  <span class="sc">+</span> n_r_1 )</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>misclass_1 <span class="ot">&lt;-</span> (n_l_1 <span class="sc">*</span> <span class="fu">imp_misclass</span>(p_l_1) <span class="sc">+</span> n_r_1 <span class="sc">*</span> <span class="fu">imp_misclass</span>(p_r_1)) <span class="sc">/</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>          (n_l_1  <span class="sc">+</span> n_r_1 )</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>n_l_2 <span class="ot">&lt;-</span> <span class="dv">600</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>n_r_2 <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>p_l_2 <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">/</span><span class="dv">3</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>p_r_2 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>gini_2 <span class="ot">&lt;-</span> (n_l_2 <span class="sc">*</span> <span class="fu">imp_gini</span>(p_l_2) <span class="sc">+</span> n_r_2 <span class="sc">*</span> <span class="fu">imp_gini</span>(p_r_2)) <span class="sc">/</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>          (n_l_2  <span class="sc">+</span> n_r_2 )</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>entropy_2 <span class="ot">&lt;-</span> (n_l_2 <span class="sc">*</span> <span class="fu">imp_entropy</span>(p_l_2) <span class="sc">+</span> n_r_2 <span class="sc">*</span> <span class="fu">imp_entropy</span>(p_r_2)) <span class="sc">/</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>             (n_l_2  <span class="sc">+</span> n_r_2 )</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>misclass_2 <span class="ot">&lt;-</span> (n_l_2 <span class="sc">*</span> <span class="fu">imp_misclass</span>(p_l_2) <span class="sc">+</span> n_r_2 <span class="sc">*</span> <span class="fu">imp_misclass</span>(p_r_2)) <span class="sc">/</span> </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>             (n_l_2  <span class="sc">+</span> n_r_2 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We now look at the weighted average impurities for each split:</p>
<ul>
<li>first split : Gini: 0.38 / Entropy: 0.56 / Misclassification: 0.25</li>
<li>second split : Gini: 0.33 / Entropy: 0.48 / Misclassification: 0.25</li>
</ul>
<p>Both splits share a Misclassification rate of <span class="math inline">\(0.25\)</span> while Gini and Entropy are decreasing for second split. Intuitively, these two measures will favor purer node than Misclassification and are usually preferred in decision tree algorithms.</p>
</section>
<section id="tree-building-process" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="tree-building-process"><span class="header-section-number">1.2</span> Tree-building process</h2>
<p>Having chosen a criterion, the CART algorithm uses a top-down, greedy approach that is known as recursive binary splitting:</p>
<ul>
<li><p>top-down: begins at the top of the tree and then recursively splits the input space; each split produces two new branches further down on the tree.</p></li>
<li><p>greedy: at each step of the building process, the best split is made without looking ahead and trying to pick a split that will lead to a better tree in some future step.</p></li>
</ul>
<p><strong>Categorical predictors</strong></p>
<p>Assuming we have a categorical feature with <span class="math inline">\(p\)</span> possible values. We seek the best split into two groups, there is <span class="math inline">\(2^{p-1}-1\)</span> possible splits, which can be prohibitive for large <span class="math inline">\(p\)</span>.</p>
<p>A trick usually implemented, working only for binary classification, is to transform categorical predictors. Usually the proportion of class <span class="math inline">\(1\)</span> for each category is computed, and the algorithm splits on this numerical/ordinal column only needing <span class="math inline">\(p\)</span> splits. This trick and its proof are available in <span class="citation" data-cites="Breiman83">Breiman et al. (<a href="#ref-Breiman83" role="doc-biblioref">1983</a>)</span>.</p>
<p>In <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> it is noted that categorical predictors with many levels usually lead to severe overfitting in the context of decision trees, so that such variables might have to be transformed (by regrouping categories) or avoided.</p>
<p><strong>Implementation for quantitative predictors</strong></p>
<p>We implement below a simple (only working with quantitative variables), naive (not optimized with virtually no exception handling) and unsafe recursive method reproducing roughly the <code>CART/rpart</code> algorithm.</p>
<p>First we define helper functions for the impurity measures:</p>
<p>Entropy:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>entropy <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, y, <span class="at">verbose =</span> <span class="cn">FALSE</span>){</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assumes y is a factor</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> tbl <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!!</span>y) <span class="sc">%&gt;%</span> <span class="fu">table</span>()<span class="sc">/</span><span class="fu">nrow</span>(tbl)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose) {<span class="fu">print</span>(p)}</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="sc">-</span>p<span class="sc">*</span><span class="fu">log2</span>(p<span class="fl">+1e-9</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>and Gini:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gini <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, y, <span class="at">verbose =</span> <span class="cn">FALSE</span>){</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assumes y if a factor</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(tbl) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># computes the proportion of class 0-1 per node</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   Y</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  0   1 </span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  1-p% p% </span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> tbl <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!!</span>y) <span class="sc">%&gt;%</span> <span class="fu">table</span>()<span class="sc">/</span><span class="fu">nrow</span>(tbl)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose) {<span class="fu">print</span>(p)}</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(p<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>p))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we define a function returning for a given choice of continuous variable and split value, the impurity of the two children nodes and their weighted average impurity:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>impurity_decrease <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl_node, y_name, x_name,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                              split_value, <span class="at">impurity =</span> gini, <span class="at">min_leaf =</span> <span class="dv">5</span>){</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Whenever any of left/right child node contains less than min_leaf</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># observations we return a default value for impurity</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># excluding de facto the split to be taken into account</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    ret_default <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"impurity_left"</span><span class="ot">=</span><span class="dv">666</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_right"</span><span class="ot">=</span><span class="dv">666</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_total"</span><span class="ot">=</span><span class="dv">666</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    tbl_left <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name <span class="sc">&lt;</span> <span class="sc">!!</span>split_value)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    n_left <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tbl_left)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_left <span class="sc">&lt;</span> min_leaf){<span class="fu">return</span>(ret_default)} </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    impurity_left <span class="ot">&lt;-</span> <span class="fu">impurity</span>(tbl_left, y_name)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    tbl_right <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name <span class="sc">&gt;=!!</span>split_value)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    n_right <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tbl_right)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_right <span class="sc">&lt;</span> min_leaf){<span class="fu">return</span>(ret_default)}</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    impurity_right <span class="ot">&lt;-</span> <span class="fu">impurity</span>(tbl_right, y_name)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"impurity_left"</span><span class="ot">=</span>impurity_left,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_right"</span><span class="ot">=</span>impurity_right,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_total"</span><span class="ot">=</span>n_left<span class="sc">/</span>(n_left<span class="sc">+</span>n_right)<span class="sc">*</span>impurity_left <span class="sc">+</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>                                 n_right<span class="sc">/</span>(n_left<span class="sc">+</span>n_right)<span class="sc">*</span>impurity_right))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Using this <code>impurity_decrease</code> function and given a node, the following <code>max_impurity_decrease</code> function computes for each variable <span class="math inline">\(j\)</span> and split value <span class="math inline">\(s\)</span> the impurity decrease, ultimately seeking the best split in terms of weighted average impurity:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>max_impurity_decrease <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl_node, y_name, x_names,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">impurity =</span> gini, <span class="at">min_leaf =</span> <span class="dv">5</span>, <span class="at">midpoint =</span> <span class="cn">FALSE</span>){</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    imp_node <span class="ot">=</span> <span class="fu">impurity</span>(tbl_node, y_name)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    list_all_x <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    tbl_res <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">feature_split =</span> <span class="st">"zzz"</span>, <span class="at">split_rule =</span> <span class="sc">-</span><span class="dv">666</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">imp_left =</span> <span class="dv">666</span>, <span class="at">imp_right =</span> <span class="dv">666</span>, <span class="at">imp_total =</span> <span class="dv">666</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (x_name <span class="cf">in</span> x_names){</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        list_x <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>       <span class="co"># print(x_name)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        splits <span class="ot">&lt;-</span> <span class="fu">unique</span>(tbl_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(x_name))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># modify the algorithm to split on 'midpoint' value for continuous variable</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (some decision trees do (CART) other don't (C4.5))</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(midpoint){</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            splits <span class="ot">&lt;-</span> <span class="fu">sort</span>(splits)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            splits <span class="ot">&lt;-</span> splits[<span class="sc">-</span><span class="fu">length</span>(splits)] <span class="sc">+</span> <span class="fu">diff</span>(splits)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (split <span class="cf">in</span> splits){</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(split)</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            imp_dec <span class="ot">&lt;-</span> <span class="fu">impurity_decrease</span>(tbl_node, y_name, x_name,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                                         split, impurity, min_leaf)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># list_x[[j]] &lt;- c(split, imp_dec)</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            tbl_res <span class="ot">&lt;-</span>  <span class="fu">bind_rows</span>(tbl_res,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">tibble</span>(<span class="at">feature_split =</span> <span class="fu">as.character</span>(x_name),</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">split_rule =</span> split,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">imp_node =</span> imp_node,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">imp_left =</span> imp_dec[[<span class="st">"impurity_left"</span>]],</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">imp_right =</span> imp_dec[[<span class="st">"impurity_right"</span>]],</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">imp_total =</span> imp_dec[[<span class="st">"impurity_total"</span>]]))</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        }   </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(tbl_res)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We test this function with the mixture data set, starting at the root node using Gini impurity measure:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tbl_node <span class="ot">&lt;-</span> data_mixture_example</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>y_name <span class="ot">&lt;-</span> <span class="fu">as.name</span>(<span class="st">"Y"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>x_names <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"x1"</span>), <span class="fu">as.name</span>(<span class="st">"x2"</span>))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">max_impurity_decrease</span>(tbl_node, y_name, x_names)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>(test <span class="ot">&lt;-</span>test <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(feature_split<span class="sc">!=</span><span class="st">"zzz"</span>, imp_total <span class="sc">!=</span> <span class="dv">666</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(imp_total))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["feature_split"],"name":[1],"type":["chr"],"align":["left"]},{"label":["split_rule"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["imp_left"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["imp_right"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["imp_total"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["imp_node"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"x2","2":"0.150864353","3":"0.14201183","4":"0.4558072","5":"0.3742204","6":"0.5"},{"1":"x2","2":"0.551403559","3":"0.30764301","4":"0.4180042","5":"0.3744115","6":"0.5"},{"1":"x2","2":"0.137389748","3":"0.14455978","4":"0.4583577","5":"0.3783393","6":"0.5"},{"1":"x2","2":"0.544177695","3":"0.31065089","4":"0.4226015","5":"0.3789407","6":"0.5"},{"1":"x2","2":"0.556946627","3":"0.32000000","4":"0.4200000","5":"0.3800000","6":"0.5"},{"1":"x2","2":"0.165052639","3":"0.17087932","4":"0.4572169","5":"0.3813374","6":"0.5"},{"1":"x2","2":"0.102975324","3":"0.14720000","4":"0.4608000","5":"0.3824000","6":"0.5"},{"1":"x2","2":"0.525151558","3":"0.31371226","4":"0.4269945","5":"0.3833808","6":"0.5"},{"1":"x2","2":"0.404037972","3":"0.28408163","4":"0.4373964","5":"0.3837363","6":"0.5"},{"1":"x2","2":"0.936223312","3":"0.40123457","4":"0.3638941","5":"0.3840580","6":"0.5"},{"1":"x2","2":"0.186156137","3":"0.19438017","4":"0.4560285","5":"0.3840752","6":"0.5"},{"1":"x2","2":"0.918180475","3":"0.39747241","4":"0.3696243","5":"0.3843838","6":"0.5"},{"1":"x2","2":"0.470747125","3":"0.29591049","4":"0.4354248","5":"0.3851997","6":"0.5"},{"1":"x2","2":"0.585843888","3":"0.33165676","4":"0.4220041","5":"0.3854134","6":"0.5"},{"1":"x2","2":"0.361734172","3":"0.27444865","4":"0.4427610","5":"0.3863764","6":"0.5"},{"1":"x2","2":"0.073293605","3":"0.14993753","4":"0.4631376","5":"0.3864036","6":"0.5"},{"1":"x2","2":"0.215211634","3":"0.21545091","4":"0.4547900","5":"0.3865783","6":"0.5"},{"1":"x2","2":"0.505121685","3":"0.31682825","4":"0.4311915","5":"0.3877334","6":"0.5"},{"1":"x2","2":"0.379000419","3":"0.28733459","4":"0.4409999","5":"0.3879854","6":"0.5"},{"1":"x2","2":"0.184898617","3":"0.19753086","4":"0.4586226","5":"0.3881279","6":"0.5"},{"1":"x2","2":"0.725799603","3":"0.36056054","4":"0.4103563","5":"0.3881972","6":"0.5"},{"1":"x2","2":"0.959990564","3":"0.40703644","4":"0.3666224","5":"0.3886480","6":"0.5"},{"1":"x2","2":"0.742267953","3":"0.36662239","4":"0.4070364","5":"0.3886480","6":"0.5"},{"1":"x2","2":"0.919702238","3":"0.40352869","4":"0.3722974","5":"0.3890061","6":"0.5"},{"1":"x2","2":"0.910978474","3":"0.39981859","4":"0.3776177","5":"0.3892732","6":"0.5"},{"1":"x2","2":"0.413648012","3":"0.29914699","4":"0.4391563","5":"0.3894530","6":"0.5"},{"1":"x2","2":"0.070452553","3":"0.15277778","4":"0.4653740","5":"0.3903509","6":"0.5"},{"1":"x2","2":"0.358477769","3":"0.27777778","4":"0.4460904","5":"0.3905473","6":"0.5"},{"1":"x2","2":"0.207323551","3":"0.21875000","4":"0.4574653","5":"0.3906250","6":"0.5"},{"1":"x2","2":"0.649705578","3":"0.34265318","4":"0.4240161","5":"0.3906573","6":"0.5"},{"1":"x2","2":"0.481080499","3":"0.31000188","4":"0.4372249","5":"0.3907885","6":"0.5"},{"1":"x2","2":"0.490536018","3":"0.32000000","4":"0.4352000","5":"0.3920000","6":"0.5"},{"1":"x2","2":"0.362826378","3":"0.29065744","4":"0.4444444","5":"0.3921569","6":"0.5"},{"1":"x2","2":"0.717486166","3":"0.36337810","4":"0.4156569","5":"0.3926542","6":"0.5"},{"1":"x2","2":"0.979110495","3":"0.41565689","4":"0.3633781","5":"0.3926542","6":"0.5"},{"1":"x2","2":"0.240936940","3":"0.23781213","4":"0.4562587","5":"0.3929092","6":"0.5"},{"1":"x2","2":"0.738892516","3":"0.36938272","4":"0.4125620","5":"0.3931313","6":"0.5"},{"1":"x2","2":"0.961948009","3":"0.41256198","4":"0.3693827","5":"0.3931313","6":"0.5"},{"1":"x2","2":"0.771731486","3":"0.37500000","4":"0.4092936","5":"0.3935185","6":"0.5"},{"1":"x2","2":"0.801422708","3":"0.38026256","4":"0.4058384","5":"0.3938177","6":"0.5"},{"1":"x2","2":"0.901675787","3":"0.40218195","4":"0.3851997","5":"0.3940304","6":"0.5"},{"1":"x2","2":"0.031462099","3":"0.15572657","4":"0.4675125","5":"0.3942428","6":"0.5"},{"1":"x2","2":"0.347995798","3":"0.28118343","4":"0.4492730","5":"0.3946439","6":"0.5"},{"1":"x2","2":"0.020693004","3":"0.12706612","4":"0.4703320","5":"0.3948135","6":"0.5"},{"1":"x2","2":"0.654564443","3":"0.35302656","4":"0.4260355","5":"0.3957368","6":"0.5"},{"1":"x2","2":"0.484102460","3":"0.32322863","4":"0.4390275","5":"0.3961819","6":"0.5"},{"1":"x2","2":"1.026506205","3":"0.42344045","4":"0.3598616","5":"0.3964194","6":"0.5"},{"1":"x2","2":"0.705004818","3":"0.36623068","4":"0.4207064","5":"0.3970095","6":"0.5"},{"1":"x2","2":"0.992199616","3":"0.42070640","4":"0.3662307","5":"0.3970095","6":"0.5"},{"1":"x2","2":"0.973755498","3":"0.41782323","4":"0.3721752","5":"0.3975099","6":"0.5"},{"1":"x2","2":"0.025438551","3":"0.15879017","4":"0.4695564","5":"0.3980802","6":"0.5"},{"1":"x2","2":"0.777194034","3":"0.38293444","4":"0.4115643","5":"0.3982514","6":"0.5"},{"1":"x2","2":"0.809050152","3":"0.38781163","4":"0.4081633","5":"0.3984962","6":"0.5"},{"1":"x2","2":"0.017201649","3":"0.12979989","4":"0.4722301","5":"0.3986076","6":"0.5"},{"1":"x2","2":"0.886232609","3":"0.40456216","4":"0.3923903","5":"0.3986588","6":"0.5"},{"1":"x2","2":"0.326034294","3":"0.28466797","4":"0.4523140","5":"0.3986673","6":"0.5"},{"1":"x2","2":"0.272584762","3":"0.25854639","4":"0.4577235","5":"0.3989662","6":"0.5"},{"1":"x2","2":"1.038922700","3":"0.42806183","4":"0.3628118","5":"0.4006568","6":"0.5"},{"1":"x2","2":"0.665912397","3":"0.36281179","4":"0.4280618","5":"0.4006568","6":"0.5"},{"1":"x2","2":"0.306475077","3":"0.27411986","4":"0.4564981","5":"0.4008727","6":"0.5"},{"1":"x2","2":"1.008993039","3":"0.42551554","4":"0.3691184","5":"0.4012648","6":"0.5"},{"1":"x2","2":"0.693601574","3":"0.36911844","4":"0.4255155","5":"0.4012648","6":"0.5"},{"1":"x2","2":"0.022464061","3":"0.16197531","4":"0.4715088","5":"0.4018638","6":"0.5"},{"1":"x2","2":"0.009673168","3":"0.13265306","4":"0.4740426","5":"0.4023508","6":"0.5"},{"1":"x2","2":"0.323311979","3":"0.28823381","4":"0.4552187","5":"0.4026185","6":"0.5"},{"1":"x2","2":"0.812967619","3":"0.39496528","4":"0.4105030","5":"0.4030449","6":"0.5"},{"1":"x2","2":"0.883552173","3":"0.40695886","4":"0.3992087","5":"0.4031613","6":"0.5"},{"1":"x2","2":"0.287959243","3":"0.27777778","4":"0.4591837","5":"0.4047619","6":"0.5"},{"1":"x2","2":"1.039167443","3":"0.43246402","4":"0.3658006","5":"0.4047987","6":"0.5"},{"1":"x2","2":"0.672350664","3":"0.37204152","4":"0.4300945","5":"0.4054220","6":"0.5"},{"1":"x2","2":"-0.029746130","3":"0.13563355","4":"0.4757723","5":"0.4060439","6":"0.5"},{"1":"x2","2":"0.321050446","3":"0.29188345","4":"0.4579920","5":"0.4064984","6":"0.5"},{"1":"x2","2":"0.813721723","3":"0.40174301","4":"0.4128570","5":"0.4074667","6":"0.5"},{"1":"x2","2":"0.876644795","3":"0.40937163","4":"0.4056729","5":"0.4075408","6":"0.5"},{"1":"x2","2":"-0.330735232","3":"0.00000000","4":"0.4831764","5":"0.4082840","6":"0.5"},{"1":"x2","2":"1.039996187","3":"0.43665613","4":"0.3688281","5":"0.4088466","6":"0.5"},{"1":"x2","2":"-0.064545302","3":"0.13875000","4":"0.4774219","5":"0.4096875","6":"0.5"},{"1":"x2","2":"-0.357915928","3":"0.00000000","4":"0.4844291","5":"0.4117647","6":"0.5"},{"1":"x2","2":"0.852322687","3":"0.40816327","4":"0.4152249","5":"0.4117647","6":"0.5"},{"1":"x2","2":"0.867253738","3":"0.41180000","4":"0.4118000","5":"0.4118000","6":"0.5"},{"1":"x2","2":"1.052235708","3":"0.44064685","4":"0.3718945","5":"0.4128022","6":"0.5"},{"1":"x2","2":"-0.294440957","3":"0.05876951","4":"0.4827710","5":"0.4128107","6":"0.5"},{"1":"x2","2":"-0.166103051","3":"0.10493827","4":"0.4809637","5":"0.4132791","6":"0.5"},{"1":"x2","2":"-0.085187569","3":"0.14201183","4":"0.4789939","5":"0.4132824","6":"0.5"},{"1":"x2","2":"-0.418277898","3":"0.00000000","4":"0.4856195","5":"0.4152047","6":"0.5"},{"1":"x2","2":"1.170055270","3":"0.45568440","4":"0.3402647","5":"0.4158646","6":"0.5"},{"1":"x2","2":"1.085183909","3":"0.44625101","4":"0.3685076","5":"0.4159311","6":"0.5"},{"1":"x2","2":"0.855519879","3":"0.41424344","4":"0.4176061","5":"0.4159416","6":"0.5"},{"1":"x2","2":"-0.309811219","3":"0.06054688","4":"0.4840561","5":"0.4162946","6":"0.5"},{"1":"x2","2":"1.058147178","3":"0.44444444","4":"0.3750000","5":"0.4166667","6":"0.5"},{"1":"x2","2":"-0.271033290","3":"0.10775510","4":"0.4823508","5":"0.4167965","6":"0.5"},{"1":"x2","2":"-0.109150387","3":"0.14542936","4":"0.4804908","5":"0.4168291","6":"0.5"},{"1":"x2","2":"1.165593851","3":"0.45429962","4":"0.3491371","5":"0.4169669","6":"0.5"},{"1":"x2","2":"-0.454657409","3":"0.00000000","4":"0.4867496","5":"0.4186047","6":"0.5"},{"1":"x2","2":"1.174771281","3":"0.45856290","4":"0.3438581","5":"0.4195633","6":"0.5"},{"1":"x2","2":"1.090314031","3":"0.44973230","4":"0.3717322","5":"0.4197022","6":"0.5"},{"1":"x2","2":"-0.283878559","3":"0.11072664","4":"0.4836696","5":"0.4202693","6":"0.5"},{"1":"x2","2":"-0.165204649","3":"0.14901388","4":"0.4819150","5":"0.4203283","6":"0.5"},{"1":"x2","2":"1.079833767","3":"0.44805683","4":"0.3781445","5":"0.4204415","6":"0.5"},{"1":"x2","2":"1.167759713","3":"0.45727811","4":"0.3526531","5":"0.4206593","6":"0.5"},{"1":"x2","2":"1.154179996","3":"0.45593262","4":"0.3607253","5":"0.4216580","6":"0.5"},{"1":"x2","2":"-0.455959142","3":"0.00000000","4":"0.4878212","5":"0.4219653","6":"0.5"},{"1":"x2","2":"1.223981852","3":"0.46244170","4":"0.3379882","5":"0.4219943","6":"0.5"},{"1":"x2","2":"1.135668449","3":"0.45452255","4":"0.3681519","5":"0.4225654","6":"0.5"},{"1":"x2","2":"1.201221704","3":"0.46130364","4":"0.3475162","5":"0.4231848","6":"0.5"},{"1":"x2","2":"1.103914441","3":"0.45304370","4":"0.3750000","5":"0.4233871","6":"0.5"},{"1":"x2","2":"-0.479446546","3":"0.00000000","4":"0.4888360","5":"0.4252874","6":"0.5"},{"1":"x2","2":"1.242869428","3":"0.46496540","4":"0.3417969","5":"0.4255515","6":"0.5"},{"1":"x2","2":"1.148315275","3":"0.45756092","4":"0.3715519","5":"0.4261676","6":"0.5"},{"1":"x2","2":"1.216216381","3":"0.46391178","4":"0.3512397","5":"0.4267300","6":"0.5"},{"1":"x2","2":"1.107883553","3":"0.45619200","4":"0.3783111","5":"0.4269867","6":"0.5"},{"1":"x2","2":"-0.481920759","3":"0.00000000","4":"0.4897959","5":"0.4285714","6":"0.5"},{"1":"x2","2":"1.250357925","3":"0.46736640","4":"0.3456790","5":"0.4290349","6":"0.5"},{"1":"x2","2":"1.283185943","3":"0.47133505","4":"0.3281807","5":"0.4298203","6":"0.5"},{"1":"x2","2":"1.384068805","3":"0.47410226","4":"0.3200000","5":"0.4317241","6":"0.5"},{"1":"x2","2":"-0.530621080","3":"0.00000000","4":"0.4907025","5":"0.4318182","6":"0.5"},{"1":"x2","2":"1.250970789","3":"0.46964923","4":"0.3496358","5":"0.4324451","6":"0.5"},{"1":"x2","2":"1.357381623","3":"0.47337278","4":"0.3324100","5":"0.4331984","6":"0.5"},{"1":"x2","2":"1.276901247","3":"0.47261204","4":"0.3435794","5":"0.4345474","6":"0.5"},{"1":"x2","2":"-0.551650278","3":"0.00000000","4":"0.4915573","5":"0.4350282","6":"0.5"},{"1":"x2","2":"1.384600180","3":"0.47598048","4":"0.3244170","5":"0.4350583","6":"0.5"},{"1":"x2","2":"1.460543433","3":"0.47892636","4":"0.2998751","5":"0.4350588","6":"0.5"},{"1":"x2","2":"1.261365481","3":"0.47181823","4":"0.3536684","5":"0.4357825","6":"0.5"},{"1":"x2","2":"1.358509888","3":"0.47530864","4":"0.3367347","5":"0.4365079","6":"0.5"},{"1":"x2","2":"1.427912819","3":"0.47835683","4":"0.3152634","5":"0.4367680","6":"0.5"},{"1":"x2","2":"-0.733347412","3":"0.00000000","4":"0.4923621","5":"0.4382022","6":"0.5"},{"1":"x2","2":"1.489829603","3":"0.48052285","4":"0.3046875","5":"0.4383224","6":"0.5"},{"1":"x2","2":"1.398988842","3":"0.47776389","4":"0.3289427","5":"0.4383263","6":"0.5"},{"1":"x2","2":"1.273747315","3":"0.47387755","4":"0.3577778","5":"0.4390476","6":"0.5"},{"1":"x2","2":"1.457361044","3":"0.48000000","4":"0.3200000","5":"0.4400000","6":"0.5"},{"1":"x2","2":"-0.737176464","3":"0.00000000","4":"0.4931182","5":"0.4413408","6":"0.5"},{"1":"x2","2":"1.491832426","3":"0.48203682","4":"0.3096424","5":"0.4415241","6":"0.5"},{"1":"x2","2":"1.418180412","3":"0.47945581","4":"0.3335799","5":"0.4415281","6":"0.5"},{"1":"x2","2":"1.633062578","3":"0.48593804","4":"0.2603550","5":"0.4419494","6":"0.5"},{"1":"x2","2":"-0.742851486","3":"0.00000000","4":"0.4938272","5":"0.4444444","6":"0.5"},{"1":"x2","2":"1.545476693","3":"0.48347107","4":"0.3147448","5":"0.4446640","6":"0.5"},{"1":"x2","2":"1.647575574","3":"0.48712087","4":"0.2659280","5":"0.4450942","6":"0.5"},{"1":"x2","2":"1.625783044","3":"0.48679688","4":"0.2887500","5":"0.4471875","6":"0.5"},{"1":"x2","2":"-0.744933603","3":"0.00000000","4":"0.4944904","5":"0.4475138","6":"0.5"},{"1":"x2","2":"1.550985579","3":"0.48482830","4":"0.3200000","5":"0.4477419","6":"0.5"},{"1":"x2","2":"1.704139810","3":"0.48823817","4":"0.2717312","5":"0.4481844","6":"0.5"},{"1":"x2","2":"2.015033249","3":"0.49280000","4":"0.1472000","5":"0.4496000","6":"0.5"},{"1":"x2","2":"-0.761847144","3":"0.00000000","4":"0.4951093","5":"0.4505495","6":"0.5"},{"1":"x2","2":"1.565475021","3":"0.48611111","4":"0.3254132","5":"0.4507576","6":"0.5"},{"1":"x2","2":"1.714859663","3":"0.48929209","4":"0.2777778","5":"0.4512195","6":"0.5"},{"1":"x2","2":"1.608536949","3":"0.48763894","4":"0.3140988","5":"0.4520632","6":"0.5"},{"1":"x2","2":"2.041098516","3":"0.49354339","4":"0.1527778","5":"0.4526515","6":"0.5"},{"1":"x2","2":"2.002274242","3":"0.49263256","4":"0.1975309","5":"0.4527938","6":"0.5"},{"1":"x1","2":"-0.912620059","3":"0.00000000","4":"0.4956852","5":"0.4535519","6":"0.5"},{"1":"x2","2":"-0.787134923","3":"0.00000000","4":"0.4956852","5":"0.4535519","6":"0.5"},{"1":"x2","2":"1.577942178","3":"0.48732200","4":"0.3309897","5":"0.4537106","6":"0.5"},{"1":"x2","2":"1.718885398","3":"0.49028466","4":"0.2840816","5":"0.4541991","6":"0.5"},{"1":"x2","2":"2.052686203","3":"0.49423856","4":"0.1587902","5":"0.4556620","6":"0.5"},{"1":"x2","2":"2.007981737","3":"0.49339411","4":"0.2041420","5":"0.4557913","6":"0.5"},{"1":"x1","2":"-1.021784128","3":"0.00000000","4":"0.4962193","5":"0.4565217","6":"0.5"},{"1":"x2","2":"-0.830414760","3":"0.00000000","4":"0.4962193","5":"0.4565217","6":"0.5"},{"1":"x2","2":"1.580805445","3":"0.48846339","4":"0.3367347","5":"0.4566004","6":"0.5"},{"1":"x2","2":"1.735423774","3":"0.49121788","4":"0.2906574","5":"0.4571226","6":"0.5"},{"1":"x2","2":"1.930257493","3":"0.49323959","4":"0.2448980","5":"0.4584718","6":"0.5"},{"1":"x2","2":"2.075904398","3":"0.49488701","4":"0.1652893","5":"0.4586313","6":"0.5"},{"1":"x1","2":"-1.136539074","3":"0.00000000","4":"0.4967129","5":"0.4594595","6":"0.5"},{"1":"x2","2":"-0.901759351","3":"0.00000000","4":"0.4967129","5":"0.4594595","6":"0.5"},{"1":"x2","2":"1.757231990","3":"0.49209366","4":"0.2975207","5":"0.4599891","6":"0.5"},{"1":"x1","2":"-0.840369051","3":"0.10493827","4":"0.4961357","5":"0.4609280","6":"0.5"},{"1":"x2","2":"2.108804862","3":"0.49549015","4":"0.1723356","5":"0.4615589","6":"0.5"},{"1":"x1","2":"-0.109159157","3":"0.36938272","4":"0.4889906","5":"0.4620789","6":"0.5"},{"1":"x1","2":"-1.162763070","3":"0.00000000","4":"0.4971673","5":"0.4623656","6":"0.5"},{"1":"x2","2":"-0.903565594","3":"0.00000000","4":"0.4971673","5":"0.4623656","6":"0.5"},{"1":"x2","2":"1.805299380","3":"0.49291383","4":"0.3046875","5":"0.4627976","6":"0.5"},{"1":"x1","2":"-0.191272364","3":"0.36281179","4":"0.4903060","5":"0.4635322","6":"0.5"},{"1":"x2","2":"1.881741308","3":"0.49382716","4":"0.2853746","5":"0.4636015","6":"0.5"},{"1":"x1","2":"-0.727077155","3":"0.18000000","4":"0.4960494","5":"0.4644444","6":"0.5"},{"1":"x2","2":"2.125607235","3":"0.49604938","4":"0.1800000","5":"0.4644444","6":"0.5"},{"1":"x1","2":"-0.313007477","3":"0.32698962","4":"0.4927421","5":"0.4645641","6":"0.5"},{"1":"x1","2":"2.071415038","3":"0.49274205","4":"0.3269896","5":"0.4645641","6":"0.5"},{"1":"x1","2":"-0.152822409","3":"0.37500000","4":"0.4900559","5":"0.4647436","6":"0.5"},{"1":"x1","2":"-1.169258605","3":"0.00000000","4":"0.4975836","5":"0.4652406","6":"0.5"},{"1":"x2","2":"-0.919790286","3":"0.00000000","4":"0.4975836","5":"0.4652406","6":"0.5"},{"1":"x2","2":"1.860080951","3":"0.49368019","4":"0.3121748","5":"0.4655469","6":"0.5"},{"1":"x1","2":"0.066332192","3":"0.42000000","4":"0.4853061","5":"0.4657143","6":"0.5"},{"1":"x1","2":"1.640157488","3":"0.48979592","4":"0.3856333","5":"0.4658385","6":"0.5"},{"1":"x1","2":"-0.079583353","3":"0.38563327","4":"0.4897959","5":"0.4658385","6":"0.5"},{"1":"x1","2":"-0.302274664","3":"0.34567901","4":"0.4925640","5":"0.4661247","6":"0.5"},{"1":"x1","2":"-0.196246334","3":"0.36882808","4":"0.4912780","5":"0.4661758","6":"0.5"},{"1":"x1","2":"2.125104790","3":"0.49352791","4":"0.3342516","5":"0.4672473","6":"0.5"},{"1":"x1","2":"-0.368775793","3":"0.33425161","4":"0.4935279","5":"0.4672473","6":"0.5"},{"1":"x1","2":"-0.804293855","3":"0.18836565","4":"0.4965660","5":"0.4672870","6":"0.5"},{"1":"x2","2":"2.142041681","3":"0.49656604","4":"0.1883657","5":"0.4672870","6":"0.5"},{"1":"x1","2":"-0.167523862","3":"0.38074635","4":"0.4910544","5":"0.4673382","6":"0.5"},{"1":"x1","2":"0.033318463","3":"0.41859034","4":"0.4870654","5":"0.4675500","6":"0.5"},{"1":"x1","2":"-1.256441709","3":"0.00000000","4":"0.4979629","5":"0.4680851","6":"0.5"},{"1":"x2","2":"-1.014726822","3":"0.00000000","4":"0.4979629","5":"0.4680851","6":"0.5"},{"1":"x1","2":"0.061145537","3":"0.42401609","4":"0.4866958","5":"0.4682053","6":"0.5"},{"1":"x2","2":"1.877590719","3":"0.49439446","4":"0.3200000","5":"0.4682353","6":"0.5"},{"1":"x1","2":"1.642844649","3":"0.49082206","4":"0.3911111","5":"0.4683871","6":"0.5"},{"1":"x1","2":"-0.311647982","3":"0.35265306","4":"0.4933701","5":"0.4687446","6":"0.5"},{"1":"x1","2":"1.945429440","3":"0.49337006","4":"0.3526531","5":"0.4687446","6":"0.5"},{"1":"x1","2":"-0.200683161","3":"0.37500000","4":"0.4921875","5":"0.4687500","6":"0.5"},{"1":"x1","2":"0.087614787","3":"0.42891696","4":"0.4863102","5":"0.4688053","6":"0.5"},{"1":"x1","2":"-0.077114461","3":"0.40018108","4":"0.4905805","5":"0.4693367","6":"0.5"},{"1":"x1","2":"1.623801765","3":"0.49058055","4":"0.4001811","5":"0.4693367","6":"0.5"},{"1":"x1","2":"0.129985619","3":"0.43335853","4":"0.4859076","5":"0.4693547","6":"0.5"},{"1":"x1","2":"2.126868516","3":"0.49426020","4":"0.3417969","5":"0.4698661","6":"0.5"},{"1":"x1","2":"-0.369493348","3":"0.34179688","4":"0.4942602","5":"0.4698661","6":"0.5"},{"1":"x1","2":"0.013973130","3":"0.42283163","4":"0.4883295","5":"0.4699901","6":"0.5"},{"1":"x1","2":"-0.295362353","3":"0.36815194","4":"0.4932064","5":"0.4700713","6":"0.5"},{"1":"x1","2":"-0.715283835","3":"0.24489796","4":"0.4964889","5":"0.4700718","6":"0.5"},{"1":"x2","2":"2.181549767","3":"0.49704142","4":"0.1975309","5":"0.4700855","6":"0.5"},{"1":"x1","2":"0.056184431","3":"0.42806183","4":"0.4879984","5":"0.4706168","6":"0.5"},{"1":"x1","2":"2.262714148","3":"0.49505831","4":"0.3281807","5":"0.4708611","6":"0.5"},{"1":"x1","2":"1.715233331","3":"0.49178172","4":"0.3966942","5":"0.4708625","6":"0.5"},{"1":"x1","2":"-1.264860817","3":"0.00000000","4":"0.4983063","5":"0.4708995","6":"0.5"},{"1":"x2","2":"-1.023014058","3":"0.00000000","4":"0.4983063","5":"0.4708995","6":"0.5"},{"1":"x1","2":"-0.053430597","3":"0.41522491","4":"0.4900680","5":"0.4709830","6":"0.5"},{"1":"x1","2":"1.532257922","3":"0.49006801","4":"0.4152249","5":"0.4709830","6":"0.5"},{"1":"x1","2":"-0.257136280","3":"0.38132807","4":"0.4930365","5":"0.4712534","6":"0.5"},{"1":"x1","2":"1.520914290","3":"0.48979592","4":"0.4215023","5":"0.4716981","6":"0.5"},{"1":"x1","2":"0.125021393","3":"0.43704475","4":"0.4872926","5":"0.4717158","6":"0.5"},{"1":"x1","2":"0.134347469","3":"0.44091797","4":"0.4869161","5":"0.4721967","6":"0.5"},{"1":"x1","2":"1.749188014","3":"0.49286025","4":"0.3926234","5":"0.4723117","6":"0.5"},{"1":"x1","2":"0.008130556","3":"0.42710744","4":"0.4895125","5":"0.4723511","6":"0.5"},{"1":"x1","2":"2.196544935","3":"0.49494065","4":"0.3496358","5":"0.4724184","6":"0.5"},{"1":"x1","2":"-0.370309590","3":"0.34963580","4":"0.4949407","5":"0.4724184","6":"0.5"},{"1":"x1","2":"1.926571814","3":"0.49397680","4":"0.3750000","5":"0.4725610","6":"0.5"},{"1":"x1","2":"-0.074079101","3":"0.41319444","4":"0.4913435","5":"0.4725877","6":"0.5"},{"1":"x1","2":"1.613212710","3":"0.49134349","4":"0.4131944","5":"0.4725877","6":"0.5"},{"1":"x2","2":"2.207488935","3":"0.49747678","4":"0.2076125","5":"0.4728383","6":"0.5"},{"1":"x1","2":"1.725681429","3":"0.49267719","4":"0.4023797","5":"0.4732632","6":"0.5"},{"1":"x1","2":"1.576976508","3":"0.49111111","4":"0.4200000","5":"0.4733333","6":"0.5"},{"1":"x1","2":"-0.071295170","3":"0.42000000","4":"0.4911111","5":"0.4733333","6":"0.5"},{"1":"x1","2":"-0.429649585","3":"0.33673469","4":"0.4956733","5":"0.4734219","6":"0.5"},{"1":"x1","2":"2.285264980","3":"0.49567334","4":"0.3367347","5":"0.4734219","6":"0.5"},{"1":"x1","2":"-1.464690853","3":"0.00000000","4":"0.4986150","5":"0.4736842","6":"0.5"},{"1":"x2","2":"-1.082164290","3":"0.00000000","4":"0.4986150","5":"0.4736842","6":"0.5"},{"1":"x1","2":"1.897709107","3":"0.49382716","4":"0.3878116","5":"0.4736842","6":"0.5"},{"1":"x1","2":"-0.264756676","3":"0.38781163","4":"0.4938272","5":"0.4736842","6":"0.5"},{"1":"x1","2":"0.267442252","3":"0.45331790","4":"0.4852295","5":"0.4737413","6":"0.5"},{"1":"x1","2":"-0.019836616","3":"0.42603550","4":"0.4908692","5":"0.4740125","6":"0.5"},{"1":"x1","2":"1.522310375","3":"0.49086925","4":"0.4260355","5":"0.4740125","6":"0.5"},{"1":"x1","2":"0.005244683","3":"0.43141289","4":"0.4906174","5":"0.4746322","6":"0.5"},{"1":"x1","2":"1.518293955","3":"0.49061738","4":"0.4314129","5":"0.4746322","6":"0.5"},{"1":"x1","2":"1.816825183","3":"0.49367187","4":"0.3987500","5":"0.4746875","6":"0.5"},{"1":"x1","2":"0.192282525","3":"0.44781065","4":"0.4879012","5":"0.4748718","6":"0.5"},{"1":"x1","2":"-0.400761723","3":"0.35777778","4":"0.4955709","5":"0.4749020","6":"0.5"},{"1":"x1","2":"2.228716379","3":"0.49557093","4":"0.3577778","5":"0.4749020","6":"0.5"},{"1":"x1","2":"-0.681595736","3":"0.29752066","4":"0.4969070","5":"0.4749745","6":"0.5"},{"1":"x2","2":"2.242263910","3":"0.49787335","4":"0.2187500","5":"0.4755435","6":"0.5"},{"1":"x1","2":"1.741742104","3":"0.49351066","4":"0.4081633","5":"0.4755877","6":"0.5"},{"1":"x1","2":"-0.071974368","3":"0.42482299","4":"0.4920837","5":"0.4756048","6":"0.5"},{"1":"x1","2":"1.591324822","3":"0.49208368","4":"0.4248230","5":"0.4756048","6":"0.5"},{"1":"x1","2":"2.290042376","3":"0.49624110","4":"0.3456790","5":"0.4759152","6":"0.5"},{"1":"x1","2":"-0.487292651","3":"0.34567901","4":"0.4962411","5":"0.4759152","6":"0.5"},{"1":"x1","2":"0.259433566","3":"0.45625868","4":"0.4867496","5":"0.4759253","6":"0.5"},{"1":"x1","2":"1.925173384","3":"0.49456133","4":"0.3944485","5":"0.4760405","6":"0.5"},{"1":"x1","2":"0.310785039","3":"0.45862263","4":"0.4863290","5":"0.4762162","6":"0.5"},{"1":"x1","2":"-1.529105572","3":"0.00000000","4":"0.4988898","5":"0.4764398","6":"0.5"},{"1":"x2","2":"-1.095889767","3":"0.00000000","4":"0.4988898","5":"0.4764398","6":"0.5"},{"1":"x1","2":"-0.589045843","3":"0.32986111","4":"0.4968363","5":"0.4767992","6":"0.5"},{"1":"x1","2":"-0.019593015","3":"0.43574226","4":"0.4916470","5":"0.4768322","6":"0.5"},{"1":"x1","2":"1.870899745","3":"0.49442537","4":"0.4049967","5":"0.4769868","6":"0.5"},{"1":"x1","2":"-0.414441664","3":"0.36623068","4":"0.4961527","5":"0.4773140","6":"0.5"},{"1":"x1","2":"1.510827689","3":"0.49141498","4":"0.4403306","5":"0.4773668","6":"0.5"},{"1":"x1","2":"0.205190129","3":"0.45408632","4":"0.4888617","5":"0.4773858","6":"0.5"},{"1":"x1","2":"0.248728401","3":"0.45674740","4":"0.4885216","5":"0.4777184","6":"0.5"},{"1":"x1","2":"0.258880758","3":"0.45918367","4":"0.4881657","5":"0.4780220","6":"0.5"},{"1":"x2","2":"2.255267507","3":"0.49823229","4":"0.2311111","5":"0.4781982","6":"0.5"},{"1":"x1","2":"2.342765510","3":"0.49676311","4":"0.3550296","5":"0.4783378","6":"0.5"},{"1":"x1","2":"-0.570429501","3":"0.35502959","4":"0.4967631","5":"0.4783378","6":"0.5"},{"1":"x1","2":"0.319988146","3":"0.46347699","4":"0.4874024","5":"0.4785500","6":"0.5"},{"1":"x1","2":"-1.776926087","3":"0.00000000","4":"0.4991319","5":"0.4791667","6":"0.5"},{"1":"x2","2":"-1.113541170","3":"0.00000000","4":"0.4991319","5":"0.4791667","6":"0.5"},{"1":"x1","2":"-0.668445480","3":"0.34026465","4":"0.4973028","5":"0.4792434","6":"0.5"},{"1":"x1","2":"0.205456121","3":"0.45979060","4":"0.4897959","5":"0.4797441","6":"0.5"},{"1":"x1","2":"1.486247706","3":"0.49218750","4":"0.4483418","5":"0.4799107","6":"0.5"},{"1":"x1","2":"0.256750222","3":"0.46208780","4":"0.4894820","5":"0.4800310","6":"0.5"},{"1":"x1","2":"1.467109246","3":"0.49196588","4":"0.4518430","5":"0.4803303","6":"0.5"},{"1":"x1","2":"2.343730594","3":"0.49724082","4":"0.3648000","5":"0.4806857","6":"0.5"},{"1":"x1","2":"-0.582356684","3":"0.36480000","4":"0.4972408","5":"0.4806857","6":"0.5"},{"1":"x1","2":"0.323206613","3":"0.46791111","4":"0.4884480","5":"0.4807467","6":"0.5"},{"1":"x2","2":"2.281585046","3":"0.49855475","4":"0.2448980","5":"0.4807988","6":"0.5"},{"1":"x1","2":"-1.796286610","3":"0.00000000","4":"0.4993423","5":"0.4818653","6":"0.5"},{"1":"x2","2":"-1.161742789","3":"0.00000000","4":"0.4993423","5":"0.4818653","6":"0.5"},{"1":"x1","2":"1.486004801","3":"0.49293364","4":"0.4555248","5":"0.4822721","6":"0.5"},{"1":"x1","2":"1.442442554","3":"0.49273175","4":"0.4584889","5":"0.4826301","6":"0.5"},{"1":"x1","2":"0.325768984","3":"0.47195291","4":"0.4894641","5":"0.4828098","6":"0.5"},{"1":"x1","2":"2.432939360","3":"0.49767562","4":"0.3750000","5":"0.4829545","6":"0.5"},{"1":"x2","2":"2.293604575","3":"0.49884183","4":"0.2603550","5":"0.4833402","6":"0.5"},{"1":"x1","2":"0.574290652","3":"0.48000000","4":"0.4866116","5":"0.4836364","6":"0.5"},{"1":"x1","2":"-1.960779713","3":"0.00000000","4":"0.4995217","5":"0.4845361","6":"0.5"},{"1":"x2","2":"-1.241636702","3":"0.00000000","4":"0.4995217","5":"0.4845361","6":"0.5"},{"1":"x2","2":"2.519258089","3":"0.49952173","4":"0.0000000","5":"0.4845361","6":"0.5"},{"1":"x1","2":"0.366954472","3":"0.47562827","4":"0.4904488","5":"0.4847429","6":"0.5"},{"1":"x1","2":"1.436278077","3":"0.49346939","4":"0.4644444","5":"0.4847619","6":"0.5"},{"1":"x1","2":"1.419537021","3":"0.49327872","4":"0.4667014","5":"0.4850397","6":"0.5"},{"1":"x1","2":"2.482942028","3":"0.49806888","4":"0.3856333","5":"0.4851388","6":"0.5"},{"1":"x1","2":"0.571872338","3":"0.48175735","4":"0.4882721","5":"0.4853730","6":"0.5"},{"1":"x1","2":"0.659906227","3":"0.48255042","4":"0.4878377","5":"0.4854320","6":"0.5"},{"1":"x2","2":"2.473922169","3":"0.49932842","4":"0.1975309","5":"0.4857475","6":"0.5"},{"1":"x2","2":"2.421916511","3":"0.49909461","4":"0.2777778","5":"0.4858156","6":"0.5"},{"1":"x1","2":"0.425475683","3":"0.47896121","4":"0.4914002","5":"0.4865490","6":"0.5"},{"1":"x1","2":"0.434501300","3":"0.48000000","4":"0.4911111","5":"0.4866667","6":"0.5"},{"1":"x1","2":"1.432136010","3":"0.49417732","4":"0.4697662","5":"0.4867319","6":"0.5"},{"1":"x1","2":"0.516429077","3":"0.48269335","4":"0.4901508","5":"0.4869441","6":"0.5"},{"1":"x1","2":"1.391351682","3":"0.49400607","4":"0.4716553","5":"0.4869656","6":"0.5"},{"1":"x1","2":"0.566817311","3":"0.48347107","4":"0.4897959","5":"0.4870130","6":"0.5"},{"1":"x1","2":"0.687617592","3":"0.48487713","4":"0.4890261","5":"0.4871176","6":"0.5"},{"1":"x1","2":"0.693435680","3":"0.48551381","4":"0.4886080","5":"0.4871538","6":"0.5"},{"1":"x1","2":"-2.017570738","3":"0.00000000","4":"0.4996713","5":"0.4871795","6":"0.5"},{"1":"x2","2":"-1.314363134","3":"0.00000000","4":"0.4996713","5":"0.4871795","6":"0.5"},{"1":"x2","2":"2.664528311","3":"0.49967127","4":"0.0000000","5":"0.4871795","6":"0.5"},{"1":"x1","2":"2.489806031","3":"0.49842192","4":"0.3966942","5":"0.4872319","6":"0.5"},{"1":"x2","2":"2.433115748","3":"0.49931413","4":"0.2975207","5":"0.4882155","6":"0.5"},{"1":"x1","2":"0.433582885","3":"0.48197404","4":"0.4923161","5":"0.4882310","6":"0.5"},{"1":"x2","2":"2.477865286","3":"0.49951172","4":"0.2187500","5":"0.4882812","6":"0.5"},{"1":"x1","2":"0.437542376","3":"0.48285322","4":"0.4920556","5":"0.4883287","6":"0.5"},{"1":"x1","2":"0.470808790","3":"0.48366962","4":"0.4917817","5":"0.4884152","6":"0.5"},{"1":"x1","2":"0.508118067","3":"0.48442907","4":"0.4914934","5":"0.4884910","6":"0.5"},{"1":"x1","2":"0.528698093","3":"0.48513674","4":"0.4911896","5":"0.4885566","6":"0.5"},{"1":"x1","2":"0.692220033","3":"0.48699272","4":"0.4901738","5":"0.4886946","6":"0.5"},{"1":"x1","2":"0.708542916","3":"0.48753463","4":"0.4897959","5":"0.4887218","6":"0.5"},{"1":"x1","2":"0.768219076","3":"0.48804336","4":"0.4893958","5":"0.4887399","6":"0.5"},{"1":"x1","2":"1.385771564","3":"0.49470156","4":"0.4760742","5":"0.4887408","6":"0.5"},{"1":"x1","2":"1.348700546","3":"0.49454221","4":"0.4775023","5":"0.4889190","6":"0.5"},{"1":"x1","2":"2.490978713","3":"0.49873599","4":"0.4081633","5":"0.4892259","6":"0.5"},{"1":"x1","2":"0.455341779","3":"0.48542534","4":"0.4929618","5":"0.4898718","6":"0.5"},{"1":"x1","2":"0.488746502","3":"0.48611111","4":"0.4927170","5":"0.4899425","6":"0.5"},{"1":"x1","2":"0.752532941","3":"0.48936632","4":"0.4909393","5":"0.4901843","6":"0.5"},{"1":"x1","2":"0.818429991","3":"0.48979592","4":"0.4905805","5":"0.4901961","6":"0.5"},{"1":"x1","2":"0.887558794","3":"0.49058055","4":"0.4897959","5":"0.4901961","6":"0.5"},{"1":"x1","2":"0.878706588","3":"0.49020000","4":"0.4902000","5":"0.4902000","6":"0.5"},{"1":"x1","2":"1.351103591","3":"0.49536351","4":"0.4800000","5":"0.4903704","6":"0.5"},{"1":"x1","2":"1.334410988","3":"0.49522302","4":"0.4811762","5":"0.4905173","6":"0.5"},{"1":"x2","2":"2.453887785","3":"0.49950139","4":"0.3200000","5":"0.4905263","6":"0.5"},{"1":"x2","2":"2.493685703","3":"0.49966442","4":"0.2448980","5":"0.4907476","6":"0.5"},{"1":"x1","2":"1.279559523","3":"0.49476099","4":"0.4841434","5":"0.4908856","6":"0.5"},{"1":"x1","2":"2.499842651","3":"0.49901235","4":"0.4200000","5":"0.4911111","6":"0.5"},{"1":"x1","2":"0.915277236","3":"0.49203506","4":"0.4910192","5":"0.4915424","6":"0.5"},{"1":"x1","2":"0.880230865","3":"0.49171650","4":"0.4913784","5":"0.4915492","6":"0.5"},{"1":"x1","2":"0.840697451","3":"0.49137843","4":"0.4917165","5":"0.4915492","6":"0.5"},{"1":"x1","2":"1.301941035","3":"0.49586777","4":"0.4844291","5":"0.4919786","6":"0.5"},{"1":"x1","2":"1.297167310","3":"0.49573964","4":"0.4853061","5":"0.4920879","6":"0.5"},{"1":"x1","2":"1.282878941","3":"0.49560547","4":"0.4861111","5":"0.4921875","6":"0.5"},{"1":"x1","2":"1.270289602","3":"0.49546485","4":"0.4868517","5":"0.4922780","6":"0.5"},{"1":"x1","2":"0.916822986","3":"0.49334320","4":"0.4921875","5":"0.4927885","6":"0.5"},{"1":"x1","2":"2.526092968","3":"0.49925216","4":"0.4321330","5":"0.4928758","6":"0.5"},{"1":"x1","2":"1.301202425","3":"0.49647456","4":"0.4872926","5":"0.4933068","6":"0.5"},{"1":"x1","2":"1.287421847","3":"0.49636440","4":"0.4879984","5":"0.4933945","6":"0.5"},{"1":"x1","2":"1.269316909","3":"0.49612800","4":"0.4892444","5":"0.4935467","6":"0.5"},{"1":"x1","2":"0.946183859","3":"0.49451247","4":"0.4932964","5":"0.4939348","6":"0.5"},{"1":"x1","2":"2.551446154","3":"0.49945659","4":"0.4444444","5":"0.4945055","6":"0.5"},{"1":"x1","2":"1.244438442","3":"0.49674818","4":"0.4913435","5":"0.4946944","6":"0.5"},{"1":"x1","2":"1.149480708","3":"0.49652778","4":"0.4921875","5":"0.4947917","6":"0.5"},{"1":"x1","2":"0.951265099","3":"0.49555002","4":"0.4943413","5":"0.4949819","6":"0.5"},{"1":"x1","2":"1.238769995","3":"0.49732302","4":"0.4931692","5":"0.4957238","6":"0.5"},{"1":"x1","2":"1.210624499","3":"0.49723380","4":"0.4935107","5":"0.4957632","6":"0.5"},{"1":"x1","2":"1.126644806","3":"0.49714003","4":"0.4938272","5":"0.4957983","6":"0.5"},{"1":"x1","2":"1.084827301","3":"0.49704142","4":"0.4941211","5":"0.4958295","6":"0.5"},{"1":"x1","2":"1.071866057","3":"0.49682826","4":"0.4946492","5":"0.4958804","6":"0.5"},{"1":"x1","2":"1.053188784","3":"0.49671293","4":"0.4948870","5":"0.4959004","6":"0.5"},{"1":"x1","2":"1.040697342","3":"0.49659120","4":"0.4951093","5":"0.4959169","6":"0.5"},{"1":"x1","2":"0.953833479","3":"0.49646257","4":"0.4953174","5":"0.4959301","6":"0.5"},{"1":"x1","2":"2.576843426","3":"0.49962674","4":"0.4567474","5":"0.4959820","6":"0.5"},{"1":"x1","2":"1.224054162","3":"0.49785004","4":"0.4947403","5":"0.4966372","6":"0.5"},{"1":"x1","2":"3.166971551","3":"0.49987919","4":"0.4081633","5":"0.4966691","6":"0.5"},{"1":"x1","2":"1.098734773","3":"0.49770181","4":"0.4952409","5":"0.4966928","6":"0.5"},{"1":"x1","2":"1.079757235","3":"0.49762188","4":"0.4954649","5":"0.4967159","6":"0.5"},{"1":"x1","2":"1.072035946","3":"0.49753770","4":"0.4956733","5":"0.4967360","6":"0.5"},{"1":"x1","2":"1.058348565","3":"0.49744898","4":"0.4958678","5":"0.4967532","6":"0.5"},{"1":"x1","2":"1.047457586","3":"0.49735537","4":"0.4960494","5":"0.4967677","6":"0.5"},{"1":"x1","2":"1.028464289","3":"0.49725652","4":"0.4962193","5":"0.4967794","6":"0.5"},{"1":"x1","2":"2.624577968","3":"0.49976371","4":"0.4687500","5":"0.4972826","6":"0.5"},{"1":"x1","2":"1.076956974","3":"0.49814745","4":"0.4966090","5":"0.4974936","6":"0.5"},{"1":"x1","2":"3.503126460","3":"0.49994686","4":"0.4444444","5":"0.4982818","6":"0.5"},{"1":"x1","2":"2.693936802","3":"0.49986852","4":"0.4800000","5":"0.4983784","6":"0.5"},{"1":"x1","2":"2.988126490","3":"0.49994575","4":"0.4687500","5":"0.4986979","6":"0.5"},{"1":"x1","2":"2.710763558","3":"0.49994219","4":"0.4897959","5":"0.4992320","6":"0.5"},{"1":"x1","2":"3.529264199","3":"0.49998685","4":"0.4800000","5":"0.4994872","6":"0.5"},{"1":"x1","2":"2.929863726","3":"0.49998629","4":"0.4938272","5":"0.4997091","6":"0.5"},{"1":"x1","2":"2.887947028","3":"0.49998600","4":"0.4958678","5":"0.4997595","6":"0.5"},{"1":"x1","2":"2.742092422","3":"0.49998570","4":"0.4970414","5":"0.4997943","6":"0.5"},{"1":"x1","2":"2.813038608","3":"0.50000000","4":"0.5000000","5":"0.5000000","6":"0.5"},{"1":"x1","2":"2.892025340","3":"0.50000000","4":"0.5000000","5":"0.5000000","6":"0.5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We plot for variables <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> the weighted average Gini index for each possible split of data:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x=</span>split_rule, <span class="at">y =</span>imp_total, <span class="at">col =</span> feature_split)) <span class="sc">+</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The best split in terms of impurity decrease is shown below:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(node_val <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="fu">which.min</span>(imp_total)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["feature_split"],"name":[1],"type":["chr"],"align":["left"]},{"label":["split_rule"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["imp_left"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["imp_right"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["imp_total"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["imp_node"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"x2","2":"0.1508644","3":"0.1420118","4":"0.4558072","5":"0.3742204","6":"0.5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>It is achieved for <span class="math inline">\(x_2\)</span> and a value of <span class="math inline">\(0.15\)</span> which is consistent with the <code>R</code> implementation.</p>
<p>The slightly different value <span class="math inline">\(0.1509\)</span> found by our toy implementation vs <span class="math inline">\(0.1441\)</span> for <code>rpart</code> is because <code>CART/rpart</code> splits variables at a midpoint between successive values in data set, while we split ‘on’ the exact values, see for example discussion <a href="https://stackoverflow.com/questions/6290057/how-decision-tree-calculate-the-splitting-attribute?rq=3">here</a>).</p>
<p>Indeed when looking at the adjacent value to our split with minimum impurity:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(node_val_midpoint <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(feature_split<span class="sc">==</span><span class="st">'x2'</span>, split_rule <span class="sc">&lt;=</span> <span class="fl">0.1509</span>, ) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(split_rule)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["feature_split"],"name":[1],"type":["chr"],"align":["left"]},{"label":["split_rule"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["imp_left"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["imp_right"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["imp_total"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["imp_node"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"x2","2":"0.1508644","3":"0.1420118","4":"0.4558072","5":"0.3742204","6":"0.5"},{"1":"x2","2":"0.1373897","3":"0.1445598","4":"0.4583577","5":"0.3783393","6":"0.5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>and taking the average value we verify that <code>rpart</code> splits on midpoint value:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(node_val_midpoint <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(split_rule <span class="sc">&lt;</span> <span class="fl">0.16</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">midpoint=</span><span class="fu">mean</span>(split_rule)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">pull</span>(midpoint))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1441271</code></pre>
</div>
</div>
<p>All of this nitpicking shows that each decision tree implementation is specific and when using a new one it is a good idea to check some details on simple cases.</p>
<p>As a matter of fact modern decision tree (boosting) algorithm optimize the way tree splitting is performed see for example <a href="https://lightgbm.readthedocs.io/en/stable/Features.html#optimization-in-speed-and-memory-usage">LightGBM</a> using histograms/binning for numerical variables and <a href="https://xgboost.readthedocs.io/en/stable/treemethod.html">XGBoost</a> using various methods from iterating over all values (<code>exact</code>) to histogram methods similar to LightGBM (<code>hist</code>). XGBoost developers even warn the package users that actual implementation of algorithm may differ from pure mathematical theory<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p>So we have slightly modified our splitting algorithm implementation above (<code>max_impurity_decrease</code>) with the option to split on midpoints so that it matches the value from <code>CART/rpart</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tbl_node <span class="ot">&lt;-</span> data_mixture_example</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>y_name <span class="ot">&lt;-</span> <span class="fu">as.name</span>(<span class="st">"Y"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>x_names <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"x1"</span>), <span class="fu">as.name</span>(<span class="st">"x2"</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>test_midpoint <span class="ot">&lt;-</span> <span class="fu">max_impurity_decrease</span>(tbl_node, y_name, x_names,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>(test_midpoint <span class="ot">&lt;-</span>test_midpoint <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(feature_split<span class="sc">!=</span><span class="st">"zzz"</span>, imp_total <span class="sc">!=</span> <span class="dv">666</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="fu">which.min</span>(imp_total)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["feature_split"],"name":[1],"type":["chr"],"align":["left"]},{"label":["split_rule"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["imp_left"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["imp_right"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["imp_total"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["imp_node"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"x2","2":"0.1441271","3":"0.1420118","4":"0.4558072","5":"0.3742204","6":"0.5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We then implement the recursive splitting algorithm, specifying some stopping rules (the node is pure, a maximum tree depth is attained, a minimum number of observations per node is attained).</p>
<p>At each step a node/list stores the relevant information: the split variable and value, the left/right children (two nodes/lists), impurity for the node, number of observations for class <span class="math inline">\(0/1\)</span>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tbl_node <span class="ot">&lt;-</span> data_mixture_example</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>y_name <span class="ot">&lt;-</span> <span class="fu">as.name</span>(<span class="st">"Y"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>x_names <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"x1"</span>), <span class="fu">as.name</span>(<span class="st">"x2"</span>))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>node <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_node,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">"impurity"</span> <span class="ot">=</span> <span class="fl">0.5</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">"n_zero"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">"n_one"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">"p1"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>             <span class="st">"vote"</span> <span class="ot">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We define a <code>break_at</code> function implementing the best split for a given node and returning the splitting rule (variable to split, split value):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>break_at <span class="ot">&lt;-</span> <span class="cf">function</span>(node, min_leaf, midpoint){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    tbl_node <span class="ot">&lt;-</span> node[[<span class="st">"data"</span>]]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    y_name <span class="ot">&lt;-</span> node[[<span class="st">"target"</span>]]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    x_names <span class="ot">&lt;-</span> node[[<span class="st">"features"</span>]]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    break_node <span class="ot">&lt;-</span> <span class="fu">max_impurity_decrease</span>(tbl_node, y_name, x_names,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                                        gini, min_leaf, midpoint)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    break_node <span class="ot">&lt;-</span> break_node <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(feature_split<span class="sc">!=</span><span class="st">"zzz"</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>               imp_total <span class="sc">!=</span> <span class="dv">666</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>               <span class="co"># don't split when node is pure (ie 0 impurity)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>               imp_node <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="fu">which.min</span>(imp_total))</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(break_node)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The function below <code>conditional_split</code> looks at a provided children node (left or right) to check if it is terminal given a stopping rule (either the max tree depth is attained, or there is a single element in the node). If not the tree continues to grow (ie the recursion continues and the recursive function <code>grow_decision_tree</code> defined below is called). It also computes metrics (number of observations per class, probabilities of classes 0-1, vote …) to fill the given node with useful information:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>conditional_split <span class="ot">&lt;-</span> <span class="cf">function</span>(node, depth, max_depth, min_leaf, midpoint)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(node[[<span class="st">"data"</span>]]) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> depth <span class="sc">==</span> max_depth) {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"is_leaf"</span>]] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      y_name <span class="ot">&lt;-</span> node[[<span class="st">"target"</span>]] </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>      table_node <span class="ot">&lt;-</span> node[[<span class="st">"data"</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!</span>y_name) <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">table</span>()</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># produces a table for 0-1 classes</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># target variable</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 0    1 </span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># n_0 n_1 </span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(table_node)</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>      n_zero_node<span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(table_node[<span class="dv">1</span>])</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"n_zero"</span>]] <span class="ot">&lt;-</span> n_zero_node</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>      n_one_node<span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(table_node[<span class="dv">2</span>])</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"n_one"</span>]] <span class="ot">&lt;-</span> n_one_node</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>      prob_node <span class="ot">&lt;-</span> n_one_node <span class="sc">/</span> (n_zero_node<span class="sc">+</span> n_one_node)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(prob_node)</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"p1"</span>]] <span class="ot">&lt;-</span> prob_node</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>      vote_node<span class="ot">&lt;-</span> <span class="fu">ifelse</span>(n_one_node<span class="sc">&gt;</span> n_zero_node, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"vote"</span>]] <span class="ot">&lt;-</span> vote_node</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(node)}</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="fu">grow_decision_tree</span>(node, depth <span class="sc">+</span> <span class="dv">1</span>, max_depth, min_leaf, midpoint)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>}    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally the function <code>grow_decision_tree</code> implements the recursion, breaking the current node into left and right children nodes and conditionally to the stopping rule splitting each child node:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>grow_decision_tree <span class="ot">&lt;-</span> <span class="cf">function</span>(node, <span class="at">depth =</span> <span class="dv">1</span>, <span class="at">max_depth =</span> <span class="dv">2</span>,</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">min_leaf =</span> <span class="dv">5</span>, <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># before split</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  tbl_node <span class="ot">&lt;-</span> node[[<span class="st">"data"</span>]]  </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  x_names  <span class="ot">&lt;-</span> node[[<span class="st">"features"</span>]]  </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  y_name <span class="ot">&lt;-</span> node[[<span class="st">"target"</span>]]  </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  table_node <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">!!</span>y_name) <span class="sc">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">table</span>()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(table_node)</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  n_zero_node<span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(table_node[<span class="dv">1</span>])</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"n_zero"</span>]] <span class="ot">&lt;-</span> n_zero_node</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  n_one_node<span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(table_node[<span class="dv">2</span>])</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"n_one"</span>]] <span class="ot">&lt;-</span> n_one_node</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  prob_node <span class="ot">&lt;-</span> n_one_node <span class="sc">/</span> (n_zero_node<span class="sc">+</span> n_one_node)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(prob_node)</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"p1"</span>]] <span class="ot">&lt;-</span> prob_node</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  vote_node<span class="ot">&lt;-</span> <span class="fu">ifelse</span>(n_one_node<span class="sc">&gt;</span> n_zero_node, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"vote"</span>]] <span class="ot">&lt;-</span> vote_node</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># split using break node function</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  break_node <span class="ot">&lt;-</span> <span class="fu">break_at</span>(node, min_leaf, midpoint)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(break_node) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"is_leaf"</span>]] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(node)}</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  x_name_node <span class="ot">&lt;-</span> <span class="fu">as.name</span>(break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(feature_split))</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  split_value_node <span class="ot">&lt;-</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(split_rule)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"impurity"</span>]] <span class="ot">&lt;-</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(imp_node)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"split"</span>]] <span class="ot">&lt;-</span> split_value_node</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"feature_split"</span>]] <span class="ot">&lt;-</span> x_name_node</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recursion, calling conditional split for left/right children</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  tbl_left <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name_node <span class="sc">&lt;</span> <span class="sc">!!</span>split_value_node)  </span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  node_left <span class="ot">&lt;-</span>  <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_left,</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"impurity"</span> <span class="ot">=</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(imp_left),</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"p1"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"vote"</span> <span class="ot">=</span> <span class="dv">666</span>)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  node_left <span class="ot">&lt;-</span> <span class="fu">conditional_split</span>(node_left, depth, max_depth, min_leaf, midpoint)</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  tbl_right <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name_node <span class="sc">&gt;=</span> <span class="sc">!!</span>split_value_node)  </span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>  node_right <span class="ot">&lt;-</span>  <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_right,</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"impurity"</span> <span class="ot">=</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(imp_right),</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"p1"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"vote"</span> <span class="ot">=</span> <span class="dv">666</span>)</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>  node_right <span class="ot">&lt;-</span> <span class="fu">conditional_split</span>(node_right, depth, max_depth, min_leaf, midpoint)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"left"</span>]] <span class="ot">&lt;-</span> node_left</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"right"</span>]] <span class="ot">&lt;-</span> node_right</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(node)</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="co"># inspired from this pattern:</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="co"># stackoverflow.com/questions/61621974/r-recursive-tree-algorithm-with-a-random-split</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="co"># mydata &lt;- data.frame(x = c(10, 20, 25, 35), y = c(-10.5, 6.5, 7.5, -7.5))</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a><span class="co"># conditional_split &lt;- function(df, depth, max_depth)</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a><span class="co">#   if(nrow(df) == 1 | depth == max_depth) return(df)</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a><span class="co">#   else grow_tree(df, depth + 1, max_depth)</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a><span class="co"># grow_tree &lt;- function(df, depth = 1, max_depth = 3)</span></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a><span class="co">#   break_at &lt;- sample(nrow(df) - 1, 1)</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="co">#   branched &lt;- list(left = df[1:break_at,], right = df[-seq(break_at),])</span></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a><span class="co">#   lapply(branched, conditional_split, depth, max_depth)</span></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a><span class="co"># tree &lt;- grow_tree(mydata, max_depth = 2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We also define a recursive function to help visualize the decision tree once it is “fitted”:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>print_tree <span class="ot">&lt;-</span> <span class="cf">function</span>(grown_tree, <span class="at">shift =</span><span class="st">''</span>, <span class="at">precision =</span> <span class="dv">3</span>){</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (grown_tree<span class="sc">$</span>is_leaf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        p1 <span class="ot">&lt;-</span> <span class="fu">round</span>(grown_tree<span class="sc">$</span>p1,<span class="dv">2</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        class <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>vote</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        n_zero <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>n_zero</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        n_one <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>n_one</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        impurity <span class="ot">&lt;-</span> <span class="fu">round</span>(grown_tree<span class="sc">$</span>impurity,<span class="dv">3</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>),</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>            glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'prob 1: {p1}, class: {class}, 0-1: {n_zero}/{n_one}, impurity: {impurity}'</span>))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Else recurse</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First print the splitting variable and rule</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(shift <span class="sc">==</span> <span class="st">''</span>){</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">'Root'</span> , <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        split <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>split</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        feature_split <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>feature_split</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(glue::glue('Node {feature_split} &lt; {split} Y/N?'))</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'|&gt; {feature_split} &lt; {round(split, precision)}'</span>), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">print_tree</span>(grown_tree<span class="sc">$</span>left, <span class="fu">paste0</span>(shift, <span class="st">'  '</span>)),<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'|&gt; {feature_split} &gt;= {round(split, precision)}'</span>), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">print_tree</span>(grown_tree<span class="sc">$</span>right, <span class="fu">paste0</span>(shift, <span class="st">'  '</span>)), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We test the recursive algorithm on the mixture data set:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>mixture_node <span class="ot">&lt;-</span> <span class="fu">grow_decision_tree</span>(node, <span class="at">max_depth =</span> <span class="dv">4</span>,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">min_leaf =</span> <span class="dv">7</span>, <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We do the same specifying similar parameters to <code>rpart</code>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>mixture_example_CART <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> data_mixture_example,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> <span class="fl">0.000001</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">minsplit =</span> <span class="dv">7</span> ,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">minbucket =</span> <span class="dv">7</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">maxdepth =</span> <span class="dv">4</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">method =</span> <span class="st">"class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To allow a precise check we show for each node/leaf both class 0/1 probabilities and number of observations (left: class O / BLUE, right: class 1 / ORANGE):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(mixture_example_CART, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">4</span>,</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)[mixture_example_CART<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                                                       x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We compare our implementation with <code>rpart</code>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>(mixture_node, <span class="st">''</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root 
   |&gt; x2 &lt; 0.1441 
     |&gt; x2 &lt; -0.344 
       prob 1: 0, class: 0, 0-1: 31/0, impurity: 0 
     |&gt; x2 &gt;= -0.344 
       |&gt; x2 &lt; -0.137 
         prob 1: 0.43, class: 0, 0-1: 4/3, impurity: 0.49 
       |&gt; x2 &gt;= -0.137 
         |&gt; x1 &lt; 0.993 
           prob 1: 0, class: 0, 0-1: 7/0, impurity: 0 
         |&gt; x1 &gt;= 0.993 
           prob 1: 0.14, class: 0, 0-1: 6/1, impurity: 0.245 
 
 
 
   |&gt; x2 &gt;= 0.1441 
     |&gt; x1 &lt; 2.246 
       |&gt; x2 &lt; 0.976 
         |&gt; x1 &lt; 1.017 
           prob 1: 0.24, class: 0, 0-1: 22/7, impurity: 0.366 
         |&gt; x1 &gt;= 1.017 
           prob 1: 0.95, class: 1, 0-1: 1/20, impurity: 0.091 
 
       |&gt; x2 &gt;= 0.976 
         |&gt; x1 &lt; -0.967 
           prob 1: 1, class: 1, 0-1: 0/15, impurity: 0 
         |&gt; x1 &gt;= -0.967 
           prob 1: 0.78, class: 1, 0-1: 14/49, impurity: 0.346 
 
 
     |&gt; x1 &gt;= 2.246 
       |&gt; x1 &lt; 3.078 
         prob 1: 0, class: 0, 0-1: 13/0, impurity: 0 
       |&gt; x1 &gt;= 3.078 
         prob 1: 0.71, class: 1, 0-1: 2/5, impurity: 0.408 
 
 </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mixture_example_CART)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>n= 200 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

 1) root 200 100 0 (0.50000000 0.50000000)  
   2) x2&lt; 0.1441271 52   4 0 (0.92307692 0.07692308) *
   3) x2&gt;=0.1441271 148  52 1 (0.35135135 0.64864865)  
     6) x1&gt;=2.245715 20   5 0 (0.75000000 0.25000000)  
      12) x1&lt; 3.077549 13   0 0 (1.00000000 0.00000000) *
      13) x1&gt;=3.077549 7   2 1 (0.28571429 0.71428571) *
     7) x1&lt; 2.245715 128  37 1 (0.28906250 0.71093750)  
      14) x2&lt; 0.976433 50  23 1 (0.46000000 0.54000000)  
        28) x1&lt; 1.016795 29   7 0 (0.75862069 0.24137931) *
        29) x1&gt;=1.016795 21   1 1 (0.04761905 0.95238095) *
      15) x2&gt;=0.976433 78  14 1 (0.17948718 0.82051282) *</code></pre>
</div>
</div>
<p>They are almost equivalent. The slight difference between our implementation and <code>rpart</code>: even if a split is admissible for terminal nodes improving the impurity, <code>rpart</code> seems to undo the split if it results in two terminal nodes predicting the same class).</p>
<p>To further verify this point we have used the <code>Python/scikit-learn</code> implementation of decision trees using <code>reticulate</code> package. This packages allows <code>R</code> to interact with <code>Python</code>, more details <a href="#%20https://rstudio.github.io/reticulate">here</a> and <a href="#%20https://www.r-bloggers.com/2020/04/how-to-run-pythons-scikit-learn-in-r-in-5-minutes/">here</a>. The python code is shown in the appendix, see <a href="#sec-appendix">Section&nbsp;4</a>.</p>
<p>We verify that our toy implementation of <code>CART</code> matches the <code>scikit-learn</code> implementation on the Mixture data set with comparable parameters (note that the default colors from <code>graphviz</code> are the opposite of the Mixture data set, ie Class 0 / BLUE filled in orange, Class 1 / ORANGE filled in blue):</p>
<p><img src="../images/check_tree_mixture.svg" class="img-fluid"></p>
<p>It is comparable to our implementation:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>(mixture_node, <span class="st">''</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root 
   |&gt; x2 &lt; 0.1441 
     |&gt; x2 &lt; -0.344 
       prob 1: 0, class: 0, 0-1: 31/0, impurity: 0 
     |&gt; x2 &gt;= -0.344 
       |&gt; x2 &lt; -0.137 
         prob 1: 0.43, class: 0, 0-1: 4/3, impurity: 0.49 
       |&gt; x2 &gt;= -0.137 
         |&gt; x1 &lt; 0.993 
           prob 1: 0, class: 0, 0-1: 7/0, impurity: 0 
         |&gt; x1 &gt;= 0.993 
           prob 1: 0.14, class: 0, 0-1: 6/1, impurity: 0.245 
 
 
 
   |&gt; x2 &gt;= 0.1441 
     |&gt; x1 &lt; 2.246 
       |&gt; x2 &lt; 0.976 
         |&gt; x1 &lt; 1.017 
           prob 1: 0.24, class: 0, 0-1: 22/7, impurity: 0.366 
         |&gt; x1 &gt;= 1.017 
           prob 1: 0.95, class: 1, 0-1: 1/20, impurity: 0.091 
 
       |&gt; x2 &gt;= 0.976 
         |&gt; x1 &lt; -0.967 
           prob 1: 1, class: 1, 0-1: 0/15, impurity: 0 
         |&gt; x1 &gt;= -0.967 
           prob 1: 0.78, class: 1, 0-1: 14/49, impurity: 0.346 
 
 
     |&gt; x1 &gt;= 2.246 
       |&gt; x1 &lt; 3.078 
         prob 1: 0, class: 0, 0-1: 13/0, impurity: 0 
       |&gt; x1 &gt;= 3.078 
         prob 1: 0.71, class: 1, 0-1: 2/5, impurity: 0.408 
 
 </code></pre>
</div>
</div>
<p>We do the same job with the <code>Iris</code> data set which is a multivariate data set used and made famous by the British statistician and biologist Ronald Fisher in his 1936 paper about linear discriminant analysis, we restrict to a binary classification problem excluding the <code>setosa</code> family.</p>
<p>We fit a decision tree for with max depth 2:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(iris)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>tbl_iris <span class="ot">=</span> iris <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    as_tibble <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Species<span class="sc">!=</span><span class="st">'setosa'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">droplevels</span>()</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>node <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_iris,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">"impurity"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">"target"</span> <span class="ot">=</span> <span class="fu">as.name</span>(<span class="st">"Species"</span>),</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">"features"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"Sepal.Length"</span>),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">as.name</span>(<span class="st">"Sepal.Width"</span>),</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">as.name</span>(<span class="st">"Petal.Length"</span>),</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">as.name</span>(<span class="st">"Petal.Width"</span>)),</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>             <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>             <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>             <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>             <span class="st">"n_zero"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>             <span class="st">"n_one"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>             <span class="st">"p1"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>             <span class="st">"vote"</span> <span class="ot">=</span> <span class="dv">0</span>)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>iris_node <span class="ot">&lt;-</span> <span class="fu">grow_decision_tree</span>(node, <span class="at">max_depth =</span> <span class="dv">2</span>, <span class="at">min_leaf =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>((iris_node))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root 
   |&gt; Petal.Width &lt; 1.75 
     |&gt; Petal.Length &lt; 4.95 
       prob 1: 0.02, class: 0, 0-1: 47/1, impurity: 0.041 
     |&gt; Petal.Length &gt;= 4.95 
       prob 1: 0.67, class: 1, 0-1: 2/4, impurity: 0.444 
 
   |&gt; Petal.Width &gt;= 1.75 
     |&gt; Petal.Length &lt; 4.95 
       prob 1: 0.83, class: 1, 0-1: 1/5, impurity: 0.278 
     |&gt; Petal.Length &gt;= 4.95 
       prob 1: 1, class: 1, 0-1: 0/40, impurity: 0 
 </code></pre>
</div>
</div>
<p>For a better visualization of our decision tree implemetation, we use <code>partykit</code> allowing to build/plot user defined trees:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(partykit)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to convert our tree implementation to a partykit object</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>convert_to_partynode <span class="ot">&lt;-</span> <span class="cf">function</span>(node, <span class="at">id =</span> <span class="dv">1</span>) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>node<span class="sc">$</span>is_leaf) {</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Internal node</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    left_child <span class="ot">&lt;-</span> <span class="fu">convert_to_partynode</span>(node<span class="sc">$</span>left, id <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    right_child <span class="ot">&lt;-</span> <span class="fu">convert_to_partynode</span>(node<span class="sc">$</span>right, id <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">partynode</span>(</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">id =</span> id,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">split =</span> <span class="fu">partysplit</span>(<span class="at">varid =</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(<span class="fu">as.character</span>(node<span class="sc">$</span>feature_split))),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">breaks =</span> node<span class="sc">$</span>split),</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">kids =</span> <span class="fu">list</span>(left_child, right_child),</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">info =</span> <span class="fu">list</span>(<span class="at">impurity =</span> node<span class="sc">$</span>impurity)  <span class="co"># Store impurity</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminal node</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">partynode</span>(</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">id =</span> id, </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">info =</span> <span class="fu">list</span>(</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">class =</span> node<span class="sc">$</span>vote,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">counts_0 =</span> node<span class="sc">$</span>n_zero,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">counts_1 =</span> node<span class="sc">$</span>n_one,</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">impurity =</span> node<span class="sc">$</span>impurity</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We use <code>partykit</code> to visualize our implementation on the iris data set:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert tree structure to partynode</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>root_node <span class="ot">&lt;-</span> <span class="fu">convert_to_partynode</span>(iris_node)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataset (needed for party object)</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> iris_node<span class="sc">$</span>data</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Map variable names to indices</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># varnames &lt;- as.character(iris_node$features)</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>varnames <span class="ot">&lt;-</span> <span class="fu">as.character</span>(iris_node<span class="sc">$</span>features)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(varnames) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(varnames))</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the `party` object</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># tree_party &lt;- party(root_node, data = data, names = varnames)</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>tree_party <span class="ot">&lt;-</span> <span class="fu">party</span>(root_node, <span class="at">data =</span> data)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the tree</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(tree_party)</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_party,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">terminal_panel =</span> <span class="fu">node_terminal</span>(tree_party,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">id =</span> <span class="cn">FALSE</span>,</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">height =</span> <span class="dv">4</span>,</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FUN =</span> <span class="cf">function</span>(node) {</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Class: {node$class}</span><span class="sc">\n</span><span class="st">Impurity: {round(node$impurity, 3)}</span><span class="sc">\n</span><span class="st">Counts: {node$counts_0}-{node$counts_1}"</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a> }))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Comparing with <code>scikit-learn</code>, we obtain same structure/leafs/impurities as our own implementation:</p>
<p><img src="../images/check_tree_iris.svg" class="lightbox img-fluid"></p>
</section>
<section id="building-strategy---pruning" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="building-strategy---pruning"><span class="header-section-number">1.3</span> Building strategy - Pruning</h2>
<p>The tree-building process described just above is likely to produce good predictions on the training set, but is also likely to overfit the data, leading to poor predictions on testing set or new data. This is because the resulting tree might be too complex.</p>
<p>In an extreme case, if we do not restrict the tree depth and allow a low minimum number of observations per leaf, many observations could be alone in their own region/node.</p>
<p>Conversely, a smaller tree with fewer splits/nodes/regions might underfit, missing key patterns in the data.</p>
<p>The right balance leading to lower variance and better interpretation at the cost of a little bias.</p>
<p>We can see the number of nodes or tree size as a parameter allowing to tune the model complexity.</p>
<p>We have to select this parameter.</p>
<p>The CART algorithm mainly uses the number of terminal nodes. The tree depth can also be used.</p>
<p>The CART strategy is to build a large tree <span class="math inline">\(T_0\)</span> and then sequentially prune it to obtain a sequence of nested trees.</p>
<p>Then a Cost complexity criterion is defined as:</p>
<p><span class="math display">\[
C_\alpha(T)=\hat R(T)+\alpha|T|
\]</span></p>
<p>where <span class="math inline">\(\hat R(T)\)</span> denote the empirical risk or a similar metric, <span class="math inline">\(|T|\)</span> the number of terminal nodes in <span class="math inline">\(T\)</span> and <span class="math inline">\(\alpha\)</span> is a parameter.</p>
<p>The idea is for a sequence of <span class="math inline">\(\alpha\)</span>, find the subtree <span class="math inline">\(T_\alpha \subset T_0\)</span> minimizing <span class="math inline">\(C_\alpha(T)\)</span>.</p>
<p>Then cross-validation is chosen to find and ‘optimal’ value of <span class="math inline">\(\alpha\)</span>.</p>
</section>
<section id="additional-ressources" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="additional-ressources"><span class="header-section-number">1.4</span> Additional ressources</h2>
<ul>
<li><p>Chapter 9.2 of <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span></p></li>
<li><p>A very nice D3.js visualization of Decision Tree building but maybe not that pedagogical: http://www.r2d3.us/visual-intro-to-machine-learning-part-1/</p></li>
<li><p>Also a very good tutorial to go deeper Decision Trees spliting and stopping rules (<code>literature/gbtree/theory/decisiontrees_guestrin_moore.pdf</code>)</p></li>
</ul>
</section>
<section id="exercises" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="exercises"><span class="header-section-number">1.5</span> Exercises</h2>
<section id="exercice-1-completed-in-case-study" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="exercice-1-completed-in-case-study"><span class="header-section-number">1.5.1</span> Exercice 1 (completed in Case Study)</h3>
<p>Using the Desbois data set, build and draw a decision tree using <code>rpart</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Compare a large tree and a smaller tree in terms of ROC/AUC/prediction on a testing set.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Try to understand the output of the <code>printcp</code> function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Choose a terminal number of leafs and prune the tree using the <code>prune</code> function.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Select the optimal <code>cp</code> for your tree (you can use a plot) and compare to the large and small models in terms of AUC.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="exercice-2-inspired-from-a.-géron-book" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="exercice-2-inspired-from-a.-géron-book"><span class="header-section-number">1.5.2</span> Exercice 2 (Inspired from A. Géron book)</h3>
<!-- # ```{python} -->
<!-- # https://github.com/ageron/handson-ml3/blob/main/06_decision_trees.ipynb  -->
<!-- np.random.seed(6) -->
<!-- X_square = np.random.rand(10, 2) - 0.5 -->
<!-- y_square = (X_square[:, 0] > 0).astype(np.int64) -->
<!-- # print(X_square) -->
<!-- # print(X_square[:, 0]) -->
<!-- # print(y_square) -->
<!-- angle = np.pi / 4  # 45 degrees -->
<!-- rotation_matrix = np.array([[np.cos(angle), -np.sin(angle)], -->
<!--                             [np.sin(angle), np.cos(angle)]]) -->
<!-- X_rotated_square = X_square.dot(rotation_matrix) -->
<!-- # ``` -->
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapted from Aurélien Géron </span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Géron, A. (2022). Hands-On Machine Learning with Scikit-Learn, Keras, and TensorFlow</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Chapter 6. Decision Trees / Sensitivity to axis orientation</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1987</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(<span class="dv">200</span>), <span class="at">nrow=</span><span class="dv">100</span>, <span class="at">ncol=</span><span class="dv">2</span>) <span class="sc">-</span> <span class="fl">0.5</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(X[,<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>angle <span class="ot">&lt;-</span> pi <span class="sc">/</span> <span class="dv">4</span> </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>rotation_matrix <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="fu">cos</span>(angle),<span class="sc">-</span><span class="fu">sin</span>(angle)),</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="fu">sin</span>(angle), <span class="fu">cos</span>(angle)))</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>X_rotated <span class="ot">&lt;-</span> X <span class="sc">%*%</span> rotation_matrix</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(Y, <span class="at">x1 =</span> X[,<span class="dv">1</span>], <span class="at">x2 =</span> X[,<span class="dv">2</span>])</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>data_rotated <span class="ot">&lt;-</span> <span class="fu">tibble</span>(Y, <span class="at">x1 =</span> X_rotated[,<span class="dv">1</span>], <span class="at">x2 =</span> X_rotated[,<span class="dv">2</span>])</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data_rotated <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">as.factor</span>(Y)), <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2, <span class="at">col =</span> Y)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Fit a decision tree on the rotated dataset.</p>
<p>Plot and comment the decision boundary in terms of generalization/test error.</p>
<p>Can you do better? Think of PCA for example.</p>
</section>
</section>
</section>
<section id="ensemble-methods---boosting" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Ensemble methods - Boosting</h1>
<p>Boosting is a machine learning technique developed in the late nineties. It was originally introduced for binary classification problems and it has been extended to other supervised learning problems (multiclass, regression, ranking, survival).</p>
<p>The core idea behind Boosting is to combine the predictions of several “weak” classifiers (ie slighlty better than random classifiers) to form a more robust and accurate model.</p>
<p>We roughly follow the path of Trevor Hastie 2003 talk on Boosting (see <a href="https://hastie.su.domains/public/TALKS/boost.pdf">here</a>), which was later developed in great details in the Chapter 10 of <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span>.</p>
<p>We start by introducing <code>AdaBoost</code> which was (one of<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>) the first successful implementation of the Boosting idea, introduced by Freund and Schapire in <span class="citation" data-cites="adaboost1996">Freund and Schapire (<a href="#ref-adaboost1996" role="doc-biblioref">1996</a>)</span>. The (Ada)Boosting idea:</p>
<p>“Fit many weak learners (eg small trees) to re-weighted versions of the learning set. Classify by a weighted majority vote.”</p>
<section id="adaboost" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="adaboost"><span class="header-section-number">2.1</span> Adaboost</h2>
<p>The algorithm is described in Chapter 10 of <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> (Algorithm 10.1):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/adaboost_algo_esl.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>or in Chapter 1 of <span class="citation" data-cites="boosting2012">Schapire and Freund (<a href="#ref-boosting2012" role="doc-biblioref">2012</a>)</span> (Algorithm 1.1):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/adaboost_algo.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>A toy example is also introduced in the latter book, showing graphically the first three iterations of the algorithm on a simplified data set:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/adaboost_toy_example.png" class="img-fluid figure-img"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/adaboost_toy_example2.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Following this algorithm description or pseudo code we implement a simplified version of AdaBoost using <code>rpart</code> decision trees as base/weak classifiers.</p>
<p>We implement here a version with stumps (ie decision tree with depth 1), but any kind of weak learner can be used:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function implementing the original AdaBoost algorithm (Algorithm 1.1)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># as described in:</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Schapire, R., Freund, Y. (2012). Boosting: Foundations and Algorithms</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># freely available here:</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co"># https://direct.mit.edu/books/oa-monograph/5342/BoostingFoundations-and-Algorithms</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterative fitting of the weak learners (here cesision tree stumps) to data</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>fit_original_adaboost <span class="ot">&lt;-</span> <span class="cf">function</span>(data, M, <span class="at">smoothing=</span><span class="cn">FALSE</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>){</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data is a tibble, we assume target variable is Y with labels in {-1, 1}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># M is an integer</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize observation weights: w^1_i = 1/n for i = 1,...,n</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(data)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span>  <span class="fu">rep</span>(<span class="dv">1</span>, n) <span class="sc">/</span> n</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Smoothing parameter see below</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(smoothing){eps <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>n}</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> <span class="fu">numeric</span>(M)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  weak_learner <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  weights[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> w</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  Y_target <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(data<span class="sc">$</span>Y))</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For m = 1,...,M:</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M) {</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train weak learner G^m(x) using distribution w^m</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>    weak_learner[[m]] <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>., <span class="at">data =</span> data, <span class="at">weights =</span> w, </span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp=</span><span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">maxdepth =</span> <span class="dv">1</span>,</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">minsplit =</span> <span class="dv">0</span>,</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">minbucket =</span> <span class="dv">1</span>,</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">maxsurrogate =</span> <span class="dv">0</span>,</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">maxcompete =</span> <span class="dv">0</span>), <span class="at">method =</span> <span class="st">"class"</span>)</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute error:</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># err^m = [Sum_n w^m_i * 11(y_i&lt;&gt;G^m(x_i)]</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    G[[m]] <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">predict</span>(weak_learner[[m]], <span class="at">type =</span><span class="st">"class"</span>)))</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># store 11(y_i&lt;&gt;G^m(x_i)</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>    misclass <span class="ot">&lt;-</span> (G[[m]]<span class="sc">!=</span>Y_target)</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In Freund Schapire 2012: no rescaling of error but rescaling of weights</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#err &lt;- sum(w * misclass) </span></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Alt. in ESLII rescaling of error but no rescaling of weights in the end</span></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>    err <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> misclass) <span class="sc">/</span> <span class="fu">sum</span>(w)</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){<span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'error at iteration {m}: {round(err,3)}'</span>))}</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (Schapire 2012 formulation)</span></span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choose alpha^m = 1/2 * log((1-err^m)/err^m)</span></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">#alpha[m] &lt;- 0.5 * log((1 - err) / err)</span></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Avoiding dividing by 0 as error decreases</span></span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># From 'Schapire, Singer (1999) Improved Boosting Algorithms </span></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using Confidence-rated Predictions'</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># section 4.2. Smoothing the predictions:</span></span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "In our experiments, we have typically used eps on the order of 1/n</span></span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># where n is the number of training examples"</span></span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (AdaBoost.M1 from ESL II) with eps trick from Schapire</span></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>    alpha[m] <span class="ot">&lt;-</span> <span class="fu">log</span>((<span class="dv">1</span> <span class="sc">-</span> err <span class="sc">+</span> eps) <span class="sc">/</span> (err <span class="sc">+</span> eps))</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (Schapire 2012 formulation)</span></span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update w^(m+1)_i = w^m_i / Z_m * exp[-alpha^m * y_i * G^m(x_i)],</span></span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Z_m so that Sum_i w^(m+1)_i = 1 </span></span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># w &lt;- w * exp(-alpha[m] * G[[m]] * Y_target)</span></span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># w &lt;- w / sum(w)</span></span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (ESLII 2009 formulation)</span></span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update w^(m+1)_i = w^m_i* exp[-alpha^m * y_i * G^m(x_i)],</span></span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  (AdaBoost.M1 from ESL II)</span></span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update w^(m+1)_i = w^m_i * exp[alpha^m * 11(y_i&lt;&gt;G^m(x_i))] </span></span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> w <span class="sc">*</span> <span class="fu">exp</span>(alpha[m] <span class="sc">*</span> misclass)<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>alpha[m]<span class="sc">/</span><span class="dv">2</span>) </span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the last exp(-alpha/2) if found in AdaBoost derivation</span></span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){<span class="fu">print</span>(w)}</span>
<span id="cb44-82"><a href="#cb44-82" aria-hidden="true" tabindex="-1"></a>    weights[[m<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> w</span>
<span id="cb44-83"><a href="#cb44-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-84"><a href="#cb44-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-85"><a href="#cb44-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-86"><a href="#cb44-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-87"><a href="#cb44-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output list of weights:alpha^m,  weak learners: G^m(.) for the predict function</span></span>
<span id="cb44-88"><a href="#cb44-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">alphas=</span>alpha, <span class="at">classifiers=</span>G, <span class="at">weak_learners=</span>weak_learner, <span class="at">weights=</span>weights))</span>
<span id="cb44-89"><a href="#cb44-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-90"><a href="#cb44-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-91"><a href="#cb44-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-92"><a href="#cb44-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Final prediction as the sign of weighted sum of weak classifiers</span></span>
<span id="cb44-93"><a href="#cb44-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Last step of algorithm / pseudocode</span></span>
<span id="cb44-94"><a href="#cb44-94" aria-hidden="true" tabindex="-1"></a>predict_original_adaboost <span class="ot">&lt;-</span> <span class="cf">function</span>(fitted_adaboost, new_data, <span class="at">num_tree =</span> <span class="sc">-</span><span class="dv">1</span>){</span>
<span id="cb44-95"><a href="#cb44-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-96"><a href="#cb44-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output G(x) = sign[Sum_m alpha^mG^m(x)]</span></span>
<span id="cb44-97"><a href="#cb44-97" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">length</span>(fitted_adaboost<span class="sc">$</span>alphas)</span>
<span id="cb44-98"><a href="#cb44-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(num_tree <span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> num_tree <span class="sc">&lt;</span> M){</span>
<span id="cb44-99"><a href="#cb44-99" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> num_tree</span>
<span id="cb44-100"><a href="#cb44-100" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb44-101"><a href="#cb44-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-102"><a href="#cb44-102" aria-hidden="true" tabindex="-1"></a>  G <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb44-103"><a href="#cb44-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb44-104"><a href="#cb44-104" aria-hidden="true" tabindex="-1"></a>    G_m <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">predict</span>(fitted_adaboost<span class="sc">$</span>weak_learners[[m]],</span>
<span id="cb44-105"><a href="#cb44-105" aria-hidden="true" tabindex="-1"></a>                                           new_data, <span class="at">type =</span><span class="st">"class"</span>)))</span>
<span id="cb44-106"><a href="#cb44-106" aria-hidden="true" tabindex="-1"></a>    G <span class="ot">&lt;-</span> G <span class="sc">+</span> fitted_adaboost<span class="sc">$</span>alpha[[m]] <span class="sc">*</span> G_m</span>
<span id="cb44-107"><a href="#cb44-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-108"><a href="#cb44-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-109"><a href="#cb44-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sign</span>(G))</span>
<span id="cb44-110"><a href="#cb44-110" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then illustrate AdaBoost on the Mixture data set. We first convert the target <span class="math inline">\(Y\)</span> to be in <span class="math inline">\(\{-1,1\}\)</span> then fit AdaBoost with <span class="math inline">\(3\)</span> iterations:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>data_ada <span class="ot">&lt;-</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">as.factor</span>(<span class="fu">if_else</span>(Y<span class="sc">==</span><span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>adaboost_M <span class="ot">&lt;-</span> <span class="fu">fit_original_adaboost</span>(data_ada, <span class="dv">3</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity checks (sum of weighted classifiers == predict_adaboost)</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># g1 &lt;- adaboost_M$alphas[1] * adaboost_M$classifiers[[1]]</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># g2 &lt;- adaboost_M$alphas[2] * adaboost_M$classifiers[[2]]</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># g3 &lt;- adaboost_M$alphas[3] * adaboost_M$classifiers[[3]]</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># g &lt;- g1+g2+g3</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># sign(g)</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># sign(g)==predict_original_adaboost(adaboost_M, data_ada %&gt;% select(x1,x2))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We represent weak learners (here decision tree stumps) boundary decisions, as well as re-weighted observations after each step:</p>
<ul>
<li>Step 1:</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("remotes")</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("grantmcdermott/parttree")</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parttree)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle plot orientation issue </span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># https://grantmcdermott.com/parttree/articles/parttree-intro.html#plot-orientation</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>step <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>variable_split <span class="ot">&lt;-</span> <span class="fu">rownames</span>(adaboost_M<span class="sc">$</span>weak_learners[[step]]<span class="sc">$</span>splits)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>last_stump <span class="ot">&lt;-</span> adaboost_M<span class="sc">$</span>weak_learners[[step]]</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada, <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y),<span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Weak learner at step {step}"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reweighted data</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_ada)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># breaks</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada<span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">weight=</span>adaboost_M<span class="sc">$</span>weights[[step<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">*</span>n), <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y, <span class="at">size=</span>weight)) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># playing with size scale we ensure a weight of 1/n has size 1.5 (ie standard ggplot size for points)</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">guide=</span><span class="st">'none'</span>) <span class="sc">+</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Reweighted data after step {step}"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-47-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Step 2:</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>step <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>variable_split <span class="ot">&lt;-</span> <span class="fu">rownames</span>(adaboost_M<span class="sc">$</span>weak_learners[[step]]<span class="sc">$</span>splits)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>last_stump <span class="ot">&lt;-</span> adaboost_M<span class="sc">$</span>weak_learners[[step]]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada, <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y),<span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Weak learner at step {step}"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reweighted data</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_ada)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># breaks</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada<span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">weight=</span>adaboost_M<span class="sc">$</span>weights[[step<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">*</span>n), <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y, <span class="at">size=</span>weight)) <span class="sc">+</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co"># playing with size scale we ensure a weight of 1/n has size 1.5 (ie standard ggplot size for points)</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">guide=</span><span class="st">'none'</span>) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Reweighted data after step {step}"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-48-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Step 3:</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>step <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>variable_split <span class="ot">&lt;-</span> <span class="fu">rownames</span>(adaboost_M<span class="sc">$</span>weak_learners[[step]]<span class="sc">$</span>splits)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>last_stump <span class="ot">&lt;-</span> adaboost_M<span class="sc">$</span>weak_learners[[step]]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada, <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y),<span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Weak learner at step {step}"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reweighted data</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_ada)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># breaks</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada<span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">weight=</span>adaboost_M<span class="sc">$</span>weights[[step<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">*</span>n), <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y, <span class="at">size=</span>weight)) <span class="sc">+</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># playing with size scale we ensure a weight of 1/n has size 1.5 (ie standard ggplot size for points)</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">guide=</span><span class="st">'none'</span>) <span class="sc">+</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtitle</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Reweighted data after step {step}"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-49-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>…</p>
<p>We run more iterations of AdaBoost, showing below Step 100:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction function used to classify areas on the grid and imply the decision boundary</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>predict_oracle <span class="ot">&lt;-</span> <span class="cf">function</span>(x1, x2){</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>       obj <span class="ot">&lt;-</span> obj <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>           <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">/</span><span class="dv">2</span><span class="sc">*</span>((x1<span class="sc">-</span>x1_means[i])<span class="sc">**</span><span class="dv">2</span><span class="sc">+</span>(x2<span class="sc">-</span>x2_means[i])<span class="sc">**</span><span class="dv">2</span>)) <span class="sc">-</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">/</span><span class="dv">2</span><span class="sc">*</span>((x1<span class="sc">-</span>x1_means[i<span class="sc">+</span><span class="dv">10</span>])<span class="sc">**</span><span class="dv">2</span><span class="sc">+</span>(x2<span class="sc">-</span>x2_means[i<span class="sc">+</span><span class="dv">10</span>])<span class="sc">**</span><span class="dv">2</span>))</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">*</span> (obj <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>predict_oracle_V <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(predict_oracle)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>tree_number <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>adaboost_M <span class="ot">&lt;-</span> <span class="fu">fit_original_adaboost</span>(data_ada, tree_number)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>variable_split <span class="ot">&lt;-</span> <span class="fu">rownames</span>(adaboost_M<span class="sc">$</span>weak_learners[[tree_number ]]<span class="sc">$</span>splits)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>last_stump <span class="ot">&lt;-</span> adaboost_M<span class="sc">$</span>weak_learners[[step]]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>(stump <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data_ada, <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col =</span> Y),<span class="at">size=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump <span class="ot">&lt;-</span> adaboost_M<span class="sc">$</span>weak_learners[[step]],<span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)) <span class="sc">+</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">expand =</span> <span class="cn">FALSE</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/7705345/how-can-i-extract-plot-axes-ranges-for-a-ggplot2-object</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot_build(stump)$layout$panel_scales_x[[1]]$range$range </span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot_build(stump)$layout$panel_scales_y[[1]]$range$range</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] -2.520820  4.170746</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] -1.999853  2.855805</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot_build(obj)$layout$panel_params[[1]]$x.range</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] -2.855398  4.505325</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot_build(obj)$layout$panel_params[[1]]$y.range</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] -2.242636  3.098588</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co"># reweighted data</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_ada)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co"># See this hack (https://stackoverflow.com/a/63024297) to ensure weights of 1/n have ggplot default size</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co"># here we have a ceiling weight value around 10</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>default_size <span class="ot">&lt;-</span> ggplot2<span class="sc">:::</span><span class="fu">check_subclass</span>(<span class="st">"point"</span>, <span class="st">"Geom"</span>)<span class="sc">$</span>default_aes<span class="sc">$</span>size</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>default_size_val <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>max_size <span class="ot">&lt;-</span> default_size<span class="sc">/</span>(<span class="fu">sqrt</span>(default_size_val<span class="sc">/</span><span class="dv">10</span>))</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co"># max_size &lt;- default_size/(sqrt(log1p(default_size_val)/log1p(10))) for log1p scale</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>(<span class="fu">ggplot</span>(data_ada <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">weight =</span> adaboost_M<span class="sc">$</span>weights[[tree_number <span class="sc">+</span> <span class="dv">1</span>]]<span class="sc">*</span>n,</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>                           <span class="at">misclass =</span> adaboost_M<span class="sc">$</span>classifiers[[tree_number ]]<span class="sc">!=</span>data_ada<span class="sc">$</span>Y), <span class="fu">aes</span>(<span class="at">x=</span>x1, <span class="at">y=</span>x2)) <span class="sc">+</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change observation size with weights at step tree_number (used for next fit)</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col=</span>Y, <span class="at">size=</span>weight)) <span class="sc">+</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># circle misclassified (in red) by current fit</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size=</span>weight, <span class="at">stroke=</span><span class="fu">if_else</span>(misclass,<span class="dv">1</span>,<span class="dv">0</span>)), <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">col=</span><span class="st">"red3"</span>, <span class="at">fill=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot stump decision surface</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_parttree</span>(<span class="at">data=</span>last_stump, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">fill=</span>Y), <span class="at">col =</span> <span class="cn">NA</span>, <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_parttree</span>(<span class="at">data =</span> last_stump, <span class="at">flip =</span> variable_split<span class="sc">==</span><span class="st">"x2"</span>) <span class="sc">+</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'colour'</span>, <span class="st">'fill'</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># playing with size scale (max_size) we ensure a weight of 1/n has size 1.5 (ie ggplot default size)</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, max_size), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">guide=</span><span class="st">'none'</span>) <span class="sc">+</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)) <span class="sc">+</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>( <span class="at">size=</span><span class="st">"none"</span>, <span class="at">strike=</span><span class="st">"none"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-51-2.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>grid_precision <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>, grid_precision), <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.25</span>, <span class="fl">3.1</span>, grid_precision)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid, <span class="fu">tibble</span>(<span class="at">predict_ADA =</span> <span class="fu">predict_original_adaboost</span>(adaboost_M, grid, <span class="at">num_tree =</span> tree_number))) <span class="sc">%&gt;%</span> </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">predict_ADA =</span> <span class="fl">0.5</span> <span class="sc">*</span> (predict_ADA <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>(ada_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> grid_precision, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_ADA),</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">-</span>grid_precision, <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_ADA), <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span><span class="sc">-</span>grid_precision,<span class="dv">2</span>), <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-1"</span>, <span class="st">"1"</span>),</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>                       <span class="co"># guide="legend",</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))), <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y), <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>),</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># guide="legend",</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"-1"</span>, <span class="st">"1"</span>)) <span class="sc">+</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">size=</span><span class="fl">0.5</span>),</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">stroke=</span><span class="st">"none"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-51-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We show below decision boundaries at different steps (ie number of fitted trees <span class="math inline">\(M\)</span>) of AdaBost algorithm:</p>
<ul>
<li><span class="math inline">\(M=3\)</span></li>
</ul>
<div class="cell">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3039</code></pre>
</div>
</div>
<ul>
<li><span class="math inline">\(M=50\)</span></li>
</ul>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-53_ba41333e5ecd2fc525e6dad248add5c3">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2486</code></pre>
</div>
</div>
<ul>
<li><span class="math inline">\(M=200\)</span></li>
</ul>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-54_33a29033a662bddb662f7284c9131d09">
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2626</code></pre>
</div>
</div>
</section>
<section id="derivation-of-adaboost-statistical-view" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="derivation-of-adaboost-statistical-view"><span class="header-section-number">2.2</span> Derivation of AdaBoost: statistical view</h2>
<p>In <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span>, authors derive AdaBoost as a Forward Stagewise Additive Model (FSAM) that minimizes the exponential loss. They also develop the approach in <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> (Chapter 10, Boosting and Additive Trees). Below we summarize the explanation found in both <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> and <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span>.</p>
<section id="adaboost-fits-an-additive-model" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="adaboost-fits-an-additive-model"><span class="header-section-number">2.2.1</span> AdaBoost fits an additive model</h3>
<p>First the authors remark that the Adaboost classifier after <span class="math inline">\(M\)</span> iterations can be written to a “basis” function expansion or additive model:</p>
<p><span class="math display">\[
H(x) = \text{sign}(f_M(x))
\]</span></p>
<p>where:</p>
<p><span class="math display">\[
f_M(x) = \sum_{m=1}^M \alpha_m h(x,\gamma_m)
\]</span></p>
<p><span class="math inline">\(\alpha\)</span> are the expansion coefficients or weights and <span class="math inline">\(h(x,\gamma_m)\)</span> are the “basis” functions or “learners”, usually “simple” functions of <span class="math inline">\(x\)</span> parameterized by <span class="math inline">\(\gamma\)</span>.</p>
<p>We can express <span class="math inline">\(f\)</span> iteratively as:</p>
<p><span class="math display">\[
f_m(x) = f_{m-1}(x) + \alpha_m h(x,\gamma_m)
\]</span></p>
<p>For example “learners” can be decision trees as seen before, where <span class="math inline">\(\gamma\)</span> refers to split variables/thresholds and leaf values.</p>
<p>Such additive models are fitted by minimizing a loss function of the training data <span class="math inline">\(L(y,f(x))\)</span>:</p>
<p><span class="math display">\[
\underset{\{\alpha_m, \gamma_m\}_1^M}{\operatorname{min}}\sum_{i=1}^n L(y_i,\sum_{m=1}^M \alpha_m h(x_i,\gamma_m))
\]</span></p>
<p>Such optimization is in general intractable. A “greedy” approach is usually taken to approximate a solution.</p>
</section>
<section id="forward-stagewise-additive-model-fsam" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="forward-stagewise-additive-model-fsam"><span class="header-section-number">2.2.2</span> Forward Stagewise Additive Model (FSAM)</h3>
<p>To simplify the preceding optimization, a “forward stagewise” or “greedy” approach is taken.</p>
<p>At a given iteration <span class="math inline">\(m\)</span>, the expansion <span class="math inline">\(f_{m-1}\)</span> is fixed and we only optimize the weights <span class="math inline">\(\alpha_m\)</span> and current “learner” parameters <span class="math inline">\(\gamma_m\)</span>. <span class="math inline">\(f_{m}\)</span> is obtained and the procedure repeats. Note that in the next step <span class="math inline">\(f_{m}\)</span> is fixed and we only optimize the weights and parameters for learner <span class="math inline">\(m+1\)</span>.</p>
</section>
<section id="adaboost-fits-a-fsam-for-exponential-loss" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="adaboost-fits-a-fsam-for-exponential-loss"><span class="header-section-number">2.2.3</span> AdaBoost fits a FSAM for exponential loss</h3>
<p>The authors then define or introduce the exponential loss:</p>
<p><span class="math display">\[
L(y,f(x)) = \exp(-yf(x)) = \exp(-\text{margin})
\]</span></p>
<p>Given a classifier <span class="math inline">\(f(x)\)</span> with values in <span class="math inline">\(\{-1,1\}\)</span>, it is usual to define the margin as <span class="math inline">\(yf(x)\)</span>.</p>
<p>The authors show next that AdaBoost is equivalent to fitting FSAM for the exponential loss.</p>
<p>They consider the problem:</p>
<p><span class="math display">\[
\begin{aligned}
(\alpha_m, \gamma_m) &amp;=\underset{\{\alpha, \gamma\}}{\operatorname{argmin}}\sum_{i=1}^n \exp(-y_i f_m(x_i))  \\
                              &amp;=\underset{\{\alpha, \gamma\}}{\operatorname{argmin}}\sum_{i=1}^n \exp(-y_i(f_{m-1}(x_i) + \alpha h(x_i,\gamma)) \\
                              &amp;= \underset{\{\alpha, \gamma\}}{\operatorname{argmin}}\sum_{i=1}^n \omega_{m,i}\exp(-y_i \alpha h(x_i,\gamma))
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\omega_{m,i}=\exp(-y_i f_{m-1}(x_i))\)</span> acts as a weight and does not depend on <span class="math inline">\((\alpha, \gamma)\)</span>.</p>
<p>The last expression rewrites:</p>
<p><span class="math display">\[
\begin{aligned}
\sum_{i=1}^n \omega_{m,i}\exp(-y_i \alpha h(x_i,\gamma)) &amp;=e^{-\alpha}\sum_{i=1}^n \omega_{m,i}\mathbf 1_{y_i=h(x_i,\gamma)}+ e^{\alpha}\sum_{i=1}^n \omega_{m,i} 1_{y_i\neq h(x_i,\gamma)}\\
&amp;= (e^{\alpha}-e^{-\alpha})\sum_{i=1}^n \omega_{m,i} 1_{y_i\neq h(x_i,\gamma)} + e^{-\alpha}\sum_{i=1}^n \omega_{m,i}\\
&amp;= (e^{\alpha}-e^{-\alpha})\Omega_{m,err} + e^{-\alpha}\Omega_{m}
\end{aligned}
\]</span></p>
<p>Having in mind that the term <span class="math inline">\(\Omega_m =\sum_{i=1}^n \omega_{m,i}\)</span> does not depend on <span class="math inline">\((\alpha, \gamma)\)</span>, for any <span class="math inline">\(\alpha&gt;0\)</span> we have <span class="math inline">\(e^{\alpha}-e^{-\alpha}&gt;0\)</span>, so solving for <span class="math inline">\(\gamma\)</span> the problem:</p>
<p><span class="math display">\[
\begin{aligned}
\gamma_m &amp;=\underset{\gamma}{\operatorname{argmin}}\sum_{i=1}^n \exp(-y_i f_m(x_i)) \\
           &amp;=\underset{\gamma}{\operatorname{argmin}}(e^{\alpha}-e^{-\alpha})\sum_{i=1}^n \omega_{m,i} 1_{y_i\neq h(x_i,\gamma)} + e^{-\alpha_m}\Omega_{m}
\end{aligned}
\]</span></p>
<p>is equivalent to solving:</p>
<p><span class="math display">\[\begin{aligned}
\gamma_m &amp;=\underset{\gamma}{\operatorname{argmin}}\sum_{i=1}^n \omega_{m,i} 1_{y_i\neq h(x_i,\gamma)}\\
         &amp;=\underset{\gamma}{\operatorname{argmin}}\Omega_{m,err}
\end{aligned}
\]</span></p>
<p>which does not depend on <span class="math inline">\(\alpha_m\)</span>.</p>
<p>This problem is specific to the base learners <span class="math inline">\(h(x, \gamma)\)</span> at stake, but amounts to solving a weighted (with <span class="math inline">\(\omega_{m,i}\)</span>) classification problem.</p>
<p>For example when <span class="math inline">\(h(x, \gamma)\)</span> are decision trees, we obtain <span class="math inline">\(\gamma_m\)</span> by fitting a tree on the weighted training data.</p>
<p>Having minimized <span class="math inline">\(\Omega_{m,err}\)</span> with respect to <span class="math inline">\(\gamma\)</span> (ie having fitted the learner), the <span class="math inline">\(m\text{-th}\)</span> iteration of FSAM is then solved by minimizing with respect to <span class="math inline">\(\alpha\)</span>:</p>
<p><span class="math display">\[
(e^{\alpha}-e^{-\alpha})\Omega_{m,err} + e^{-\alpha}\Omega_{m}
\]</span></p>
<p>Taking the derivative with respect to <span class="math inline">\(\alpha\)</span> of this expression (for <span class="math inline">\(\alpha&gt;0\)</span> the expression is convex in <span class="math inline">\(\alpha\)</span>), we seek:</p>
<p><span class="math display">\[
\begin{aligned}
0 &amp;=\alpha(e^{\alpha}+e^{-\alpha})\Omega_{m,err} -\alpha e^{-\alpha}\Omega_{m}\\
         &amp;\Leftrightarrow \\
0  &amp;=(e^{2\alpha}+1)\Omega_{m,err} -\Omega_{m} \\
         &amp;\Leftrightarrow \\
\alpha  &amp;=\frac{1}{2}\log(\frac{\Omega_{m}}{\Omega_{m,err}}-1) \\
        &amp;=\frac{1}{2}\log(\frac{1-\epsilon_{m}}{\epsilon_{m}})
\end{aligned}
\]</span></p>
<p>where:</p>
<p><span class="math display">\[
\epsilon_{m}=\frac{\Omega_{m,err}}{\Omega_{m}}= \frac{\sum_{i=1}^n \omega_{m,i} 1_{y_i\neq h(x_i,\gamma_m)}}{\sum_{i=1}^n \omega_{m,i}}
\]</span></p>
<p>is a weighted misclassification error.</p>
<p>Finally authors retrieve the expression of the weights in AdaBoost Algorithm 1.1 <span class="math inline">\(\alpha_m=\frac{1}2{}\log(\frac{1-\epsilon_{m}}{\epsilon_{m}})\)</span> from <span class="citation" data-cites="boosting2012">Schapire and Freund (<a href="#ref-boosting2012" role="doc-biblioref">2012</a>)</span>.</p>
<p>In all the derivation they have assumed that <span class="math inline">\(\alpha&gt;0\)</span>.</p>
<p>Looking at the AdaBoost expression of <span class="math inline">\(\alpha_m\)</span> we see that it is equivalent to having <span class="math inline">\(\epsilon_{m}&lt;\frac{1}{2}\)</span>. This means that learner at step <span class="math inline">\(m\)</span> has to be better then random. If by any chance <span class="math inline">\(\epsilon_{m}&gt;\frac{1}{2}\)</span> for <span class="math inline">\(h(x,\gamma_m)\)</span>, one could take <span class="math inline">\(-h(x,\gamma_m)\)</span> as the classifier.</p>
<p>We now look at the update of weights <span class="math inline">\(\omega_{m+1,i}=\exp(-y_i f_{m}(x_i))\)</span> after this step, we have the recursion:</p>
<p><span class="math display">\[
\omega_{m+1,i}=\omega_{m,i}\exp(-y_i \alpha_m h(x_i,\gamma_m))
\]</span></p>
<p>which looks like the weight in <span class="citation" data-cites="boosting2012">Schapire and Freund (<a href="#ref-boosting2012" role="doc-biblioref">2012</a>)</span> Algorithm 1.1:</p>
<p>It can be rewritten as in <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> (Algorithm 10.1), defining <span class="math inline">\(\hat\alpha_m=2\alpha_m=\log(\frac{1-\epsilon_{m}}{\epsilon_{m}})\)</span>:</p>
<p><span class="math display">\[
\omega_{m+1,i}=\omega_{m,i}\exp(\hat\alpha_m 1_{y_i\neq h(x_i,\gamma_m)})\exp(-\frac{\hat\alpha_m}{2})
\]</span></p>
<p>using the fact that <span class="math inline">\(-y_i h(x_i,\gamma_m) =2\times1_{y_i\neq h(x_i,\gamma_m)})+1\)</span>.</p>
<p>In the implementation of AdaBoost algorithm proposed before <code>fit_original_adaboost</code>, we tested both <span class="citation" data-cites="boosting2012">Schapire and Freund (<a href="#ref-boosting2012" role="doc-biblioref">2012</a>)</span> and <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> formulations which perform identically.</p>
<p>Note that this FSAM view of AdaBoost was derived years after the original AdaBoost algorithm was proposed.</p>
<p>Motivations and justifications of the original algorithm were not directly linked to an optimization / minimization of risk problem, see for example <span class="citation" data-cites="boosting2012">Schapire and Freund (<a href="#ref-boosting2012" role="doc-biblioref">2012</a>)</span> for more details. Anyway, the use of exponential function in the algorithm has allowed tractable formulas as seen before for example to express simple recursions.</p>
</section>
<section id="loss-functions-for-binary-classification-margin" class="level3" data-number="2.2.4">
<h3 data-number="2.2.4" class="anchored" data-anchor-id="loss-functions-for-binary-classification-margin"><span class="header-section-number">2.2.4</span> Loss functions for binary classification / margin</h3>
<section id="theoretical-minimizer-for-exponential-loss" class="level4" data-number="2.2.4.1">
<h4 data-number="2.2.4.1" class="anchored" data-anchor-id="theoretical-minimizer-for-exponential-loss"><span class="header-section-number">2.2.4.1</span> Theoretical minimizer for exponential loss</h4>
<p>Having revealed this FSAM view of AdaBoost for a specific loss function, the exponential loss, the authors of <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> started to assess if alternative loss functions could be used instead.</p>
<p>First they try to understand what optimum function is approximated by the AdaBoost approach and show that the function that minimizes the risk for the exponential loss is (see exercise 10.2 of <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> or <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> for a proof):</p>
<p><span class="math display">\[
\begin{aligned}
f^*(x)&amp;=\underset{f}{\operatorname{argmin}}\mathbb{E}[\ell(Y,f(x))|x]\\
      &amp;=\underset{f}{\operatorname{argmin}}\mathbb{E}[e^{-Yf(x)}|x] \\
      &amp;=\frac{1}{2}\log(\frac{\mathbb{P}[Y=1|X=x)]}{\mathbb{P}[Y=-1|X=x)]})
\end{aligned}
\]</span></p>
<p>So the <span class="math inline">\(f_M\)</span> estimated by AdaBoost approximates half the log odds of the data generating distribution <span class="math inline">\(\mathbf P_{\mathrm X \times \mathrm Y}\)</span>.</p>
<p>Conversely: <span class="math inline">\(\mathbb{P}[Y=1|X=x)]=\frac{e^{f^{*}(x)}}{e^{-f^{*}(x)}+e^{f^{*}(x)}}=\frac{1}{1+e^{-2f^{*}(x)}}\)</span></p>
</section>
<section id="convex-surrogates-for-0-1-loss" class="level4" data-number="2.2.4.2">
<h4 data-number="2.2.4.2" class="anchored" data-anchor-id="convex-surrogates-for-0-1-loss"><span class="header-section-number">2.2.4.2</span> Convex surrogates for 0-1 loss</h4>
<p>The following is again better developed in <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009, chap. 10.6</a> Loss Functions and Robustness, p.&nbsp;346-349)</span>.</p>
<p>As we have seen before for the exponential loss, we can rewrite loss functions for binary classification in terms of margin. Given a classifier <span class="math inline">\(f(x)\)</span> in <span class="math inline">\(\{-1,1\}\)</span>, margin is defined as <span class="math inline">\(yf(x)\)</span>.</p>
<p>We display below loss functions for binary classification expressed in terms of margin:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>losses <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">margin =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">3.5</span>, <span class="fl">3.5</span>, <span class="at">length.out=</span><span class="dv">1000</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">0-1 loss</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(margin<span class="sc">&lt;</span><span class="dv">0</span>),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">Logistic =</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>margin)),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">Hinge =</span> <span class="fu">pmax</span>(<span class="dv">1</span><span class="sc">-</span>margin, <span class="dv">0</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># rescaled to be 1 at 0</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">Logistic =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>margin)), </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># Logistic = log(1 + exp(-margin)),</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">Exponential =</span> <span class="fu">exp</span>(<span class="sc">-</span>margin),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">Square =</span> (<span class="dv">1</span><span class="sc">-</span>margin)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pivot_longer</span>(<span class="sc">!</span>margin, <span class="at">names_to =</span> <span class="st">"Loss"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(losses, <span class="fu">aes</span>(<span class="at">x=</span>margin, <span class="at">y=</span>value, <span class="at">color=</span>Loss)) <span class="sc">+</span> </span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"margin=y.f(x)"</span>) <span class="sc">+</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Loss(margin)"</span>) <span class="sc">+</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Dark2"</span>) <span class="sc">+</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The loss functions assign small values to positive margins (ie correct classifications) and large values to negative margins (ie wrong classifications).</p>
<p>Note that the Logistic loss has been “rescaled” by <span class="math inline">\(log(2)\)</span> so that its value is <span class="math inline">\(1\)</span> for <span class="math inline">\(margin=0\)</span>.</p>
<p>Both exponential and logistic loss give convex upper bounds on the 0-1 loss. Also the authors remark that the two loss functions are very close when the margin is positive (ie no error). However, they diverge when the margin is negative (ie for large error), with exponential loss growing exponentially and logistic loss growing only linearly. Quoting the authors [chap.&nbsp;10.6 Loss Functions and Robustness, p.&nbsp;347-348]:</p>
<p>“At any point in the training process the exponential criterion concentrates much more influence on observations with large negative margins. Binomial deviance (ie logistic loss) concentrates relatively less influence on such observations more evenly spreading the influence among all of the data. It is therefore far more robust in noisy settings where the Bayes error rate is not close to zero, and especially in situations where there is misspecification of the class labels in the training data. The performance of AdaBoost has been empirically observed to dramatically degrade in such situations.”</p>
<p>This remark suggests that logistic loss could be somewhat better behaved in some settings and push the authors to investigate further this loss.</p>
<p>A key concept in machine learning is the use of convex surrogate losses, where we replace the 0-1 loss or misclassification by another loss allowing to perform numerical optimization (due to convexity). Outside the scope of this course: one can show that for binary classification, optimal predictions can be achieved with convex surrogates of the 0–1 loss (see for example <span class="citation" data-cites="bartlett2006">Bartlett, Jordan, and Mcauliffe (<a href="#ref-bartlett2006" role="doc-biblioref">2006</a>)</span> or Francis Bach - Learning Theory from First Principles (Chapter 4)).</p>
</section>
<section id="another-view-on-logistic-loss" class="level4" data-number="2.2.4.3">
<h4 data-number="2.2.4.3" class="anchored" data-anchor-id="another-view-on-logistic-loss"><span class="header-section-number">2.2.4.3</span> Another view on logistic loss:</h4>
<p>In a previous document (<code>3_wrds_lasso.html</code> Section <code>Estimation/Logistic Regression as a machine learning approach</code>) we briefly saw that maximizing the log-likelihood for the Logistic Regression model was equivalent to minimizing the Risk for a specific loss (the logistic loss, written as minus the log-likelihood).</p>
<p>Having modeled <span class="math inline">\(p_\beta(x)=\mathbb{P}[Y=1|X=x)]\)</span> as <span class="math inline">\(p_\beta(x)=\sigma(x^T\beta)=\frac{e^{x^{T} \beta}}{1+e^{x^{T} \beta}}\)</span> the problem was to maximize the log likelihood on the observations which was equivalent to minimizing the empirical Risk for the logistic loss:</p>
<p><span class="math display">\[
\begin{aligned}
\ell(Y,\beta)=\log L(Y,\beta) &amp;=\sum_{i=1}^n \left(y_i \log(p_{\beta}(x_i))+(1-y_i) \log(1- p_{\beta}(x_i))\right) \\
                              &amp;=-\sum_{i=1}^{n} \ell_{logistic} \left(p_{\beta}(x_i),y_i\right) \\
                              &amp;= -n\hat{\mathrm R}(p_\beta)
\end{aligned}
\]</span></p>
<p><span class="math display">\[
\ell_{logistic}(y,\eta(x)) = -y\log(\eta(x))-(1-y)\log(1-\eta(x))=\left\{ \begin{array}{ll}
    -\log(\eta) &amp;  \mbox{if } y = 1\cr
    -\log(1-\eta) &amp;  \mbox{if } y = 0\cr
\end{array} \right.
\]</span></p>
<p>In <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> the authors parameterize or link the binomial probabilities using <span class="math inline">\(f\)</span> by:</p>
<p><span class="math display">\[
p(x)=\frac{e^{f(x)}}{e^{f(x)}+e^{-f(x)}}=\frac{1}{1+e^{-2f(x)}}
\]</span></p>
<p>which is slighlty different but similar than the standard logistic regression model:</p>
<p><span class="math display">\[
p_{\beta}(x)=\sigma(x^T\beta) = \frac{e^{x^T\beta}}{1+e^{x^T\beta}} = \frac{e^{f(x,\beta)}}{1+e^{f(x,\beta)}} = \frac{1}{1+e^{-f(x,\beta)}}  
\]</span></p>
<p>Then they rewrite <span class="math inline">\(Y' = \frac{Y+1}{2} \in \{0, 1\}\)</span> for <span class="math inline">\(Y \in \{-1, 1\}\)</span>, so that:</p>
<p><span class="math display">\[\begin{aligned}
\ell_{logistic}(Y',p(x)) &amp;= -Y'\log(p(x))-(1-Y')\log(1-p(x)) \\
                         &amp;= Y'\log(1+e^{-2f(x)})+(1-Y')\log(1+e^{2f(x)}) \\
                         &amp;= (\frac{Y+1}{2})\log(1+e^{-2f(x)})-(\frac{Y-1}{2})\log(1+e^{2f(x)}) \\
\end{aligned}
\]</span></p>
<p>and finally:</p>
<p><span class="math display">\[
\ell_{logistic}(Y',p(x))=\left\{ \begin{array}{ll}
    \log(1+e^{-2f(x)}) &amp;  \mbox{if } Y = 1\cr
    \log(1+e^{2f(x)}) &amp;  \mbox{if } Y= -1\cr
\end{array} = \log(1+e^{-2Yf(x)})\right.
\]</span></p>
<!---
https://stats.stackexchange.com/questions/609727/what-is-the-algebra-showing-the-logistic-and-log-loss-to-be-equivalent
--->
<p>This slightly different parameterization, is introduced by the authors so that <span class="math inline">\(f\)</span> minimizing the Risk for logistic loss is minimizing half the log-odds of <span class="math inline">\(p\)</span> (as shown before for AdaBoost with exponential loss):</p>
<p><span class="math display">\[
\begin{aligned}
f^*(x)&amp;=\underset{f}{\operatorname{argmin}}\mathbb{E}[\ell_{logistic}(Y,f(x))|x]\\
      &amp;=\underset{f}{\operatorname{argmin}}\mathbb{E}[\log(1+e^{-2Yf(x)})|x] \\
      &amp;=\frac{1}{2}\log(\frac{\mathbb{P}[Y=1|X=x)]}{\mathbb{P}[Y=-1|X=x)]})
\end{aligned}
\]</span></p>
</section>
</section>
</section>
<section id="introducing-logitboost-algorithm" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="introducing-logitboost-algorithm"><span class="header-section-number">2.3</span> Introducing LogitBoost algorithm</h2>
<p>We take here a more general approach than in the <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> article, inspired by the excellent and pedagogical introduction in <span class="citation" data-cites="xgboost2016">Chen and Guestrin (<a href="#ref-xgboost2016" role="doc-biblioref">2016</a>)</span> (also available online <a href="https://xgboost.readthedocs.io/en/stable/tutorials/model.html">here</a>). Notations have been adapted.</p>
<p>We remind that we want to estimate an additive model of the form (for a better reading we have simplified the preceding notation <span class="math inline">\(f_m(x)=\alpha_m h(x_i,\gamma_m)\)</span>):</p>
<p><span class="math display">\[
f^M(x) = \sum_{m=1}^M f_m(x)
\]</span></p>
<p>Such additive models are fitted by minimizing a loss function of the training data <span class="math inline">\(\ell(y,f(x))\)</span>:</p>
<p><span class="math display">\[
\underset{\{f_m\}_1^M}{\operatorname{min}}\sum_{i=1}^n \ell(y_i,\sum_{m=1}^M f_m(x_i))
\]</span></p>
<p>Such optimization is in general intractable. A “greedy” approach is usually taken to approximate a solution. At a given iteration <span class="math inline">\(m\)</span>, the expansion up to <span class="math inline">\(f_{m-1}\)</span> is fixed and we only optimize current “learner” <span class="math inline">\(f_{m}\)</span> parameters. <span class="math inline">\(f_{m}\)</span> is obtained and the procedure repeats.</p>
<p>Assuming we are at the step <span class="math inline">\(t \leq M\)</span> of iteration, we have: <span class="math display">\[
f^t(x) = \sum_{m=1}^t f_m(x)=f^{t-1}(x)+f_{t}(x)
\]</span> Having estimated and fixed <span class="math inline">\(f^{t-1}\)</span>, we want to minimize:</p>
<p><span class="math display">\[
\begin{aligned}
\mathcal{L}_{\ell}^{t} &amp;=\sum_{i=1}^n \ell(y_i,f^{t}(x_i))\\
                              &amp;=\sum_{i=1}^n \ell(y_i,f^{t-1}(x_i)+f_{t}(x_i))
\end{aligned}
\]</span> For some losses (ie Mean Squared Error), the preceding expression simplifies and allows for direct solving. In general to minimize <span class="math inline">\(\mathcal{L}_{\ell}^{t}\)</span> we expand the expression up to the second order in <span class="math inline">\(f_t\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
\mathcal{L}_L^{t} &amp;=\sum_{i=1}^n \ell(y_i,f^{t-1}(x_i)+f_{t}(x_i)) \\
                  &amp;\approx  \sum_{i=1}^n[\ell(y_i,f^{t-1}(x_i))+ g_i f_t(x_i) + \frac{1}{2} h_i f_t^2(x_i)] \\
                  &amp;= \mathcal{L}_{\ell}^{t-1} + \sum_{i=1}^n[g_i f_t(x_i) + \frac{1}{2} h_i f_t^2(x_i)]
\end{aligned}
\]</span></p>
<p>where:</p>
<p><span class="math display">\[
g_i = \left. \frac{\partial \ell(y_i, f_i)}{\partial f_i} \right\vert_{f_i=f^{t-1}(x_i)}
\]</span></p>
<p>and:</p>
<p><span class="math display">\[
h_i = \left. \frac{\partial^2 \ell(y_i, f_i)}{\partial^2 f_i} \right\vert_{f_i=f^{t-1}(x_i)}
\]</span> Completing the square, this rewrites:</p>
<p><span class="math display">\[
\begin{aligned}
\mathcal{L}_{\ell}^{t} &amp;\approx \mathcal{L}_{\ell}^{t-1} + \sum_{i=1}^n[g_i f_t(x_i) + \frac{1}{2} h_i f_t^2(x_i)] \\
                  &amp;= \mathcal{L}_{\ell}^{t-1} + \sum_{i=1}^n\frac{1}{2} h_i[2 \frac{g_if_t(x_i)}{h_i} + f_t^2(x_i)] \\
                  &amp;= \mathcal{L}_{\ell}^{t-1} + \sum_{i=1}^n\frac{1}{2} h_i[\frac{g_i}{h_i} + f_t(x_i)]^2 - (\frac{g_i}{h_i})^2 \\
                  &amp;= \mathcal{L}_{\ell}^{t-1} + \sum_{i=1}^n\frac{1}{2} h_i[-\frac{g_i}{h_i} - f_t(x_i)]^2 - (\frac{g_i}{h_i})^2
\end{aligned}
\]</span> Having fixed <span class="math inline">\(f^{t-1}\)</span>, minimizing <span class="math inline">\(\mathcal{L}_{\ell}^{t}\)</span> in <span class="math inline">\(f_t\)</span> is equivalent to solve: <span class="math display">\[
f_t^*=\underset{f_t}{\operatorname{argmin}}\sum_{i=1}^n\frac{1}{2} h_i[-\frac{g_i}{h_i} - f_t(x_i)]^2
\]</span></p>
<p>where we recognize a weighted least square regression problem.</p>
<p>In particular for the logistic loss and parameterization introduced in <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span>:</p>
<p><span class="math display">\[
p(x)=\frac{e^{f(x)}}{e^{f(x)}+e^{-f(x)}}=\frac{1}{1+e^{-2f(x)}}
\]</span></p>
<p>Denoting <span class="math inline">\(Y' = \frac{Y+1}{2} \in \{0, 1\}\)</span> for <span class="math inline">\(Y \in \{-1, 1\}\)</span>: <span class="math display">\[
\begin{aligned}
\ell_{logistic}(Y',p(x))&amp;=-Y'\log(p(x))-(1-Y')\log(1-p(x))\\
                        &amp;=2Y'\log(\frac{p(x)}{1-p(x)})+\log(1-p(x))\\
                        &amp;=2Y'f(x)-\log(1+e^{2f(x)})\\
&amp;\Leftrightarrow\\
\ell_{logistic}(Y,f(x)) &amp;= \log(1+e^{-2Yf(x)})
\end{aligned}
\]</span> we derive (with similar calculus as for the Logistic regression score/hessian derivation): <span class="math display">\[
\begin{aligned}
g_i = \left.\frac{\partial \ell(y_i, f_i)}{\partial f_i}\right\vert_{f_i=f(x_i)}  &amp;= 2(y_i-\frac{exp(2f(x_i)}{1+exp(2f(x_i))}) \\
                                                                                  &amp;=2(y_i-\frac{1}{1+exp(-2f(x_i))}) \\
                                                                                  &amp;=2(y_i-p(x_i))
\end{aligned}
\]</span></p>
<p>and</p>
<p><span class="math display">\[
\begin{aligned}
h_i = \left.\frac{\partial^2 \ell(y_i, f_i)}{\partial^2 f_i}\right\vert_{f_i=f(x_i)}  &amp;= \frac{-2\times-2exp(-2f(x_i))}{(1+exp(-2f(x_i)))^2}\\
                                                                                      &amp;= 4 \times \frac{1}{(1+exp(-2f(x_i))} \times \frac{exp(-2f(x_i))}{(1+exp(-2f(x_i))}\\
                                                                                      &amp;= 4\times p(x_i)(1-p(x_i))
\end{aligned}
\]</span></p>
<p>This corresponds to the sketch of proof given in <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> for the derivation of LogitBoost algorithm (the authors work on the population, while we work on sample):</p>
<p><img src="../images/fht_newton_step.png" class="img-fluid" data-fig-align="center"> The authors see the problem as a minimization using a “Newton step” or Newton method (similarly as what is done to get Logistic regression coefficients).</p>
<p>Plugging <span class="math inline">\(g_i\)</span> and <span class="math inline">\(h_i\)</span> obtained before in our minimization problem:</p>
<p><span class="math display">\[
f_t^*=\underset{f_t}{\operatorname{argmin}}\sum_{i=1}^n\frac{1}{2} h_i[-\frac{g_i}{h_i} - f_t(x_i)]^2
\]</span> we retrieve the proposed LogitBoost algorithm in <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/logitboost_algo.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>In practice the weighted least-square regression step is often performed using a weighted version of Decision tree for Regression (Gradient/Newton Boosted Trees).</p>
<p>We re-implement from scratch this algorithm in section <a href="#sec-logitboost_imp">Section&nbsp;2.7.1</a>, using depth 1 decision trees also called stumps.</p>
<p>Note that the Original version of LogitBoost algorithm experienced numerical issues.</p>
<p>Because the target of weighted least-square has <span class="math inline">\(p(x_i)(1-p(x_i)\)</span> at its denominator (due to the “Newton step”).</p>
<p>When predicted probabilities <span class="math inline">\(p(x_i)\)</span> are close to 0 or 1, numerical errors can occur:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/logitboost_explode1.png" class="img-fluid figure-img"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/logitboost_explode2.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>This led to the introduction of optimization methods using only the gradients <span class="math inline">\(g_i\)</span> to avoid such issues. In <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span> Friedman introduces the concept of numerical optimization (ie Gradient descent) in “function space” to solve the general problem, coining the term Gradient Boosting machines. See the original article for a full introduction, or the excellent but very dense/long Master Thesis <span class="citation" data-cites="nielsen2016">Nielsen (<a href="#ref-nielsen2016" role="doc-biblioref">2016</a>)</span>, some elements are given in section <a href="#sec-gradboost">Section&nbsp;2.5</a>, and the Gradient Boosting machine version of LogitBoost, the so-called MART, is implemented in <a href="#sec-gradboost_imp">Section&nbsp;2.7.2</a>.</p>
<p>In the next section we will see how to use LogitBoost algorithm with Decision Trees for Regression (Gradient), and in particular a clever implementation introduced in <span class="citation" data-cites="pingli2010">Ping (<a href="#ref-pingli2010" role="doc-biblioref">2010</a>)</span> that led to the state of the art <code>xgboost</code> algorithm.</p>
</section>
<section id="gradientnewton-boosted-trees" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="gradientnewton-boosted-trees"><span class="header-section-number">2.4</span> Gradient/Newton Boosted Trees</h2>
<p>We detail below the simplifications that occur in LogitBoost algorithm, when implementing the weighted least-square step of LogitBoost using Decision Trees for Regression:</p>
<p><span class="math display">\[
f_t^*=\underset{f_t}{\operatorname{argmin}}\sum_{i=1}^n\frac{1}{2} h_i[-\frac{g_i}{h_i} - f_t(x_i)]^2
\]</span></p>
<p>Following <span class="citation" data-cites="xgboost2016">Chen and Guestrin (<a href="#ref-xgboost2016" role="doc-biblioref">2016</a>)</span>, in order to do so, we denote the definition/parameterization of a given Decision tree <span class="math inline">\(f(x)\)</span> as:</p>
<p><span class="math display">\[
f_t(x) = w_{q(x)}, w \in R^T, q:R^d\rightarrow \{1,2,\cdots,T\} .
\]</span></p>
<p>where <span class="math inline">\(w\)</span> is the vector of scores on leaves, <span class="math inline">\(q\)</span> is a function assigning each data point to the corresponding leaf, and <span class="math inline">\(T\)</span> is the number of leaves.</p>
<p><span class="math display">\[
\begin{aligned}
f_t^*&amp;=\underset{f_t}{\operatorname{argmin}}\sum_{i=1}^n[g_i f_t(x_i) + \frac{1}{2} h_i f_t^2(x_i)] \\
&amp;=\underset{f_t}{\operatorname{argmin}}\sum_{j=1}^T[(\sum_{i\in I_j}g_i) \omega_j + \frac{1}{2} (\sum_{i\in I_j}h_i) \omega_j^2]
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(I_j = \{i|q(x_i)=j\}\)</span> is the set of indices of data points assigned to the <span class="math inline">\(j-th\)</span> leaf.</p>
<p>Notice that in the second line autors of <span class="citation" data-cites="xgboost2016">Chen and Guestrin (<a href="#ref-xgboost2016" role="doc-biblioref">2016</a>)</span> have changed the index of the summation because all the data points on the same leaf get the same score. They further compress the expression by defining <span class="math inline">\(G_j = \sum_{i\in I_j} g_i\)</span> and <span class="math inline">\(H_j = \sum_{i\in I_j} h_i\)</span>:</p>
<p><span class="math display">\[
f_t^*=\underset{f_t}{\operatorname{argmin}}\sum_{j=1}^T[G_j \omega_j + \frac{1}{2} H_j \omega_j^2]
\]</span></p>
<p>In this equation, <span class="math inline">\(\omega_j\)</span> are independent with respect to each other, the form <span class="math inline">\(G_j \omega_j + \frac{1}{2} H_j \omega_j^2\)</span> is quadratic. The best <span class="math inline">\(\omega_j\)</span> for a given structure <span class="math inline">\(q\)</span> and the best objective reduction (ie impurity reduction measure) we can get is:</p>
<p><span class="math display">\[
\begin{aligned}
w_j^\ast &amp;= -\frac{G_j}{H_j}\\
\text{obj}^\ast &amp;= -\frac{1}{2} \sum_{j=1}^T \frac{G_j^2}{H_j}
\end{aligned}
\]</span></p>
<p>Going back to what we saw for the Decision Tree implementation, the splitting rule for the tree should maximize the gain (minimize the impurity):</p>
<p><span class="math display">\[
Gain = \frac{1}{2} \left[\frac{G_L^2}{H_L}+\frac{G_R^2}{H_R}-\frac{(G_L+G_R)^2}{H_L+H_R}\right]
\]</span> The preceding expression is equivalent to what was proposed years before in <span class="citation" data-cites="pingli2010">Ping (<a href="#ref-pingli2010" role="doc-biblioref">2010</a>)</span>, for the particular case of Logistic loss, to robustify the LogitBoost algorithm:</p>
<p><img src="../images/pingli_robust_score.png" class="img-fluid" data-fig-align="center"> We code <span class="citation" data-cites="pingli2010">Ping (<a href="#ref-pingli2010" role="doc-biblioref">2010</a>)</span> implementation in <a href="#sec-robust-logitboost_imp">Section&nbsp;2.7.4</a>, and show that it is exactly equivalent (same Trees, predictions) as the <code>xgboost</code> algorithm for Logistic loss without penalties or fancy parameters.</p>
</section>
<section id="sec-gradboost" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="sec-gradboost"><span class="header-section-number">2.5</span> (Logit)Boost as an optimisation method in “function space”</h2>
<!--- 
about functional
https://simple-complexities.github.io/optimization/functional/gradient/descent/2020/03/04/functional-gradient-descent.html
More on @gbm2001 https://ledaliang.github.io/journalclub/friedman.html--->
<p>[DRAFT], no strictly necessary for the study of LogitBoost/xgboost. More details in <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span> introducing the Gradient Boosting Machine algorithm, that coined the name Gradient Boosting. In particular to cope with the numerical errors due to “dividing by hessian” (<span class="math inline">\(p(1-p)\)</span>), Friedman replaced the Newton step of LogitBoost, with a Gradient/Line search step (a very good video from Friedman, Hastie and Tibshirani <a href="https://ledaliang.github.io/journalclub/friedman.html,%20about%20the%20genesis%20of%20Gradient%20Boosting">here</a>).</p>
<p>In <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span> Friedman introduces the concept of numerical optimization (ie Gradient descent) in “function space” to solve the general problem:</p>
<p><span class="math display">\[
f^*=\underset{f}{\operatorname{argmin}}\mathrm R(f)=\underset{f}{\operatorname{argmin}}\mathbb{E}[L(Y,f(X))]
\]</span></p>
<p>or for each <span class="math inline">\(x\)</span> in <span class="math inline">\(\mathrm X\)</span>:</p>
<p><span class="math display">\[
f^*(x)=\underset{f}{\operatorname{argmin}}\mathrm R(f(x))=\underset{f}{\operatorname{argmin}}\mathbb{E}[L(Y,f(x))\|X=x]
\]</span></p>
<p>and more practically at each point of the given training data <span class="math inline">\(x_i\)</span>, <span class="math inline">\(i = 1, \cdots ,n\)</span>.</p>
<p>Similarly to what we have seen with Forward Stagewise Additive Modeling we estimate <span class="math inline">\(f\)</span> iteratively as:</p>
<p><span class="math display">\[
f_m(x) = f_{m-1}(x) + f^{m}(x)
\]</span></p>
<p>with <span class="math inline">\(f^{m}(x)\)</span> a step in the function space, similar to a gradient boosting or Newton Raphson step in an usual iterative algorithm.</p>
<p>Indeed starting from an initial guess <span class="math inline">\(f^0\)</span>, one sequentially add steps: <span class="math display">\[
f_M(x) = \sum_{m=0}^M f^m(x)
\]</span></p>
<p>At the start of iteration <span class="math inline">\(m\)</span>, the current estimate is given by <span class="math inline">\(f_{m-1}\)</span>. At that “point” in function space, the direction to the steepest descent of the Risk we seek to minimize, is given by the opposite of the gradient with respect to <span class="math inline">\(f(x)\)</span>:</p>
<p><span class="math display">\[
\text{grad}^m(x)=\left.\frac{\partial\mathrm R(f)}{\partial f(x)}\right|_{f(x)=f_{m-1}(x)}=\left.\frac{\partial \mathbb{E}[L(Y,f(x))|X=x]}{\partial f(x)}\right|_{f(x)=f_{m-1}(x)} =  \mathbb{E} \left[\frac{\partial L(Y,f(x))}{\partial f(x)}|X=x\right]_{f(x)=f_{m-1}(x)}
\]</span></p>
<p>Friedman also introduces a step length or “learning rate” to take in the opposite direction of the gradient, this step is determined using “line search”, that is:</p>
<p><span class="math display">\[
\rho^m=\underset{\rho}{\operatorname{argmin}}\mathbb{E}[L(Y,f_{m-1}(x) -\rho \text{grad}^m(x)]
\]</span></p>
<p>giving a step <span class="math inline">\(f^m(x) =-\rho_m \text{grad}^m(x)\)</span></p>
<p>Similarly a Newton Raphson method in function space can be defined. The problem is solved at each step <span class="math inline">\(m\)</span>:</p>
<p><span class="math display">\[
\left.\frac{\partial \mathbb{E}[L(Y,f_{m-1}(x)+f^m(x))|X=x]}{\partial f^m(x)}\right.=0
\]</span> using a second-order expansion of <span class="math inline">\(\mathbb{E}[L(Y,f_{m-1}(x)+f^m(x))|X=x]\approx\mathbb{E}[L(Y,f_{m-1}(x)|X=x]+\text{grad}^m(x)f^m(x)+\frac{1}{2}\text{hessian}^m(x)f^m(x)^2\)</span></p>
<p>where hessian is:</p>
<p><span class="math display">\[
\text{hessian}^m(x)=\left.\frac{\partial^2\mathrm R(f)}{\partial f(x)^2}\right|_{f(x)=f_{m-1}(x)}=\left.\frac{\partial^2 \mathbb{E}[L(Y,f(x))|X=x]}{\partial f(x)^2}\right|_{f(x)=f_{m-1}(x)} =  \mathbb{E} \left[\frac{\partial^2 L(Y,f(x))}{\partial f(x)^2}|X=x\right]_{f(x)=f_{m-1}(x)}
\]</span> Thus:</p>
<p><span class="math display">\[
\left.\frac{\partial \mathbb{E}[L(Y,f_{m-1}(x)+f^m(x))|X=x]}{\partial f^m(x)}\right.\approx \text{grad}^m(x)+\text{hessian}^m(x)f^m(x)=0
\]</span> giving a Newton-Raphson step in function space:</p>
<p><span class="math display">\[
f^m(x) = -\frac{\text{grad}^m(x)}{\text{hessian}^m(x)}
\]</span></p>
</section>
<section id="additional-ressources-1" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="additional-ressources-1"><span class="header-section-number">2.6</span> Additional ressources</h2>
<p>For a more high level introduction see:</p>
<ul>
<li><p>A tutorial (available <a href="https://www.frontiersin.org/journals/neurorobotics/articles/10.3389/fnbot.2013.00021/full#B42">here</a>) giving an high level introduction to gradient boosting machines: Natekin, A. and Knoll, A. (2013). Gradient boosting machines, a tutorial.</p></li>
<li><p>The online and free course <a href="https://mlcourse.ai/book/topic10/topic10_gradient_boosting.html">mlcourse.ai</a> (with a step by step and intuitive explanation for a regression problem)</p></li>
<li><p><a href="https://arogozhnikov.github.io/2016/07/05/gradient_boosting_playground.html">this</a> excellent blog (with a javascript implementation of gradient/Newton Boosting running in you browser)</p></li>
</ul>
<p>For a more in depth coverage:</p>
<ul>
<li><p><span class="citation" data-cites="nielsen2016">Nielsen (<a href="#ref-nielsen2016" role="doc-biblioref">2016</a>)</span>, a very detailed master thesis, showing the difference between Gradient Boosting (see below the MART algorithm) and Newton Boosting (LogitBoost/xgboost), from theory to practice.</p></li>
<li><p><span class="citation" data-cites="boosting2019">(<a href="#ref-boosting2019" role="doc-biblioref"><strong>boosting2019?</strong></a>)</span>, a similar study comparing in depth Boosting algorithms and theory (covering Gradient/Newton Boosting and AdaBoost), made by actuaries, with a detailed binary classification case study in the end.</p></li>
<li><p><span class="citation" data-cites="sigrist2021">(<a href="#ref-sigrist2021" role="doc-biblioref"><strong>sigrist2021?</strong></a>)</span>, a similar study comparing in depth Gradient/Newton Boosting algorithms, with empirical results.</p></li>
</ul>
</section>
<section id="practical-implementations-of-logitboost" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="practical-implementations-of-logitboost"><span class="header-section-number">2.7</span> Practical Implementations of LogitBoost</h2>
<p>We give below three implementations of Gradient/Newton Boosted Trees:</p>
<ul>
<li><p>The Original LogitBoost algorithm as introduced in <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> (we show on a simple case that it behaves exactly as <code>xgboost</code>, note that numerical errors could occur if predicted probabilities for some observations were too close to 0 or 1),</p></li>
<li><p>The MART algorithm as introduced in <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span> which removes the Newton step to build the Decision Tree replacing it by a Gradient step (we show on a simple case that it behaves exactly as the <code>gbm</code> package); note that in the particular case of Logistic loss, the final value computed for the node leaf (ie the line search in Friedman GBM algorithm) uses a kind of Newton step (but the denominator is the sum of all <span class="math inline">\(p(1-p)\)</span> in the leaf, so it is less prone to numerical issues),</p></li>
<li><p>The Robust LogitBoost algorithm as introduced in <span class="citation" data-cites="pingli2010">Ping (<a href="#ref-pingli2010" role="doc-biblioref">2010</a>)</span> which is a very close ancestor to <code>xgboost</code> specific to the Logistic loss (we show on a simple case that it behaves exactly as <code>xgboost</code>); to implement this Robust version of LogitBoost, we use a Decision Tree for Regression implementing a “specialized” gain function (using gradient/hessian) to split, as <code>rpart</code> does not implement such a criteria, we use our own implementation of a Decision Tree.</p></li>
</ul>
<section id="sec-logitboost_imp" class="level3" data-number="2.7.1">
<h3 data-number="2.7.1" class="anchored" data-anchor-id="sec-logitboost_imp"><span class="header-section-number">2.7.1</span> Original LogitBoost</h3>
<p>We first start by implementing the original LogitBoost algorithm as described in <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/logitboost_algo.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>It is a Forward Stagewise Additive Method, at each iteration a Newton step is performed, in the context of Decision Trees, this step is equivalent to fitting a Regression Tree on weighted residuals.</p>
<p>We check our implementation against <code>xgboost</code> in the context where our weak learner is a stump (ie decision trees with maximum depth 1).</p>
<p>To do that, we ensure that <code>xgboost</code> is minimizing the logistic loss (<code>objective = "binary:logistic"</code>), and using stumps as weak learners (<code>max.depth = 1</code>), we also do not shrink the Gradient/Newton step (<code>eta = 1</code>) and do not use any penalties (see <a href="https://xgboost.readthedocs.io/en/stable/parameter.html">here</a> for more details on <code>xgboost</code> parameters).</p>
<p>We perform the comparison on the Mixture data set, for <span class="math inline">\(6\)</span> boosting iterations:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-57_d1940d5eff24be16b4c0146952209c05">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>num_tree <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Degenerate xgboost to compare with our implementation </span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (ie no penalty, using stumps and similar parameters)</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>xgb_deg <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2)),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">max.depth =</span> <span class="dv">1</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">eta =</span> <span class="dv">1</span>,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">nthread =</span> <span class="dv">1</span>,</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">nrounds =</span> num_tree,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># xgboost does not have a minbucket parameter (ie minimum of obs per leaf)</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># it allows to control the min weight in a leaf </span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># minimum sum of instance weight (hessian) needed in a child</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># to allow comparison we allow a 0 weight </span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># which will be compared with a minbucket of 1 in the rpart implementation</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_child_weight =</span> <span class="dv">0</span>, </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">objective =</span> <span class="st">"binary:logistic"</span>,</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="dv">0</span>,</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">tree_method =</span> <span class="st">"exact"</span>,</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">verbose =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We extract here the fitted trees/stumps decision rules and node predictions using <code>xgboost</code>:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-58_ac56a7feb49c990ce6a43451694023aa">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>xgb_trees <span class="ot">&lt;-</span> <span class="fu">xgb.dump</span>(xgb_deg, <span class="at">with_stats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>(xgb_clean_tree <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">stump =</span> xgb_trees[<span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">4</span><span class="sc">*</span>(num_tree<span class="dv">-1</span>) <span class="sc">+</span> <span class="dv">2</span>, <span class="dv">4</span>)],</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">left =</span> xgb_trees[<span class="fu">seq</span>(<span class="dv">3</span>, <span class="dv">4</span><span class="sc">*</span>(num_tree<span class="dv">-1</span>) <span class="sc">+</span> <span class="dv">3</span>, <span class="dv">4</span>)],</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">right =</span> xgb_trees[<span class="fu">seq</span>(<span class="dv">4</span>, <span class="dv">4</span><span class="sc">*</span>(num_tree<span class="dv">-1</span>) <span class="sc">+</span> <span class="dv">4</span>, <span class="dv">4</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">extract</span>(stump, <span class="fu">c</span>(<span class="st">"rule"</span>, <span class="st">"gain"</span>, <span class="st">"cover"</span>),</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">"0:</span><span class="sc">\\</span><span class="st">[(.+)</span><span class="sc">\\</span><span class="st">] yes</span><span class="sc">\\</span><span class="st">=1.*gain=(.*),cover=(.*)"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">extract</span>(left, <span class="fu">c</span>(<span class="st">"left_pred"</span>, <span class="st">"left_cover"</span>),</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"1:leaf=(.+),cover=(.*)"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">extract</span>(right, <span class="fu">c</span>(<span class="st">"right_pred"</span>, <span class="st">"right_cover"</span>),</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"2:leaf=(.+),cover=(.*)"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">left_pred =</span> <span class="fu">as.numeric</span>(left_pred),</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">right_pred =</span> <span class="fu">as.numeric</span>(right_pred)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["rule"],"name":[1],"type":["chr"],"align":["left"]},{"label":["gain"],"name":[2],"type":["chr"],"align":["left"]},{"label":["cover"],"name":[3],"type":["chr"],"align":["left"]},{"label":["left_pred"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["left_cover"],"name":[5],"type":["chr"],"align":["left"]},{"label":["right_pred"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["right_cover"],"name":[7],"type":["chr"],"align":["left"]}],"data":[{"1":"f1<0.144127041","2":"50.3118515","3":"50","4":"-1.6923077","5":"13","6":"0.5945946","7":"37"},{"1":"f1<0.92796278","2":"15.3671589","3":"40.7408447","4":"-0.7208678","5":"19.6596661","6":"0.5082014","7":"21.0811787"},{"1":"f0<2.00842214","2":"13.7423573","3":"35.0801315","4":"0.2841503","5":"29.5016251","6":"-1.4273592","7":"5.57850552"},{"1":"f0<0.991148889","2":"7.2006321","3":"32.8221512","4":"-0.4121352","5":"18.6063728","6":"0.5331278","7":"14.2157774"},{"1":"f0<-0.967202127","2":"8.66294575","3":"34.7944908","4":"1.5064100","5":"3.4753406","6":"-0.1577089","7":"31.319149"},{"1":"f1<-0.344325602","2":"3.37158489","3":"33.0037079","4":"-1.1271961","5":"2.26858115","6":"0.1360959","7":"30.7351265"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>xgb_clean_tree <span class="sc">%&gt;%</span> <span class="fu">select</span>(rule, left_pred, right_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["rule"],"name":[1],"type":["chr"],"align":["left"]},{"label":["left_pred"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["right_pred"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"f1<0.144127041","2":"-1.6923077","3":"0.5945946"},{"1":"f1<0.92796278","2":"-0.7208678","3":"0.5082014"},{"1":"f0<2.00842214","2":"0.2841503","3":"-1.4273592"},{"1":"f0<0.991148889","2":"-0.4121352","3":"0.5331278"},{"1":"f0<-0.967202127","2":"1.5064100","3":"-0.1577089"},{"1":"f1<-0.344325602","2":"-1.1271961","3":"0.1360959"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # A tibble: 6 × 3</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   rule            left_pred right_pred</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 f1&lt;0.144127041     -1.69       0.595</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 f1&lt;0.92796278      -0.721      0.508</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 f0&lt;2.00842214       0.284     -1.43 </span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 f0&lt;0.991148889     -0.412      0.533</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 f0&lt;-0.967202127     1.51      -0.158</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 f1&lt;-0.344325602    -1.13       0.136</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We implement below the Logitboost algorithm for binary classification as described in <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span>, using <code>rpart</code> decision trees as weak learners:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-59_fc496c06413e80d92798a9d3106a24be">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Implementing original Logitboost algorithm FHT2000 using rpart</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>data_train <span class="ot">&lt;-</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>fit_original_logitboost <span class="ot">&lt;-</span> <span class="cf">function</span>(data_train, M, <span class="at">minbucket=</span><span class="dv">1</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>){</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># expect data with Y column in {0, 1},</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># with only additional predictors (as we will use formula Y ~ .)</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># should test unique(data %&gt;% pull(Y)) == c(0, 1)</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and class(data %&gt;% pull(Y)) is numeric</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Y</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data_train <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Length of training data</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(data_train)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  weak_learner <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialization of additive function f and probabilities p</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)             </span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, n)</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rpart parameters for Stump</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  cntrl <span class="ot">&lt;-</span> <span class="fu">rpart.control</span>(<span class="at">maxdepth =</span> <span class="dv">1</span>,</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>                         <span class="at">minsplit =</span> <span class="dv">0</span>,</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">minbucket =</span> minbucket,</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxsurrogate =</span> <span class="dv">0</span>,</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxcompete =</span> <span class="dv">0</span>,</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cp =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Boosting Iterations</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the working response/residuals and weights</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enforce a lower threshold on the weights: w = max(w, 2 × machine-zero).</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> <span class="fu">pmax</span>(p <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> p), .Machine<span class="sc">$</span>double.eps <span class="sc">*</span> <span class="dv">2</span>) </span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flooring with 2 times machine precision as suggested FHT00 p353</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute residuals</span></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> (y <span class="sc">-</span> p) <span class="sc">/</span> w               </span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the function f^m(x) by a weighted least-squares regression of z to x_i </span></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using weights w_i (weak learner is a stump)</span></span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store tree for predict on new data</span></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>    weak_learner[[m]] <span class="ot">&lt;-</span> <span class="fu">rpart</span>(z <span class="sc">~</span> .,</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_train <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Y), </span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>                   <span class="co"># we replace Y by z as a target, keeping all X to predict (~.)</span></span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> w,</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>                               <span class="at">control =</span> cntrl,</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">"anova"</span>)</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){</span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> weak_learner[[m]]</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Sanity checks</span></span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>      weighted_data <span class="ot">&lt;-</span> data_train <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">y =</span> y, <span class="at">weights =</span> w, <span class="at">z =</span> z, <span class="at">p =</span> p) </span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rpart.plot</span>(fit, <span class="at">type=</span><span class="dv">2</span>, <span class="at">extra=</span><span class="dv">101</span>, <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Manually compute weighted anova/sum of squares/leaf values</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parent Node</span></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>      n_parent <span class="ot">&lt;-</span> <span class="fu">nrow</span>(weighted_data)</span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>      sst <span class="ot">&lt;-</span> weighted_data <span class="sc">%&gt;%</span></span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">weighted_mean =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weights) <span class="sc">/</span> <span class="fu">sum</span>(weights),</span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rss =</span> weights <span class="sc">*</span> (y <span class="sc">-</span> weighted_mean)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>                 <span class="at">value =</span> weights <span class="sc">*</span> z) </span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>      (SST <span class="ot">&lt;-</span> sst <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">rss=</span><span class="fu">sum</span>(rss), <span class="at">val =</span> <span class="fu">sum</span>(value) <span class="sc">/</span> <span class="fu">sum</span>(weights)))</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>      (SST <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rss))</span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Left Node</span></span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>      left_weighted_data <span class="ot">&lt;-</span> weighted_data <span class="sc">%&gt;%</span></span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">as.name</span>(<span class="fu">rownames</span>(fit<span class="sc">$</span>splits)[<span class="dv">1</span>])<span class="sc">&lt;</span>fit<span class="sc">$</span>splits[<span class="dv">1</span>, <span class="st">"index"</span>])</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>      n_left <span class="ot">&lt;-</span> <span class="fu">nrow</span>(left_weighted_data)</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>      ssl <span class="ot">&lt;-</span> left_weighted_data <span class="sc">%&gt;%</span></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">weighted_mean =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weights) <span class="sc">/</span> <span class="fu">sum</span>(weights),</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rss =</span> weights <span class="sc">*</span> (y <span class="sc">-</span> weighted_mean)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>                 <span class="at">value =</span> weights <span class="sc">*</span> z) </span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>      (SSL <span class="ot">&lt;-</span> ssl <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">rss=</span><span class="fu">sum</span>(rss),</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a>                                <span class="at">val =</span> <span class="fu">sum</span>(value) <span class="sc">/</span> <span class="fu">sum</span>(weights),</span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>                                <span class="at">wrong_val =</span> <span class="fu">mean</span>(z)))</span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>      (SSL <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rss))</span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Right Node</span></span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>      right_weighted_data <span class="ot">&lt;-</span> weighted_data <span class="sc">%&gt;%</span></span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">as.name</span>(<span class="fu">rownames</span>(fit<span class="sc">$</span>splits)[<span class="dv">1</span>])<span class="sc">&gt;=</span>fit<span class="sc">$</span>splits[<span class="dv">1</span>, <span class="st">"index"</span>])</span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>      n_right <span class="ot">&lt;-</span> <span class="fu">nrow</span>(right_weighted_data)</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>      ssr <span class="ot">&lt;-</span> right_weighted_data <span class="sc">%&gt;%</span></span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">weighted_mean =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weights) <span class="sc">/</span> <span class="fu">sum</span>(weights),</span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a>                 <span class="at">rss =</span> weights <span class="sc">*</span> (y <span class="sc">-</span> weighted_mean)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>                 <span class="at">value =</span> weights <span class="sc">*</span> z) </span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a>      (SSR <span class="ot">&lt;-</span> ssr <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(<span class="at">rss=</span><span class="fu">sum</span>(rss), <span class="at">val =</span> <span class="fu">sum</span>(value) <span class="sc">/</span> <span class="fu">sum</span>(weights)))</span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a>      (SSR <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rss))</span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Compute gain</span></span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>      (SST <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rss) <span class="sc">-</span> </span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>          n_left<span class="sc">/</span>n_parent <span class="sc">*</span> SSL <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rss) <span class="sc">-</span></span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>          n_right<span class="sc">/</span>n_parent <span class="sc">*</span> SSR <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rss))</span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict f as weighted least square z~x, weight=w using CART</span></span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a>    f_m <span class="ot">&lt;-</span> <span class="fu">predict</span>(weak_learner[[m]])</span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update Newton Boosted Stumps (ie Forward Stagewise Additive Model)</span></span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and probabilities</span></span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> f <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> f_m</span>
<span id="cb65-109"><a href="#cb65-109" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> f))</span>
<span id="cb65-110"><a href="#cb65-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-111"><a href="#cb65-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-112"><a href="#cb65-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Output list of weak learners (here stumps) for the predict function</span></span>
<span id="cb65-113"><a href="#cb65-113" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">list</span>(<span class="at">weak_learners=</span>weak_learner, <span class="at">probs=</span>p))</span>
<span id="cb65-114"><a href="#cb65-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-115"><a href="#cb65-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-116"><a href="#cb65-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-117"><a href="#cb65-117" aria-hidden="true" tabindex="-1"></a>logitboost_mixture <span class="ot">&lt;-</span> <span class="fu">fit_original_logitboost</span>(data_train, num_tree, <span class="cn">TRUE</span>)</span>
<span id="cb65-118"><a href="#cb65-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-119"><a href="#cb65-119" aria-hidden="true" tabindex="-1"></a>predict_original_logitboost <span class="ot">&lt;-</span> <span class="cf">function</span>(fitted_logitboost, new_data, <span class="at">num_tree =</span> <span class="sc">-</span><span class="dv">1</span>){</span>
<span id="cb65-120"><a href="#cb65-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-121"><a href="#cb65-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Allowing to use m &lt; M number of rounds</span></span>
<span id="cb65-122"><a href="#cb65-122" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">length</span>(fitted_logitboost<span class="sc">$</span>weak_learners)</span>
<span id="cb65-123"><a href="#cb65-123" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(num_tree <span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> num_tree <span class="sc">&lt;</span> M){</span>
<span id="cb65-124"><a href="#cb65-124" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> num_tree</span>
<span id="cb65-125"><a href="#cb65-125" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb65-126"><a href="#cb65-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-127"><a href="#cb65-127" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb65-128"><a href="#cb65-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-129"><a href="#cb65-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predicting on new data with Newton Boosted Stumps </span></span>
<span id="cb65-130"><a href="#cb65-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (ie f function as Forward Stagewise Additive Model of Tress (depth 1))</span></span>
<span id="cb65-131"><a href="#cb65-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and probabilities</span></span>
<span id="cb65-132"><a href="#cb65-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb65-133"><a href="#cb65-133" aria-hidden="true" tabindex="-1"></a>    f_m <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_logitboost<span class="sc">$</span>weak_learners[[m]], <span class="at">newdata =</span> new_data)</span>
<span id="cb65-134"><a href="#cb65-134" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> f <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> f_m</span>
<span id="cb65-135"><a href="#cb65-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb65-136"><a href="#cb65-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-137"><a href="#cb65-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get probability from Newton Boosted Stumps </span></span>
<span id="cb65-138"><a href="#cb65-138" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> f))</span>
<span id="cb65-139"><a href="#cb65-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-140"><a href="#cb65-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb65-141"><a href="#cb65-141" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-142"><a href="#cb65-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-143"><a href="#cb65-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check: Compare predict(data_train) with original fit on data_train</span></span>
<span id="cb65-144"><a href="#cb65-144" aria-hidden="true" tabindex="-1"></a>p_test <span class="ot">&lt;-</span> <span class="fu">predict_original_logitboost</span>(logitboost_mixture, data_train, <span class="dv">6</span>)</span>
<span id="cb65-145"><a href="#cb65-145" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(logitboost_mixture<span class="sc">$</span>probs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(p_test))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(p_test)<span class="sc">==</span><span class="fu">sum</span>(logitboost_mixture<span class="sc">$</span>probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>We compare below the <code>xgboost</code> predicted probabilities with our algorithm which are strictly equal up to the numerical precision:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare xgboost prediction (without penalties etc, and using stumps) </span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with logitboost original fit on data_train</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>pred_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(xgb_deg,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.matrix</span>(data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2)))</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(logitboost_mixture<span class="sc">$</span>probs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(pred_xgb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abs</span>(<span class="fu">sum</span>(pred_xgb)<span class="sc">-</span><span class="fu">sum</span>(logitboost_mixture<span class="sc">$</span>probs))<span class="sc">&lt;</span><span class="fl">1e-6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>We show below the LogitBoost decision boundary, here after <span class="math inline">\(100\)</span> iterations using our version of the algorithm:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-61_c18b0dec89849e0690db49aced8214aa">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>tree_number <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>logitboost_M <span class="ot">&lt;-</span> <span class="fu">fit_original_logitboost</span>(data_train, tree_number, <span class="cn">FALSE</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>tree_number_predict <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_train)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>grid_precision <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>, grid_precision),</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.25</span>, <span class="fl">3.1</span>, grid_precision)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid,</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">tibble</span>(<span class="at">predict_logitboost =</span> <span class="fu">predict_original_logitboost</span>(logitboost_M,</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>                                                                          grid,</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>                                                                          <span class="at">num_tree =</span> tree_number_predict))) <span class="sc">%&gt;%</span> </span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>(logitboost_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> grid_precision, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_logitboost),</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="fl">0.5</span><span class="sc">-</span>grid_precision, <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_logitboost),</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span><span class="sc">-</span>grid_precision,<span class="dv">2</span>),</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>),</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))),</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y),</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>                         <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>),</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>)) <span class="sc">+</span></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">size=</span><span class="fl">0.5</span>),</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/</span></span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">stroke=</span><span class="st">"none"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>logitboost_error_rate <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">tibble</span>(<span class="at">class =</span> <span class="fu">predict_original_logitboost</span>(logitboost_M,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>                                                                      new_mixture,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>                                                                      <span class="at">num_tree =</span> tree_number)) <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">if_else</span>(class <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>(logitboost_risk <span class="ot">&lt;-</span> logitboost_error_rate  <span class="sc">%&gt;%</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2725</code></pre>
</div>
</div>
<p>Here after <span class="math inline">\(100\)</span> iterations using <code>xgboost</code>:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-62_d597a9785a927faf0edb3ce9c2dbe174">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>tree_number <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>data_train_xgboost <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2))</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>xgboost_M <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(data_train_xgboost),</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">max.depth =</span> <span class="dv">1</span>,</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">eta =</span> <span class="dv">1</span>,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">nthread =</span> <span class="dv">1</span>,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">nrounds =</span> tree_number,</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_child_weight =</span> <span class="dv">0</span>,</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">objective =</span> <span class="st">"binary:logistic"</span>,</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="dv">0</span>,</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># updater = "grow_colmaker",</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">tree_method =</span> <span class="st">"exact"</span>,</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_train_xgboost)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>tree_number_predict <span class="ot">&lt;-</span> tree_number</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="co"># tree_number_predict &lt;- 20</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>grid_precision <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>, grid_precision),</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.25</span>, <span class="fl">3.1</span>, grid_precision)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid, </span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">tibble</span>(<span class="at">predict_logitboost =</span> <span class="fu">predict</span>(xgboost_M,</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>                                                      <span class="fu">as.matrix</span>(grid),</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>                                <span class="at">iterationrange=</span><span class="fu">c</span>(<span class="dv">1</span>, tree_number_predict <span class="sc">+</span> <span class="dv">1</span>)))) <span class="sc">%&gt;%</span> </span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>(logitboost_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> grid_precision, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_logitboost),</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="fl">0.5</span><span class="sc">-</span>grid_precision, <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_logitboost),</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span><span class="sc">-</span>grid_precision,<span class="dv">1</span>),</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>                         <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>),</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span></span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))),</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y), <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>),</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>)) <span class="sc">+</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">size=</span><span class="fl">0.5</span>),</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/</span></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">stroke=</span><span class="st">"none"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="sec-gradboost_imp" class="level3" data-number="2.7.2">
<h3 data-number="2.7.2" class="anchored" data-anchor-id="sec-gradboost_imp"><span class="header-section-number">2.7.2</span> MART: Gradient Boosting version of LogitBoost</h3>
<!-- https://stats.stackexchange.com/questions/444267/spelling-out-a-detail-in-the-gradient-boosting-machine-algorithm-for-binary-clas -->
<p>In <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span>, the following generic algorithm (working with differentiable losses) was introduced:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/gbm_generic%20algorithm.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>As seen before, starting from an initial guess <span class="math inline">\(f^0\)</span>, one sequentially add steps:</p>
<p><span class="math display">\[
f_M(x) = \sum_{m=0}^M f^m(x)
\]</span></p>
<p>At the start of iteration <span class="math inline">\(m\)</span>, the current estimate is given by <span class="math inline">\(f_{m-1}\)</span>. At that “point” in function space, the direction to the steepest descent of the Risk we seek to minimize, is given by the opposite of the gradient with respect to <span class="math inline">\(f(x)\)</span>:</p>
<p><span class="math display">\[
\text{grad}^m(x)=\left.\frac{\partial\mathrm R(f)}{\partial f(x)}\right|_{f(x)=f_{m-1}(x)}=\left.\frac{\partial \mathbb{E}[L(Y,f(x))|X=x]}{\partial f(x)}\right|_{f(x)=f_{m-1}(x)} =  \mathbb{E} \left[\frac{\partial L(Y,f(x))}{\partial f(x)}|X=x\right]_{f(x)=f_{m-1}(x)}
\]</span></p>
<p>Friedman also introduces a step length or “learning rate” to take in the opposite direction of the gradient, this step is determined using “line search”, that is:</p>
<p><span class="math display">\[
\rho^m=\underset{\rho}{\operatorname{argmin}}\mathbb{E}[L(Y,f_{m-1}(x) -\rho \text{grad}^m(x)]
\]</span></p>
<p>giving a step <span class="math inline">\(f^m(x) =-\rho_m \text{grad}^m(x)\)</span>.</p>
<p>Note that <span class="math inline">\(\text{grad}^m(x)\)</span> is approximated by a regression procedure, step 4 in algorithm before, which can be implemented for example using decision trees for regression. This regression step does not involve “dividing” observations by “second derivatives/hessian”, hence the algorithm is supposed to be more robust than LogitBoost.</p>
<p>We give below the Gradient Boosting machine algorithm for Logistic loss, implemented with decision trees for regression:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/mart_algo1.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><img src="../images/mart_algo2.png" class="img-fluid" data-fig-align="center"> It is also formulated in <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> (Lgorithm 10.4, p387):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/mart_algorithm_eslii.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>In that particular case (Logistic loss, regression made with decision trees), the line search step is solved using a one-step Newton method. However this Newton step is performed after the regression tree has been fitted, to compute the value of each leafs, which is different from the LogitBoost approach where the Newton step is performed to fit the tree (it is basically the weighted regression of <span class="math inline">\(-\frac{g_i}{h_i}\)</span>). Furthermore the denominator of the Newton step in Gradient Boosting for Logisitc loss is the sum of all <span class="math inline">\(p(1-p)\)</span> in the leaf, so it is less prone to numerical issues.</p>
<p>We implement below the algorithm, fitting first a regression tree, then modifying the leafs with the “line search”:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-63_148048db0c72644844a4955c8864293d">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>fit_l01_treeboost <span class="ot">&lt;-</span> <span class="cf">function</span>(data_train, M, <span class="at">shrink =</span> <span class="fl">1.0</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>){</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># friedman2001 version of LogitBoost (so called LK_TreeBoost or MART, Algorithm 5)</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in friedman2001 expects data with Y column in {-1, 1}</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We use the rewriting for Y in {0, 1} cf p387 ESLII</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data with only additional predictors (as we will use formula Y ~ .)</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># should test unique(data %&gt;% pull(Y)) == c(0, 1)</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and classs(data %&gt;% pull(Y)) is numeric</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Y ({0, 1})</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data_train <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Length of training data</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(data_train)</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  weak_learner <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialization of additive function f and probability p</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)             </span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, n)</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rpart parameters for Stumps</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>  cntrl <span class="ot">&lt;-</span> <span class="fu">rpart.control</span>(<span class="at">maxdepth =</span> <span class="dv">1</span>,</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>                         <span class="at">minsplit =</span> <span class="dv">0</span>,</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>                         <span class="at">minbucket =</span> <span class="dv">1</span>,</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxsurrogate =</span> <span class="dv">0</span>,</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxcompete =</span> <span class="dv">0</span>,</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cp =</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Boosting Iterations</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute residual</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> y <span class="sc">-</span> p</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Friedman gbm2001 version y in {-1, 1}</span></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># z &lt;- 2 * y / (1 + exp(2 * y * f))               </span></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the function f^m(x) by a weighted least-squares regression of z to x_i </span></span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using weights w_i (weak learner is a stump)</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>    weak_learner_region <span class="ot">&lt;-</span> <span class="fu">rpart</span>(z <span class="sc">~</span> .,</span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_train <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Y), </span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># we replace Y by z as a target, keeping all X to predict (~.)</span></span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>                               <span class="at">control =</span> cntrl,</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>                               <span class="at">method =</span> <span class="st">"anova"</span>)</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the leaf weights optimizing the line search once regions are known </span></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (they match weights computed for LogitBoost)</span></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enforce a lower threshold on the weights: w = max(w, 2 × machine-zero).</span></span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># w &lt;- pmax(p * (1 - p), .Machine$double.eps * 2) </span></span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flooring with 2 times machine precision as suggested FHT00 p353</span></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>    w <span class="ot">&lt;-</span> <span class="fu">pmax</span>(<span class="fu">abs</span>(z) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">abs</span>(z)), .Machine<span class="sc">$</span>double.eps <span class="sc">*</span> <span class="dv">2</span>) </span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using Friedman equivalent expression for leaf weigths </span></span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modifying leaf weights within the rpart object </span></span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (tree regions/splits are left unchanged)</span></span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gathering observations z and w used to compute final weight</span></span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>    leaf_weights <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">y=</span>y, <span class="at">z=</span>z, <span class="at">w=</span>w) <span class="sc">%&gt;%</span> </span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a>      <span class="co"># adding regression tree leaf/region for each observation</span></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">leaf =</span> weak_learner_region<span class="sc">$</span>where) <span class="sc">%&gt;%</span> </span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(leaf) <span class="sc">%&gt;%</span></span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>      <span class="co"># computing the sum_i(z_i) / sum_i(w_i) for each tree leaf</span></span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>                <span class="at">weight_node =</span> <span class="fu">sum</span>(z)<span class="sc">/</span><span class="fu">sum</span>(w),) </span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Example for a stump</span></span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>      <span class="co"># A tibble: 2 × 3</span></span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>      <span class="co">#    leaf     n weight_node</span></span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;</span></span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 1     2    52      -1.69 </span></span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 2     3   148       0.595</span></span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){ </span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(leaf_weights)</span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>      weak_learner_region_old <span class="ot">&lt;-</span> weak_learner_region}</span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We modify the rpart object leaf nodes weigths/values with our own</span></span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Leaf 2 (ie left)</span></span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>    weak_learner_region<span class="sc">$</span>frame[weak_learner_region<span class="sc">$</span>frame<span class="sc">$</span>n</span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">==</span> (leaf_weights[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">pull</span>(n)),</span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'yval'</span>] <span class="ot">&lt;-</span> leaf_weights[<span class="dv">1</span>,<span class="dv">3</span>]</span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Leaf 3 (ie right)</span></span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>    weak_learner_region<span class="sc">$</span>frame[weak_learner_region<span class="sc">$</span>frame<span class="sc">$</span>n</span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">==</span> (leaf_weights[<span class="dv">2</span>,<span class="dv">2</span>] <span class="sc">%&gt;%</span> <span class="fu">pull</span>(n)),</span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'yval'</span>] <span class="ot">&lt;-</span> leaf_weights[<span class="dv">2</span>,<span class="dv">3</span>]</span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store modified tree for prediction on new data</span></span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a>    weak_learner[[m]] <span class="ot">&lt;-</span> weak_learner_region</span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-92"><a href="#cb81-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(verbose){ </span>
<span id="cb81-93"><a href="#cb81-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sanity check: predict modified tree should differ</span></span>
<span id="cb81-94"><a href="#cb81-94" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">modified =</span> <span class="fu">predict</span>(weak_learner_region, data_train)),</span>
<span id="cb81-95"><a href="#cb81-95" aria-hidden="true" tabindex="-1"></a>              <span class="fu">tibble</span>(<span class="at">old =</span> <span class="fu">predict</span>(weak_learner_region_old, data_train))))</span>
<span id="cb81-96"><a href="#cb81-96" aria-hidden="true" tabindex="-1"></a>       <span class="co"># A tibble: 200 × 2</span></span>
<span id="cb81-97"><a href="#cb81-97" aria-hidden="true" tabindex="-1"></a>       <span class="co">#   modified    old</span></span>
<span id="cb81-98"><a href="#cb81-98" aria-hidden="true" tabindex="-1"></a>       <span class="co">#      &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb81-99"><a href="#cb81-99" aria-hidden="true" tabindex="-1"></a>       <span class="co"># 1    0.595  0.149</span></span>
<span id="cb81-100"><a href="#cb81-100" aria-hidden="true" tabindex="-1"></a>       <span class="co"># 2   -1.69  -0.423</span></span>
<span id="cb81-101"><a href="#cb81-101" aria-hidden="true" tabindex="-1"></a>       <span class="co"># 3    0.595  0.149</span></span>
<span id="cb81-102"><a href="#cb81-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb81-103"><a href="#cb81-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-104"><a href="#cb81-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict f as least square z~x using CART</span></span>
<span id="cb81-105"><a href="#cb81-105" aria-hidden="true" tabindex="-1"></a>    f_m <span class="ot">&lt;-</span> <span class="fu">predict</span>(weak_learner_region)</span>
<span id="cb81-106"><a href="#cb81-106" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb81-107"><a href="#cb81-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Updating Gradient Boosted Stumps (ie Forward Stagewise Additive Model)</span></span>
<span id="cb81-108"><a href="#cb81-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and probabilities</span></span>
<span id="cb81-109"><a href="#cb81-109" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> f <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> shrink <span class="sc">*</span> f_m</span>
<span id="cb81-110"><a href="#cb81-110" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> f))</span>
<span id="cb81-111"><a href="#cb81-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-112"><a href="#cb81-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-113"><a href="#cb81-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Output list of weak learners (here stumps) for the predict function</span></span>
<span id="cb81-114"><a href="#cb81-114" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">list</span>(<span class="at">weak_learners=</span>weak_learner, <span class="at">probs=</span>p))</span>
<span id="cb81-115"><a href="#cb81-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-116"><a href="#cb81-116" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In particular, we verify on a simple case that our implementation agrees with package <code>gbm</code> that implements the <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span> article algorithm:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Friedman MART / gbm</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stackoverflow.com/questions/31296541/understanding-tree-structure-in-r-gbm-package</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("gbm-developers/gbm3", build_vignettes = TRUE, force = TRUE)</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>gbm_deg <span class="ot">&lt;-</span> <span class="fu">gbm</span>(Y<span class="sc">~</span>x1<span class="sc">+</span>x2,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>)),</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">n.trees =</span> <span class="dv">6</span>, </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">distribution =</span> <span class="st">"bernoulli"</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">interaction.depth =</span> <span class="dv">1</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># n.minobsinnode comparable to rpart minbucket</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">n.minobsinnode =</span> <span class="dv">1</span>,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">shrinkage =</span> <span class="dv">1</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">bag.fraction =</span> <span class="dv">1</span>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>list_gbm_trees <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>num_tree){</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>  tree <span class="ot">&lt;-</span> gbm_deg<span class="sc">$</span>trees[[m]]</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  list_gbm_trees[[m]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">var =</span> <span class="fu">if_else</span>(tree[[<span class="dv">1</span>]][<span class="dv">1</span>]<span class="sc">==</span><span class="dv">0</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>),</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">split =</span> tree[[<span class="dv">2</span>]][<span class="dv">1</span>],</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">left_pred =</span> tree[[<span class="dv">2</span>]][<span class="dv">2</span>],</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">right_pred =</span> tree[[<span class="dv">2</span>]][<span class="dv">3</span>])</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>gbm_trees <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(list_gbm_trees) <span class="sc">%&gt;%</span> </span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">rule =</span> <span class="fu">ifelse</span>(var<span class="sc">==</span><span class="st">"x1"</span>,</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>                                   glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"f0&lt;{round(split,9)}"</span>),</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>                                   glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"f1&lt;{round(split,9)}"</span>)))</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>gbm_trees <span class="sc">%&gt;%</span> <span class="fu">select</span>(rule, left_pred, right_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["rule"],"name":[1],"type":["chr"],"align":["left"]},{"label":["left_pred"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["right_pred"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"f1<0.14412705","2":"-1.69230769","3":"0.5945946"},{"1":"f1<0.927962775","2":"-0.72086776","3":"0.5082013"},{"1":"f0<2.125986653","2":"0.27716240","3":"-1.4367479"},{"1":"f0<0.991148884","2":"-0.40439682","3":"0.5239125"},{"1":"f0<-0.967202093","2":"1.50607816","3":"-0.1575898"},{"1":"f0<3.07754902","2":"-0.01178352","3":"1.2424032"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # A tibble: 6 × 3</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   rule            left_pred right_pred</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 f1&lt;0.14412705     -1.69        0.595</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 f1&lt;0.927962775    -0.721       0.508</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 f0&lt;2.125986653     0.277      -1.44 </span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 f0&lt;0.991148884    -0.404       0.524</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 f0&lt;-0.967202093    1.51       -0.158</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 f0&lt;3.07754902     -0.0118      1.24</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co"># pretty.gbm.tree(gbm_deg, i.tree=1)</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   SplitVar SplitCodePred LeftNode RightNode MissingNode ErrorReduction Weight Prediction</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 0        1     0.1441271        1         2           3       12.57796    200  0.0000000</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 1       -1    -1.6923077       -1        -1          -1        0.00000     52 -1.6923077</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 2       -1     0.5945946       -1        -1          -1        0.00000    148  0.5945946</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3       -1     0.0000000       -1        -1          -1        0.00000    200  0.0000000</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Although the methods are not totally equivalent</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="co"># (xgboost is Newton, gbm is Gradient based), the underlying stumps roughly agree</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare gbm prediction (with learning rate = 1 etc, and using stumps) </span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a><span class="co"># with gradient boosting flavor of logitboost original fit on data_train</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Our implementation</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>gbt_mixtures <span class="ot">&lt;-</span> <span class="fu">fit_l01_treeboost</span>(data_train, num_tree, <span class="at">shrink =</span> <span class="fl">1.0</span>, <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
   leaf     n weight_node
  &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;
1     2    52      -1.69 
2     3   148       0.595
# A tibble: 2 × 3
   leaf     n weight_node
  &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;
1     2   108      -0.721
2     3    92       0.508
# A tibble: 2 × 3
   leaf     n weight_node
  &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;
1     2    32      -1.44 
2     3   168       0.277
# A tibble: 2 × 3
   leaf     n weight_node
  &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;
1     2   108      -0.404
2     3    92       0.524
# A tibble: 2 × 3
   leaf     n weight_node
  &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;
1     2   183      -0.158
2     3    17       1.51 
# A tibble: 2 × 3
   leaf     n weight_node
  &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;
1     2   193     -0.0118
2     3     7      1.24  </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(gbt_mixtures<span class="sc">$</span>probs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 99.93048</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Package `gbm`</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>p_gbm <span class="ot">&lt;-</span> <span class="fu">predict</span>(gbm_deg,<span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(p_gbm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 99.93048</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">abs</span>(<span class="fu">sum</span>(gbt_mixtures<span class="sc">$</span>probs)<span class="sc">-</span><span class="fu">sum</span>(p_gbm)) <span class="sc">&lt;</span> <span class="fl">1e-6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>We define a function to predict using a fitted tree:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>predict_l01_treeboost <span class="ot">&lt;-</span> <span class="cf">function</span>(fitted_l01_treeboost, new_data, <span class="at">num_tree =</span> <span class="sc">-</span><span class="dv">1</span>){</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Allowing to use m &lt; M number of rounds</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">length</span>(fitted_l01_treeboost<span class="sc">$</span>weak_learners)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(num_tree <span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> num_tree <span class="sc">&lt;</span> M){</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> num_tree</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predicting on new data with Gradient Boosted Stumps </span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (ie f function as Forward Stagewise Additive Model of Trees (depth 1)) and probabilities</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    f_m <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_l01_treeboost<span class="sc">$</span>weak_learners[[m]], <span class="at">newdata =</span> new_data)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> f <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> f_m</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get probability from Gradient Boosted Stumps </span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> f))</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check: Compare predict(data_train) with original fit on data_train</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>p_test <span class="ot">&lt;-</span> <span class="fu">predict_l01_treeboost</span>(gbt_mixtures, data_train, <span class="dv">6</span>)</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(p_test))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 99.93048</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(gbt_mixtures<span class="sc">$</span>probs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 99.93048</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(p_test) <span class="sc">==</span> <span class="fu">sum</span>(gbt_mixtures<span class="sc">$</span>probs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>We display MART decision boundaries for various number of boosting iterations:</p>
<ul>
<li><span class="math inline">\(M=20\)</span>:</li>
</ul>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-66_eb721cc2db4de56f4456b1c9aad167eb">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tree_number <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>l01_treeboost_M <span class="ot">&lt;-</span> <span class="fu">fit_l01_treeboost</span>(data_train, tree_number, <span class="at">shrink =</span> <span class="fl">1.0</span>, <span class="cn">FALSE</span>)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>tree_number_predict <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_train)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>grid_precision <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>, grid_precision),</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.25</span>, <span class="fl">3.1</span>, grid_precision)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid, </span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">tibble</span>(<span class="at">predict_mart =</span> <span class="fu">predict_l01_treeboost</span>(l01_treeboost_M,</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>                                                        grid,</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">num_tree =</span> tree_number_predict))) <span class="sc">%&gt;%</span> </span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">mutate</span>(<span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>(logitboost_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> grid_precision, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_mart),</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="fl">0.5</span><span class="sc">-</span>grid_precision, <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_mart),</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span><span class="sc">-</span>grid_precision,<span class="dv">2</span>),</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>                         <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>),</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))),</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y), <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>),</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>)) <span class="sc">+</span></span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">size=</span><span class="fl">0.5</span>),</span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/</span></span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)</span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">stroke=</span><span class="st">"none"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>mart_error_rate <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">tibble</span>(<span class="at">class =</span> <span class="fu">predict_l01_treeboost</span>(l01_treeboost_M,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>                                                          new_mixture,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">num_tree =</span> tree_number_predict)) <span class="sc">%&gt;%</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">if_else</span>(class <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>(mart_risk <span class="ot">&lt;-</span> mart_error_rate  <span class="sc">%&gt;%</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2525</code></pre>
</div>
</div>
<ul>
<li><span class="math inline">\(M=50\)</span>:</li>
</ul>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-67_ef3a0f523cb5c7075369b7267a1b2730">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>tree_number_predict <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_train)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>grid_precision <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>, grid_precision),</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.25</span>, <span class="fl">3.1</span>, grid_precision)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid, <span class="fu">tibble</span>(<span class="at">predict_mart =</span> <span class="fu">predict_l01_treeboost</span>(l01_treeboost_M,</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                                                                    grid,</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>                                                                    <span class="at">num_tree =</span> tree_number_predict))) <span class="sc">%&gt;%</span> </span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>(logitboost_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> grid_precision, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_mart),</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="fl">0.5</span><span class="sc">-</span>grid_precision, <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_mart),</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.5</span><span class="sc">-</span>grid_precision,<span class="dv">2</span>),</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>),</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span></span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))),</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y), <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">name=</span><span class="st">"Y"</span>,</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>),</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>)) <span class="sc">+</span></span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>),</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.24</span>, <span class="fl">3.09</span>),</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>                    <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">size=</span><span class="fl">0.5</span>),</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/</span></span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key =</span> <span class="fu">element_rect</span>(<span class="at">color=</span><span class="st">"black"</span>),</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"pt"</span>)</span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">+</span></span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">stroke=</span><span class="st">"none"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>mart_error_rate <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">tibble</span>(<span class="at">class =</span> <span class="fu">predict_l01_treeboost</span>(l01_treeboost_M,</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                                                          new_mixture,</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">num_tree =</span> tree_number_predict)) <span class="sc">%&gt;%</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fu">if_else</span>(class <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>(mart_risk <span class="ot">&lt;-</span> mart_error_rate  <span class="sc">%&gt;%</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2585</code></pre>
</div>
</div>
<p>Train / Test curves for AdaBoost, LogitBoost and MART</p>
<p>We estimate the Bayes risk on the testing data set simulated before (10k BLUE/ORANGE dots).</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-68_a4892654abe8d4ee20ba203383692640">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>bayes_error_rate <span class="ot">&lt;-</span> new_mixture <span class="sc">%&gt;%</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2),</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>predict_oracle, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>bayes_test_risk <span class="ot">&lt;-</span> bayes_error_rate <span class="sc">%&gt;%</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pull</span>(l01)</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>bayes_error_rate_train <span class="ot">&lt;-</span> data_mixture_example <span class="sc">%&gt;%</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2),</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>predict_oracle, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>bayes_train_risk <span class="ot">&lt;-</span> bayes_error_rate_train <span class="sc">%&gt;%</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pull</span>(l01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We compare below AdaBoost, LogitBoost, MART (Gradient Boosting version of LogitBoost) algorithms in terms of testing set misclassification, varying the number of tree fitted <span class="math inline">\(M\)</span>:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-69_505cd2a045d3868cc028e22afb369a90">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>tree_number <span class="ot">&lt;-</span> <span class="dv">400</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>M <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">as.integer</span>(tree_number<span class="sc">/</span><span class="dv">4</span>), <span class="dv">2</span>),</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq</span>(<span class="fu">as.integer</span>(tree_number<span class="sc">/</span><span class="dv">4</span>), <span class="fu">as.integer</span>(tree_number<span class="sc">/</span><span class="dv">2</span>), <span class="dv">10</span>),</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">seq</span>(<span class="fu">as.integer</span>(tree_number<span class="sc">/</span><span class="dv">2</span>), tree_number, <span class="dv">20</span>))</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>misclass_curve <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>logitboost_M <span class="ot">&lt;-</span> <span class="fu">fit_original_logitboost</span>(data_train, tree_number, <span class="cn">FALSE</span>)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>adaboost_M <span class="ot">&lt;-</span> <span class="fu">fit_original_adaboost</span>(data_ada, tree_number, <span class="cn">FALSE</span>)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>mart_M <span class="ot">&lt;-</span> <span class="fu">fit_l01_treeboost</span>(data_train, tree_number, <span class="at">shrink =</span> <span class="dv">1</span>, <span class="cn">FALSE</span>)</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (m <span class="cf">in</span> M){</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  logitboost_error_rate_train <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data_train,</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">class_train =</span> <span class="fu">predict_original_logitboost</span>(logitboost_M,</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>                                                            data_train,</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>                                                            <span class="at">num_tree =</span> m)) <span class="sc">%&gt;%</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">class_train =</span> <span class="fu">if_else</span>(class_train <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">l01_train =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class_train, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>  mart_error_rate_train <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data_train,</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">class_train =</span> <span class="fu">predict_l01_treeboost</span>(mart_M,</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>                                                      data_train,</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>                                                      <span class="at">num_tree =</span> m)) <span class="sc">%&gt;%</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">class_train =</span> <span class="fu">if_else</span>(class_train <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">l01_train =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class_train, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>  adaboost_error_rate_train <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(data_train,</span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">class_train =</span> <span class="fu">predict_original_adaboost</span>(adaboost_M,</span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>                                                          data_ada,</span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">num_tree =</span> m)) <span class="sc">%&gt;%</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">class_train =</span> <span class="fu">if_else</span>(class_train <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">l01_train =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class_train, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>  logitboost_error_rate_test <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">class_test =</span> <span class="fu">predict_original_logitboost</span>(logitboost_M,</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>                                                           new_mixture,</span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">num_tree =</span> m)) <span class="sc">%&gt;%</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">class_test =</span> <span class="fu">if_else</span>(class_test <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>                   <span class="at">l01_test =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class_test, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>  adaboost_error_rate_test <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">class_test =</span> <span class="fu">predict_original_adaboost</span>(adaboost_M,</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>                                                         new_mixture,</span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">num_tree =</span> m))<span class="sc">%&gt;%</span></span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">class_test =</span> <span class="fu">if_else</span>(class_test <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>                   <span class="at">l01_test =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class_test, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>  mart_error_rate_test <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">class_test =</span> <span class="fu">predict_l01_treeboost</span>(mart_M,</span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a>                                                     new_mixture,</span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">num_tree =</span> m)) <span class="sc">%&gt;%</span></span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">class_test =</span> <span class="fu">if_else</span>(class_test <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a>                   <span class="at">l01_test =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class_test, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a>  (logitboost_risk_train <span class="ot">&lt;-</span> logitboost_error_rate_train  <span class="sc">%&gt;%</span></span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">l01_train =</span> <span class="fu">mean</span>(l01_train)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(l01_train))</span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a>  (logitboost_risk_test <span class="ot">&lt;-</span> logitboost_error_rate_test  <span class="sc">%&gt;%</span></span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01_test =</span> <span class="fu">mean</span>(l01_test)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01_test))</span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a>  (adaboost_risk_train <span class="ot">&lt;-</span> adaboost_error_rate_train  <span class="sc">%&gt;%</span></span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01_train =</span> <span class="fu">mean</span>(l01_train)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01_train))</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-72"><a href="#cb104-72" aria-hidden="true" tabindex="-1"></a>  (adaboost_risk_test <span class="ot">&lt;-</span> adaboost_error_rate_test  <span class="sc">%&gt;%</span></span>
<span id="cb104-73"><a href="#cb104-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">l01_test =</span> <span class="fu">mean</span>(l01_test)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-74"><a href="#cb104-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(l01_test))</span>
<span id="cb104-75"><a href="#cb104-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-76"><a href="#cb104-76" aria-hidden="true" tabindex="-1"></a>  (mart_risk_train <span class="ot">&lt;-</span> mart_error_rate_train  <span class="sc">%&gt;%</span></span>
<span id="cb104-77"><a href="#cb104-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01_train =</span> <span class="fu">mean</span>(l01_train)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-78"><a href="#cb104-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01_train))</span>
<span id="cb104-79"><a href="#cb104-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-80"><a href="#cb104-80" aria-hidden="true" tabindex="-1"></a>  (mart_risk_test <span class="ot">&lt;-</span> mart_error_rate_test  <span class="sc">%&gt;%</span></span>
<span id="cb104-81"><a href="#cb104-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">l01_test =</span> <span class="fu">mean</span>(l01_test)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-82"><a href="#cb104-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(l01_test))</span>
<span id="cb104-83"><a href="#cb104-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-84"><a href="#cb104-84" aria-hidden="true" tabindex="-1"></a>  misclass_curve[[m]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">m - Number of Boosted Trees</span><span class="st">`</span> <span class="ot">=</span> m,</span>
<span id="cb104-85"><a href="#cb104-85" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Boosting: Logitboost train</span><span class="st">`</span> <span class="ot">=</span> logitboost_risk_train,</span>
<span id="cb104-86"><a href="#cb104-86" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Boosting: Logitboost test</span><span class="st">`</span> <span class="ot">=</span> logitboost_risk_test,</span>
<span id="cb104-87"><a href="#cb104-87" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Boosting: MART train</span><span class="st">`</span> <span class="ot">=</span> mart_risk_train,</span>
<span id="cb104-88"><a href="#cb104-88" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Boosting: MART test</span><span class="st">`</span> <span class="ot">=</span> mart_risk_test,</span>
<span id="cb104-89"><a href="#cb104-89" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Boosting: Adaboost train</span><span class="st">`</span> <span class="ot">=</span> adaboost_risk_train,</span>
<span id="cb104-90"><a href="#cb104-90" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">Boosting: Adaboost test</span><span class="st">`</span> <span class="ot">=</span> adaboost_risk_test)</span>
<span id="cb104-91"><a href="#cb104-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-92"><a href="#cb104-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-93"><a href="#cb104-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-94"><a href="#cb104-94" aria-hidden="true" tabindex="-1"></a>misclass_plot <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(misclass_curve) <span class="sc">%&gt;%</span> </span>
<span id="cb104-95"><a href="#cb104-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Bayes test</span><span class="st">`</span> <span class="ot">=</span> bayes_test_risk,</span>
<span id="cb104-96"><a href="#cb104-96" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Bayes train</span><span class="st">`</span> <span class="ot">=</span> bayes_train_risk) <span class="sc">%&gt;%</span> </span>
<span id="cb104-97"><a href="#cb104-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="st">`</span><span class="at">m - Number of Boosted Trees</span><span class="st">`</span>,</span>
<span id="cb104-98"><a href="#cb104-98" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"Model data"</span>,</span>
<span id="cb104-99"><a href="#cb104-99" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"Misclass Rate"</span>)</span>
<span id="cb104-100"><a href="#cb104-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-101"><a href="#cb104-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-102"><a href="#cb104-102" aria-hidden="true" tabindex="-1"></a>(boosted_trees_error <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(misclass_plot) <span class="sc">+</span></span>
<span id="cb104-103"><a href="#cb104-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="st">`</span><span class="at">m - Number of Boosted Trees</span><span class="st">`</span>,</span>
<span id="cb104-104"><a href="#cb104-104" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> <span class="st">`</span><span class="at">Misclass Rate</span><span class="st">`</span>,</span>
<span id="cb104-105"><a href="#cb104-105" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col =</span> <span class="fu">as.factor</span>(<span class="st">`</span><span class="at">Model data</span><span class="st">`</span>),</span>
<span id="cb104-106"><a href="#cb104-106" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> <span class="fu">as.factor</span>(<span class="st">`</span><span class="at">Model data</span><span class="st">`</span>) )) <span class="sc">+</span></span>
<span id="cb104-107"><a href="#cb104-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb104-108"><a href="#cb104-108" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Bayes test"</span> <span class="ot">=</span> <span class="st">"purple"</span>, <span class="st">"Bayes train"</span> <span class="ot">=</span> <span class="st">"green"</span>,</span>
<span id="cb104-109"><a href="#cb104-109" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boosting: Logitboost test"</span> <span class="ot">=</span> <span class="st">"orange"</span>, <span class="st">"Boosting: Logitboost train"</span> <span class="ot">=</span> <span class="st">"dodgerblue"</span>,</span>
<span id="cb104-110"><a href="#cb104-110" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boosting: MART test"</span> <span class="ot">=</span> <span class="st">"orange"</span>, <span class="st">"Boosting: MART train"</span> <span class="ot">=</span> <span class="st">"dodgerblue"</span>,</span>
<span id="cb104-111"><a href="#cb104-111" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boosting: Adaboost test"</span> <span class="ot">=</span> <span class="st">"orange"</span>, <span class="st">"Boosting: Adaboost train"</span> <span class="ot">=</span> <span class="st">"dodgerblue"</span> )) <span class="sc">+</span></span>
<span id="cb104-112"><a href="#cb104-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb104-113"><a href="#cb104-113" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Bayes test"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Bayes train"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb104-114"><a href="#cb104-114" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boosting: Logitboost test"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Boosting: Logitboost train"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb104-115"><a href="#cb104-115" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boosting: MART test"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"Boosting: MART train"</span> <span class="ot">=</span> <span class="dv">2</span>,</span>
<span id="cb104-116"><a href="#cb104-116" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Boosting: Adaboost test"</span> <span class="ot">=</span> <span class="dv">3</span>, <span class="st">"Boosting: Adaboost train"</span> <span class="ot">=</span> <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb104-117"><a href="#cb104-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb104-118"><a href="#cb104-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">col =</span> <span class="cn">NULL</span>, <span class="at">linetype=</span><span class="cn">NULL</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="exercise" class="level3" data-number="2.7.3">
<h3 data-number="2.7.3" class="anchored" data-anchor-id="exercise"><span class="header-section-number">2.7.3</span> Exercise</h3>
<p>Compare testing error on reference data set for various: gradient boosting algorithm / number of boosting iterations / shrink-learning rate parameters (see for example <a href="https://scikit-learn.org/1.5/auto_examples/ensemble/plot_gradient_boosting_regularization.html">here</a>).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sec-robust-logitboost_imp" class="level3" data-number="2.7.4">
<h3 data-number="2.7.4" class="anchored" data-anchor-id="sec-robust-logitboost_imp"><span class="header-section-number">2.7.4</span> Ping Li Robust LogitBoost</h3>
<p>We then investigate a more recent version of LogitBoost algorithm introduced in <span class="citation" data-cites="pingli2010">Ping (<a href="#ref-pingli2010" role="doc-biblioref">2010</a>)</span>, allowing to partially bridge the gap between the original <span class="citation" data-cites="fht2000">Friedman, Hastie, and Tibshirani (<a href="#ref-fht2000" role="doc-biblioref">2000</a>)</span> LogitBoost and the more recent and state of the art <code>xgboost</code> implementation of <span class="citation" data-cites="xgboost2016">Chen and Guestrin (<a href="#ref-xgboost2016" role="doc-biblioref">2016</a>)</span>.</p>
<p><img src="../images/robust_logitboost_algo.png" class="img-fluid" data-fig-align="center"> Both have in common that they use Decision Trees with a specific tree-split criterion (versus the more common Regression Tree):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/robust_logitboost_gain1.png" class="img-fluid figure-img"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/robust_logitboost_gain2.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>To be compared with <code>xgboost</code> criterion, defined for a more generic loss with gradients <span class="math inline">\(g_i\)</span> and second derivative <span class="math inline">\(h_i\)</span>, index <span class="math inline">\(j\)</span> designing the <span class="math inline">\(j-th\)</span> leaf <span class="math inline">\(I_j\)</span> of the tree:</p>
<ul>
<li><p><span class="math inline">\(G_j = \sum_{i\in I_j} g_i\)</span></p></li>
<li><p><span class="math inline">\(H_j = \sum_{i\in I_j} h_i\)</span></p></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/xgboost_gain.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>The underlying idea common to both Robust LogitBoost and <code>xgboost</code> is to take advantage of some simplifications that occur for Gradient Boosting / Newton methods when base learners are Decision Trees.</p>
<p>In particular it is possible to show that the problem is equivalent to fitting a Decision Tree using a Sum of Squares criterion (Regression tree) involving the gradient and the hessian of any convex loss.</p>
<p>In <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span>, authors suggest that AdaBoost or any comparable FSAM could be fitted using “specialized” trees (ie using specific gain used to split), but prefer to follow the approach of Friedman’s Gradient Boosting <span class="citation" data-cites="gbm2001">Friedman (<a href="#ref-gbm2001" role="doc-biblioref">2001</a>)</span> which at that time was supposed more robust and straightforward:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/ESL_specialized_trees.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>We implement here the <span class="citation" data-cites="pingli2010">Ping (<a href="#ref-pingli2010" role="doc-biblioref">2010</a>)</span> Robust LogitBoost method with “specialized” splitting criterion, re-using our implementation from scratch of a Decision Tree at the start of the course.</p>
<p>We have to slightly modifying the implementation, as we need a Decision Trees dealing with regression problems and specific tree-split criterias/gains.</p>
<p>First we define the specialized <code>xgboost</code> / Robust LogitBoost gain function (using Gradient, Hessian, and penalty <span class="math inline">\(\lambda\)</span>):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>xgboost_gain <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, y, <span class="at">verbose =</span> <span class="cn">FALSE</span>){</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assumes tbl contains a probability (prob) column and </span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># response (r in {0,1}) column</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># allowing to compute - grad = r - prob and hessian = prob * (1 - prob)</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># expects lambda parameter (l2 regularization)</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(tbl) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  gain <span class="ot">&lt;-</span> tbl <span class="sc">%&gt;%</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">gain =</span> <span class="sc">-</span> <span class="fu">sum</span>(grad) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> (<span class="fu">sum</span>(hessian) <span class="sc">+</span> <span class="fu">mean</span>(lambda))) <span class="sc">%&gt;%</span> </span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(gain)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  gain</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we slightly modify the other involved functions to adapt the problem to a regression setting (the implementation at the start of the lesson was dedicated to a binary classification problem):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>gain_sum_square <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl_node, y_name, x_name,</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>                            split_value, <span class="at">min_leaf =</span> <span class="dv">5</span>){</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Whenever any of left/right child node contains less than </span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># min_leaf observations we return a default value for impurity</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># excluding de facto the split to be taken into account</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    ret_default <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"impurity_left"</span><span class="ot">=</span><span class="dv">666</span>,</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_right"</span><span class="ot">=</span><span class="dv">666</span>,</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_total"</span><span class="ot">=</span><span class="dv">666</span>)</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    tbl_left <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name <span class="sc">&lt;</span> <span class="sc">!!</span>split_value)</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>    n_left <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tbl_left)</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_left <span class="sc">&lt;</span> min_leaf){<span class="fu">return</span>(ret_default)} </span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>    impurity_left <span class="ot">&lt;-</span> <span class="fu">xgboost_gain</span>(tbl_left, y_name)</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>    tbl_right <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name <span class="sc">&gt;=!!</span>split_value)</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>    n_right <span class="ot">&lt;-</span> <span class="fu">nrow</span>(tbl_right)</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_right <span class="sc">&lt;</span> min_leaf){<span class="fu">return</span>(ret_default)}</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>    impurity_right <span class="ot">&lt;-</span> <span class="fu">xgboost_gain</span>(tbl_right, y_name)</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">"impurity_left"</span> <span class="ot">=</span> impurity_left,</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_right"</span> <span class="ot">=</span> impurity_right,</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"impurity_total"</span> <span class="ot">=</span> impurity_left <span class="sc">+</span> impurity_right))</span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># similar to max_impurity_decrease for decision tree</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>max_gain <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl_node, y_name, x_names,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">min_leaf =</span> <span class="dv">5</span>, <span class="at">midpoint =</span> <span class="cn">FALSE</span>){</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    imp_node <span class="ot">=</span> <span class="fu">xgboost_gain</span>(tbl_node, y_name)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    list_all_x <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    tbl_res <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">feature_split =</span> <span class="st">"zzz"</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">split_rule =</span> <span class="sc">-</span><span class="dv">666</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">imp_left =</span> <span class="dv">666</span>,</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">imp_right =</span> <span class="dv">666</span>, </span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">imp_total =</span> <span class="dv">666</span>)</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (x_name <span class="cf">in</span> x_names){</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>        list_x <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>       <span class="co"># print(x_name)</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>        splits <span class="ot">&lt;-</span> <span class="fu">unique</span>(tbl_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(x_name))</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># modify the algorithm to split on 'midpoint' value </span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for continuous variable (some decision trees do (CART) other don't (C4.5))</span></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(midpoint){</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>            splits <span class="ot">&lt;-</span> <span class="fu">sort</span>(splits)</span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>            splits <span class="ot">&lt;-</span> splits[<span class="sc">-</span><span class="fu">length</span>(splits)] <span class="sc">+</span> <span class="fu">diff</span>(splits)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (split <span class="cf">in</span> splits){</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(split)</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>            imp_dec <span class="ot">&lt;-</span> <span class="fu">gain_sum_square</span>(tbl_node, y_name,</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>                                       x_name, split, min_leaf)</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># list_x[[j]] &lt;- c(split, imp_dec)</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>            tbl_res <span class="ot">&lt;-</span>  <span class="fu">bind_rows</span>(tbl_res,</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">tibble</span>(<span class="at">feature_split =</span> <span class="fu">as.character</span>(x_name),</span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">split_rule =</span> split,</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">imp_node =</span> imp_node,</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">imp_left =</span> imp_dec[[<span class="st">"impurity_left"</span>]],</span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">imp_right =</span> imp_dec[[<span class="st">"impurity_right"</span>]],</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">imp_total =</span> imp_dec[[<span class="st">"impurity_total"</span>]]))</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>        }   </span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(tbl_res)</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We show below how the best split is performed for a single node using the new criterion / gain:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add pro/hessian, parameters columns for xgboost method</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>tbl_node <span class="ot">&lt;-</span> data_mixture_example <span class="sc">%&gt;%</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y)),</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">prob =</span> <span class="fl">0.5</span>,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">grad =</span> <span class="sc">-</span>(r <span class="sc">-</span> prob),</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">hessian =</span> prob <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prob),</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">lambda =</span> <span class="fl">0.0</span>,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">gamma =</span> <span class="fl">0.0</span>)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>y_name <span class="ot">&lt;-</span> <span class="fu">as.name</span>(<span class="st">"Y"</span>)</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>x_name <span class="ot">=</span> <span class="fu">as.name</span>(<span class="st">"x2"</span>)</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>split_value <span class="ot">=</span> <span class="fl">0.1441271</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a><span class="fu">gain_sum_square</span>(tbl_node, y_name, x_name, split_value, <span class="at">min_leaf =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$impurity_left
[1] -37.23077

$impurity_right
[1] -13.08108

$impurity_total
[1] -50.31185</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>x_names <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"x1"</span>), <span class="fu">as.name</span>(<span class="st">"x2"</span>))</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">max_gain</span>(tbl_node, y_name, x_names, <span class="at">min_leaf =</span> <span class="dv">1</span>, <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>(test <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(feature_split<span class="sc">!=</span><span class="st">"zzz"</span>, imp_total <span class="sc">!=</span> <span class="dv">666</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(imp_total))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["feature_split"],"name":[1],"type":["chr"],"align":["left"]},{"label":["split_rule"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["imp_left"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["imp_right"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["imp_total"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["imp_node"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"x2","2":"0.144127050","3":"-37.230769231","4":"-13.081081081","5":"-50.31185031","6":"0"},{"1":"x2","2":"0.547790627","3":"-30.392405063","4":"-19.842975207","5":"-50.23538027","6":"0"},{"1":"x2","2":"0.120182536","3":"-36.254901961","4":"-12.409395973","5":"-48.66429793","6":"0"},{"1":"x2","2":"0.534664626","3":"-29.538461538","4":"-18.885245902","5":"-48.42370744","6":"0"},{"1":"x2","2":"0.554175093","3":"-28.800000000","4":"-19.200000000","5":"-48.00000000","6":"0"},{"1":"x2","2":"0.157958496","3":"-34.886792453","4":"-12.578231293","5":"-47.46502375","6":"0"},{"1":"x2","2":"0.088134465","3":"-35.280000000","4":"-11.760000000","5":"-47.04000000","6":"0"},{"1":"x2","2":"0.515136621","3":"-28.688311688","4":"-17.959349593","5":"-46.64766128","6":"0"},{"1":"x2","2":"0.391519195","3":"-30.228571429","4":"-16.276923077","5":"-46.50549451","6":"0"},{"1":"x2","2":"0.927962775","3":"-21.333333333","4":"-25.043478261","5":"-46.37681159","6":"0"},{"1":"x2","2":"0.185527377","3":"-33.618181818","4":"-12.751724138","5":"-46.36990596","6":"0"},{"1":"x2","2":"0.914579475","3":"-21.735849057","4":"-24.510638298","5":"-46.24648735","6":"0"},{"1":"x2","2":"0.442197569","3":"-29.388888889","4":"-16.531250000","5":"-45.92013889","6":"0"},{"1":"x2","2":"0.571395257","3":"-27.271604938","4":"-18.563025210","5":"-45.83463015","6":"0"},{"1":"x2","2":"0.360105971","3":"-30.223880597","4":"-15.225563910","5":"-45.44944451","6":"0"},{"1":"x2","2":"0.071873079","3":"-34.306122449","4":"-11.132450331","5":"-45.43857278","6":"0"},{"1":"x2","2":"0.211267592","3":"-32.438596491","4":"-12.930069930","5":"-45.36866642","6":"0"},{"1":"x2","2":"0.497828851","3":"-27.842105263","4":"-17.064516129","5":"-44.90662139","6":"0"},{"1":"x2","2":"0.370913398","3":"-29.347826087","4":"-15.458015267","5":"-44.80584135","6":"0"},{"1":"x2","2":"0.174975628","3":"-32.666666667","4":"-12.082191781","5":"-44.74885845","6":"0"},{"1":"x2","2":"0.721642885","3":"-24.820224719","4":"-19.900900901","5":"-44.72112562","6":"0"},{"1":"x2","2":"0.740580234","3":"-24.274725275","4":"-20.266055046","5":"-44.54078032","6":"0"},{"1":"x2","2":"0.948106938","3":"-20.266055046","4":"-24.274725275","5":"-44.54078032","6":"0"},{"1":"x2","2":"0.918941357","3":"-20.644859813","4":"-23.752688172","5":"-44.39754799","6":"0"},{"1":"x2","2":"0.906327130","3":"-21.038095238","4":"-23.252631579","5":"-44.29072682","6":"0"},{"1":"x2","2":"0.408842992","3":"-28.521126761","4":"-15.697674419","5":"-44.21880118","6":"0"},{"1":"x2","2":"0.050957326","3":"-33.333333333","4":"-10.526315789","5":"-43.85964912","6":"0"},{"1":"x2","2":"0.353236783","3":"-29.333333333","4":"-14.447761194","5":"-43.78109453","6":"0"},{"1":"x2","2":"0.196739844","3":"-31.500000000","4":"-12.250000000","5":"-43.75000000","6":"0"},{"1":"x2","2":"0.617774733","3":"-25.804878049","4":"-17.932203390","5":"-43.73708144","6":"0"},{"1":"x2","2":"0.475913812","3":"-27.739726027","4":"-15.944881890","5":"-43.68460792","6":"0"},{"1":"x2","2":"0.487319239","3":"-27.000000000","4":"-16.200000000","5":"-43.20000000","6":"0"},{"1":"x2","2":"0.362280275","3":"-28.470588235","4":"-14.666666667","5":"-43.13725490","6":"0"},{"1":"x2","2":"0.711245492","3":"-24.045454545","4":"-18.892857143","5":"-42.93831169","6":"0"},{"1":"x2","2":"0.976432997","3":"-18.892857143","4":"-24.045454545","5":"-42.93831169","6":"0"},{"1":"x2","2":"0.228074287","3":"-30.413793103","4":"-12.422535211","5":"-42.83632831","6":"0"},{"1":"x2","2":"0.732346059","3":"-23.511111111","4":"-19.236363636","5":"-42.74747475","6":"0"},{"1":"x2","2":"0.960969286","3":"-19.236363636","4":"-23.511111111","5":"-42.74747475","6":"0"},{"1":"x2","2":"0.756999719","3":"-23.000000000","4":"-19.592592593","5":"-42.59259259","6":"0"},{"1":"x2","2":"0.789308371","3":"-22.510638298","4":"-19.962264151","5":"-42.47290245","6":"0"},{"1":"x2","2":"0.893954198","3":"-20.346153846","4":"-22.041666667","5":"-42.38782051","6":"0"},{"1":"x2","2":"0.028450325","3":"-32.361702128","4":"-9.941176471","5":"-42.30287860","6":"0"},{"1":"x2","2":"0.337015046","3":"-28.446153846","4":"-13.696296296","5":"-42.14245014","6":"0"},{"1":"x2","2":"0.018947326","3":"-32.818181818","4":"-9.256410256","5":"-42.07459207","6":"0"},{"1":"x2","2":"0.652135010","3":"-24.397590361","4":"-17.307692308","5":"-41.70528267","6":"0"},{"1":"x2","2":"0.482591480","3":"-26.162162162","4":"-15.365079365","5":"-41.52724153","6":"0"},{"1":"x2","2":"1.017749622","3":"-17.608695652","4":"-23.823529412","5":"-41.43222506","6":"0"},{"1":"x2","2":"0.699303196","3":"-23.275862069","4":"-17.920353982","5":"-41.19621605","6":"0"},{"1":"x2","2":"0.985655055","3":"-17.920353982","4":"-23.275862069","5":"-41.19621605","6":"0"},{"1":"x2","2":"0.967851753","3":"-18.243243243","4":"-22.752808989","5":"-40.99605223","6":"0"},{"1":"x2","2":"0.023951306","3":"-31.391304348","4":"-9.376623377","5":"-40.76792772","6":"0"},{"1":"x2","2":"0.774462760","3":"-21.774193548","4":"-18.925233645","5":"-40.69942719","6":"0"},{"1":"x2","2":"0.805236430","3":"-21.315789474","4":"-19.285714286","5":"-40.60150376","6":"0"},{"1":"x2","2":"0.013437408","3":"-31.837209302","4":"-8.719745223","5":"-40.55695453","6":"0"},{"1":"x2","2":"0.884892391","3":"-19.660194175","4":"-20.876288660","5":"-40.53648283","6":"0"},{"1":"x2","2":"0.324673136","3":"-27.562500000","4":"-12.970588235","5":"-40.53308824","6":"0"},{"1":"x2","2":"0.256760851","3":"-28.491525424","4":"-11.921985816","5":"-40.41351124","6":"0"},{"1":"x2","2":"0.660238420","3":"-23.047619048","4":"-16.689655172","5":"-39.73727422","6":"0"},{"1":"x2","2":"1.032714452","3":"-16.689655172","4":"-23.047619048","5":"-39.73727422","6":"0"},{"1":"x2","2":"0.297217160","3":"-27.557377049","4":"-12.093525180","5":"-39.65090223","6":"0"},{"1":"x2","2":"0.682976119","3":"-22.511627907","4":"-16.982456140","5":"-39.49408405","6":"0"},{"1":"x2","2":"1.000596327","3":"-16.982456140","4":"-22.511627907","5":"-39.49408405","6":"0"},{"1":"x2","2":"0.021578533","3":"-30.422222222","4":"-8.832258065","5":"-39.25448029","6":"0"},{"1":"x2","2":"-0.010036481","3":"-30.857142857","4":"-8.202531646","5":"-39.05967450","6":"0"},{"1":"x2","2":"0.322181212","3":"-26.682539683","4":"-12.270072993","5":"-38.95261268","6":"0"},{"1":"x2","2":"0.811008886","3":"-20.166666667","4":"-18.615384615","5":"-38.78205128","6":"0"},{"1":"x2","2":"0.880098484","3":"-18.980392157","4":"-19.755102041","5":"-38.73549420","6":"0"},{"1":"x2","2":"0.280272002","3":"-26.666666667","4":"-11.428571429","5":"-38.09523810","6":"0"},{"1":"x2","2":"1.039045071","3":"-15.803418803","4":"-22.277108434","5":"-38.08052724","6":"0"},{"1":"x2","2":"0.669131531","3":"-21.752941176","4":"-16.078260870","5":"-37.83120205","6":"0"},{"1":"x2","2":"-0.047145716","3":"-29.878048780","4":"-7.704402516","5":"-37.58245130","6":"0"},{"1":"x2","2":"0.313762761","3":"-25.806451613","4":"-11.594202899","5":"-37.40065451","6":"0"},{"1":"x2","2":"0.813344671","3":"-19.061855670","4":"-17.951456311","5":"-37.01331198","6":"0"},{"1":"x2","2":"0.871949267","3":"-18.306930693","4":"-18.676767677","5":"-36.98369837","6":"0"},{"1":"x2","2":"-0.344325580","3":"-31.000000000","4":"-5.686390533","5":"-36.68639053","6":"0"},{"1":"x2","2":"1.039581815","3":"-14.949152542","4":"-21.512195122","5":"-36.46134766","6":"0"},{"1":"x2","2":"-0.074866436","3":"-28.900000000","4":"-7.225000000","5":"-36.12500000","6":"0"},{"1":"x2","2":"-0.388096913","3":"-30.000000000","4":"-5.294117647","5":"-35.29411765","6":"0"},{"1":"x2","2":"0.833022205","3":"-18.000000000","4":"-17.294117647","5":"-35.29411765","6":"0"},{"1":"x2","2":"0.861386809","3":"-17.640000000","4":"-17.640000000","5":"-35.28000000","6":"0"},{"1":"x2","2":"1.046115947","3":"-14.126050420","4":"-20.753086420","5":"-34.87913684","6":"0"},{"1":"x2","2":"-0.302126088","3":"-29.121212121","4":"-5.754491018","5":"-34.87570314","6":"0"},{"1":"x2","2":"-0.218568171","3":"-28.444444444","4":"-6.243902439","5":"-34.68834688","6":"0"},{"1":"x2","2":"-0.097168978","3":"-27.923076923","4":"-6.763975155","5":"-34.68705208","6":"0"},{"1":"x2","2":"-0.436467654","3":"-29.000000000","4":"-4.918128655","5":"-33.91812865","6":"0"},{"1":"x2","2":"1.168907492","3":"-11.610687023","4":"-22.043478261","5":"-33.65416528","6":"0"},{"1":"x2","2":"1.082508838","3":"-13.114754098","4":"-20.512820513","5":"-33.62757461","6":"0"},{"1":"x2","2":"0.853921283","3":"-16.979797980","4":"-16.643564356","5":"-33.62336234","6":"0"},{"1":"x2","2":"-0.320273225","3":"-28.125000000","4":"-5.357142857","5":"-33.48214286","6":"0"},{"1":"x2","2":"1.055191443","3":"-13.333333333","4":"-20.000000000","5":"-33.33333333","6":"0"},{"1":"x2","2":"-0.277455925","3":"-27.457142857","4":"-5.824242424","5":"-33.28138528","6":"0"},{"1":"x2","2":"-0.137177518","3":"-26.947368421","4":"-6.320987654","5":"-33.26835608","6":"0"},{"1":"x2","2":"1.159886924","3":"-11.790697674","4":"-21.422535211","5":"-33.21323289","6":"0"},{"1":"x2","2":"-0.455308276","3":"-28.000000000","4":"-4.558139535","5":"-32.55813953","6":"0"},{"1":"x2","2":"1.172413276","3":"-10.939393939","4":"-21.235294118","5":"-32.17468806","6":"0"},{"1":"x2","2":"1.087748970","3":"-12.365853659","4":"-19.753246753","5":"-32.11910041","6":"0"},{"1":"x2","2":"-0.289159758","3":"-26.470588235","4":"-5.421686747","5":"-31.89227498","6":"0"},{"1":"x2","2":"-0.165653850","3":"-25.972972973","4":"-5.895705521","5":"-31.86867849","6":"0"},{"1":"x2","2":"1.068990472","3":"-12.570247934","4":"-19.253164557","5":"-31.82341249","6":"0"},{"1":"x2","2":"1.166676782","3":"-11.107692308","4":"-20.628571429","5":"-31.73626374","6":"0"},{"1":"x2","2":"1.151247636","3":"-11.281250000","4":"-20.055555556","5":"-31.33680556","6":"0"},{"1":"x2","2":"-0.467702844","3":"-27.000000000","4":"-4.213872832","5":"-31.21387283","6":"0"},{"1":"x2","2":"1.220099117","3":"-10.140740741","4":"-21.061538462","5":"-31.20227920","6":"0"},{"1":"x2","2":"1.121776001","3":"-11.460317460","4":"-19.513513514","5":"-30.97383097","6":"0"},{"1":"x2","2":"1.187996492","3":"-10.293233083","4":"-20.432835821","5":"-30.72606890","6":"0"},{"1":"x2","2":"1.097114236","3":"-11.645161290","4":"-19.000000000","5":"-30.64516129","6":"0"},{"1":"x2","2":"-0.480683653","3":"-26.000000000","4":"-3.885057471","5":"-29.88505747","6":"0"},{"1":"x2","2":"1.233425640","3":"-9.529411765","4":"-20.250000000","5":"-29.77941176","6":"0"},{"1":"x2","2":"1.141991862","3":"-10.779527559","4":"-18.753424658","5":"-29.53295222","6":"0"},{"1":"x2","2":"1.208719042","3":"-9.671641791","4":"-19.636363636","5":"-29.30800543","6":"0"},{"1":"x2","2":"1.105898997","3":"-10.952000000","4":"-18.253333333","5":"-29.20533333","6":"0"},{"1":"x2","2":"-0.506270920","3":"-25.000000000","4":"-3.571428571","5":"-28.57142857","6":"0"},{"1":"x2","2":"1.246613677","3":"-8.941605839","4":"-19.444444444","5":"-28.38605028","6":"0"},{"1":"x2","2":"1.280043595","3":"-8.140845070","4":"-19.931034483","5":"-28.07187955","6":"0"},{"1":"x2","2":"1.371289347","3":"-7.510344828","4":"-19.800000000","5":"-27.31034483","6":"0"},{"1":"x2","2":"-0.541135679","3":"-24.000000000","4":"-3.272727273","5":"-27.27272727","6":"0"},{"1":"x2","2":"1.250664357","3":"-8.376811594","4":"-18.645161290","5":"-27.02197288","6":"0"},{"1":"x2","2":"1.320283783","3":"-7.615384615","4":"-19.105263158","5":"-26.72064777","6":"0"},{"1":"x2","2":"1.275324281","3":"-7.723404255","4":"-18.457627119","5":"-26.18103137","6":"0"},{"1":"x2","2":"-0.642498845","3":"-23.000000000","4":"-2.988700565","5":"-25.98870056","6":"0"},{"1":"x2","2":"1.384334493","3":"-7.013698630","4":"-18.962962963","5":"-25.97666159","6":"0"},{"1":"x2","2":"1.458952238","3":"-6.364238411","4":"-19.612244898","5":"-25.97648331","6":"0"},{"1":"x2","2":"1.256168135","3":"-7.834532374","4":"-17.852459016","5":"-25.68699139","6":"0"},{"1":"x2","2":"1.357945755","3":"-7.111111111","4":"-18.285714286","5":"-25.39682540","6":"0"},{"1":"x2","2":"1.423046616","3":"-6.449664430","4":"-18.843137255","5":"-25.29280168","6":"0"},{"1":"x2","2":"-0.735261938","3":"-22.000000000","4":"-2.719101124","5":"-24.71910112","6":"0"},{"1":"x2","2":"1.475186518","3":"-5.921052632","4":"-18.750000000","5":"-24.67105263","6":"0"},{"1":"x2","2":"1.391794511","3":"-6.537414966","4":"-18.132075472","5":"-24.66949044","6":"0"},{"1":"x2","2":"1.267556398","3":"-7.314285714","4":"-17.066666667","5":"-24.38095238","6":"0"},{"1":"x2","2":"1.442636931","3":"-6.000000000","4":"-18.000000000","5":"-24.00000000","6":"0"},{"1":"x2","2":"-0.740013975","3":"-21.000000000","4":"-2.463687151","5":"-23.46368715","6":"0"},{"1":"x2","2":"1.490831014","3":"-5.496732026","4":"-17.893617021","5":"-23.39034905","6":"0"},{"1":"x2","2":"1.408584627","3":"-6.081081081","4":"-17.307692308","5":"-23.38877339","6":"0"},{"1":"x2","2":"1.629422811","3":"-4.527950311","4":"-18.692307692","5":"-23.22025800","6":"0"},{"1":"x2","2":"-0.743892544","3":"-20.000000000","4":"-2.222222222","5":"-22.22222222","6":"0"},{"1":"x2","2":"1.518654559","3":"-5.090909091","4":"-17.043478261","5":"-22.13438735","6":"0"},{"1":"x2","2":"1.640319076","3":"-4.172839506","4":"-17.789473684","5":"-21.96231319","6":"0"},{"1":"x2","2":"1.617159997","3":"-4.225000000","4":"-16.900000000","5":"-21.12500000","6":"0"},{"1":"x2","2":"-0.753390373","3":"-19.000000000","4":"-1.994475138","5":"-20.99447514","6":"0"},{"1":"x2","2":"1.548231136","3":"-4.703225806","4":"-16.200000000","5":"-20.90322581","6":"0"},{"1":"x2","2":"1.675857692","3":"-3.834355828","4":"-16.891891892","5":"-20.72624772","6":"0"},{"1":"x2","2":"2.011507493","3":"-2.520000000","4":"-17.640000000","5":"-20.16000000","6":"0"},{"1":"x2","2":"-0.774491034","3":"-18.000000000","4":"-1.780219780","5":"-19.78021978","6":"0"},{"1":"x2","2":"1.558230300","3":"-4.333333333","4":"-15.363636364","5":"-19.69696970","6":"0"},{"1":"x2","2":"1.709499737","3":"-3.512195122","4":"-16.000000000","5":"-19.51219512","6":"0"},{"1":"x2","2":"1.594671197","3":"-3.930817610","4":"-15.243902439","5":"-19.17472005","6":"0"},{"1":"x2","2":"2.028065882","3":"-2.272727273","4":"-16.666666667","5":"-18.93939394","6":"0"},{"1":"x2","2":"1.966265867","3":"-2.549132948","4":"-16.333333333","5":"-18.88246628","6":"0"},{"1":"x1","2":"-0.967202093","3":"-17.000000000","4":"-1.579234973","5":"-18.57923497","6":"0"},{"1":"x2","2":"-0.808774842","3":"-17.000000000","4":"-1.579234973","5":"-18.57923497","6":"0"},{"1":"x2","2":"1.571708599","3":"-3.980891720","4":"-14.534883721","5":"-18.51577544","6":"0"},{"1":"x2","2":"1.716872530","3":"-3.206060606","4":"-15.114285714","5":"-18.32034632","6":"0"},{"1":"x2","2":"2.046892359","3":"-2.039548023","4":"-15.695652174","5":"-17.73520020","6":"0"},{"1":"x2","2":"2.005127989","3":"-2.298850575","4":"-15.384615385","5":"-17.68346596","6":"0"},{"1":"x1","2":"-1.079161601","3":"-16.000000000","4":"-1.391304348","5":"-17.39130435","6":"0"},{"1":"x2","2":"-0.866087056","3":"-16.000000000","4":"-1.391304348","5":"-17.39130435","6":"0"},{"1":"x2","2":"1.579373812","3":"-3.645569620","4":"-13.714285714","5":"-17.35985533","6":"0"},{"1":"x2","2":"1.727154586","3":"-2.915662651","4":"-14.235294118","5":"-17.15095677","6":"0"},{"1":"x2","2":"1.905999401","3":"-2.325581395","4":"-14.285714286","5":"-16.61129568","6":"0"},{"1":"x2","2":"2.064295301","3":"-1.820224719","4":"-14.727272727","5":"-16.54749745","6":"0"},{"1":"x1","2":"-1.149651072","3":"-15.000000000","4":"-1.216216216","5":"-16.21621622","6":"0"},{"1":"x2","2":"-0.902662472","3":"-15.000000000","4":"-1.216216216","5":"-16.21621622","6":"0"},{"1":"x2","2":"1.746327882","3":"-2.640718563","4":"-13.363636364","5":"-16.00435493","6":"0"},{"1":"x1","2":"-0.876494555","3":"-14.222222222","4":"-1.406593407","5":"-15.62881563","6":"0"},{"1":"x2","2":"2.092354630","3":"-1.614525140","4":"-13.761904762","5":"-15.37642990","6":"0"},{"1":"x1","2":"-0.130990783","3":"-11.755555556","4":"-3.412903226","5":"-15.16845878","6":"0"},{"1":"x1","2":"-1.166010838","3":"-14.000000000","4":"-1.053763441","5":"-15.05376344","6":"0"},{"1":"x2","2":"-0.911677940","3":"-14.000000000","4":"-1.053763441","5":"-15.05376344","6":"0"},{"1":"x2","2":"1.781265685","3":"-2.380952381","4":"-12.500000000","5":"-14.88095238","6":"0"},{"1":"x1","2":"-0.193759349","3":"-11.523809524","4":"-3.063291139","5":"-14.58710066","6":"0"},{"1":"x2","2":"1.879666014","3":"-2.111111111","4":"-12.448275862","5":"-14.55938697","6":"0"},{"1":"x1","2":"-0.765685505","3":"-12.800000000","4":"-1.422222222","5":"-14.22222222","6":"0"},{"1":"x2","2":"2.117206048","3":"-1.422222222","4":"-12.800000000","5":"-14.22222222","6":"0"},{"1":"x1","2":"-0.340891635","3":"-11.764705882","4":"-2.409638554","5":"-14.17434444","6":"0"},{"1":"x1","2":"2.008422239","3":"-2.409638554","4":"-11.764705882","5":"-14.17434444","6":"0"},{"1":"x1","2":"-0.160173135","3":"-11.000000000","4":"-3.102564103","5":"-14.10256410","6":"0"},{"1":"x1","2":"-1.212850157","3":"-13.000000000","4":"-0.903743316","5":"-13.90374332","6":"0"},{"1":"x2","2":"-0.967258554","3":"-13.000000000","4":"-0.903743316","5":"-13.90374332","6":"0"},{"1":"x2","2":"1.832690166","3":"-2.136094675","4":"-11.645161290","5":"-13.78125596","6":"0"},{"1":"x1","2":"0.063738864","3":"-9.600000000","4":"-4.114285714","5":"-13.71428571","6":"0"},{"1":"x1","2":"-0.094371255","3":"-10.521739130","4":"-3.142857143","5":"-13.66459627","6":"0"},{"1":"x1","2":"1.631979627","3":"-3.142857143","4":"-10.521739130","5":"-13.66459627","6":"0"},{"1":"x1","2":"-0.306961323","3":"-11.111111111","4":"-2.439024390","5":"-13.55013550","6":"0"},{"1":"x1","2":"-0.198464748","3":"-10.756097561","4":"-2.773584906","5":"-13.52968247","6":"0"},{"1":"x1","2":"-0.369134571","3":"-10.939393939","4":"-2.161676647","5":"-13.10107059","6":"0"},{"1":"x1","2":"2.098259914","3":"-2.161676647","4":"-10.939393939","5":"-13.10107059","6":"0"},{"1":"x1","2":"-0.822331453","3":"-11.842105263","4":"-1.243093923","5":"-13.08519919","6":"0"},{"1":"x2","2":"2.133824458","3":"-1.243093923","4":"-11.842105263","5":"-13.08519919","6":"0"},{"1":"x1","2":"-0.179398113","3":"-10.255813953","4":"-2.808917197","5":"-13.06473115","6":"0"},{"1":"x1","2":"0.023645797","3":"-9.280701754","4":"-3.699300699","5":"-12.98000245","6":"0"},{"1":"x1","2":"-1.260651263","3":"-12.000000000","4":"-0.765957447","5":"-12.76595745","6":"0"},{"1":"x2","2":"-1.018870440","3":"-12.000000000","4":"-0.765957447","5":"-12.76595745","6":"0"},{"1":"x1","2":"0.058664984","3":"-8.966101695","4":"-3.751773050","5":"-12.71787474","6":"0"},{"1":"x2","2":"1.868835835","3":"-1.905882353","4":"-10.800000000","5":"-12.70588235","6":"0"},{"1":"x1","2":"1.641501069","3":"-2.845161290","4":"-9.800000000","5":"-12.64516129","6":"0"},{"1":"x1","2":"-0.312327729","3":"-10.314285714","4":"-2.187878788","5":"-12.50216450","6":"0"},{"1":"x1","2":"1.936000627","3":"-2.187878788","4":"-10.314285714","5":"-12.50216450","6":"0"},{"1":"x1","2":"-0.228909720","3":"-10.000000000","4":"-2.500000000","5":"-12.50000000","6":"0"},{"1":"x1","2":"0.076973489","3":"-8.672131148","4":"-3.805755396","5":"-12.47788654","6":"0"},{"1":"x1","2":"-0.078348907","3":"-9.382978723","4":"-2.882352941","5":"-12.26533166","6":"0"},{"1":"x1","2":"1.618507237","3":"-2.882352941","4":"-9.382978723","5":"-12.26533166","6":"0"},{"1":"x1","2":"0.127503506","3":"-8.396825397","4":"-3.861313869","5":"-12.25813927","6":"0"},{"1":"x1","2":"-0.369901469","3":"-10.125000000","4":"-1.928571429","5":"-12.05357143","6":"0"},{"1":"x1","2":"2.125986653","3":"-1.928571429","4":"-10.125000000","5":"-12.05357143","6":"0"},{"1":"x1","2":"0.011051843","3":"-8.642857143","4":"-3.361111111","5":"-12.00396825","6":"0"},{"1":"x1","2":"-0.298818509","3":"-9.756756757","4":"-2.214723926","5":"-11.97148068","6":"0"},{"1":"x1","2":"-0.721180495","3":"-10.714285714","4":"-1.256983240","5":"-11.97126895","6":"0"},{"1":"x2","2":"2.161795724","3":"-1.076923077","4":"-10.888888889","5":"-11.96581197","6":"0"},{"1":"x1","2":"0.044751447","3":"-8.344827586","4":"-3.408450704","5":"-11.75327829","6":"0"},{"1":"x1","2":"2.245715263","3":"-1.690058480","4":"-9.965517241","5":"-11.65557572","6":"0"},{"1":"x1","2":"1.679038990","3":"-2.564102564","4":"-9.090909091","5":"-11.65501166","6":"0"},{"1":"x1","2":"-1.364775835","3":"-11.000000000","4":"-0.640211640","5":"-11.64021164","6":"0"},{"1":"x2","2":"-1.052589174","3":"-11.000000000","4":"-0.640211640","5":"-11.64021164","6":"0"},{"1":"x1","2":"-0.062362884","3":"-8.647058824","4":"-2.959731544","5":"-11.60679037","6":"0"},{"1":"x1","2":"1.527284148","3":"-2.959731544","4":"-8.647058824","5":"-11.60679037","6":"0"},{"1":"x1","2":"-0.260946478","3":"-9.256410256","4":"-2.242236025","5":"-11.49864628","6":"0"},{"1":"x1","2":"1.519604123","3":"-3.000000000","4":"-8.320754717","5":"-11.32075472","6":"0"},{"1":"x1","2":"0.106318090","3":"-7.806451613","4":"-3.507246377","5":"-11.31369799","6":"0"},{"1":"x1","2":"0.132166544","3":"-7.562500000","4":"-3.558823529","5":"-11.12132353","6":"0"},{"1":"x1","2":"1.745465059","3":"-2.270440252","4":"-8.804878049","5":"-11.07531830","6":"0"},{"1":"x1","2":"0.006687620","3":"-8.018181818","4":"-3.041379310","5":"-11.05956113","6":"0"},{"1":"x1","2":"-0.385535656","3":"-9.322580645","4":"-1.710059172","5":"-11.03263982","6":"0"},{"1":"x1","2":"2.161706725","3":"-1.710059172","4":"-9.322580645","5":"-11.03263982","6":"0"},{"1":"x1","2":"1.925872599","3":"-1.975609756","4":"-9.000000000","5":"-10.97560976","6":"0"},{"1":"x1","2":"-0.075596781","3":"-8.333333333","4":"-2.631578947","5":"-10.96491228","6":"0"},{"1":"x1","2":"1.602268766","3":"-2.631578947","4":"-8.333333333","5":"-10.96491228","6":"0"},{"1":"x2","2":"2.194519351","3":"-0.923497268","4":"-9.941176471","5":"-10.86467374","6":"0"},{"1":"x1","2":"1.720457380","3":"-2.299363057","4":"-8.395348837","5":"-10.69471189","6":"0"},{"1":"x1","2":"-0.071634769","3":"-8.000000000","4":"-2.666666667","5":"-10.66666667","6":"0"},{"1":"x1","2":"1.554617215","3":"-2.666666667","4":"-8.000000000","5":"-10.66666667","6":"0"},{"1":"x1","2":"-0.458471118","3":"-9.142857143","4":"-1.488372093","5":"-10.63122924","6":"0"},{"1":"x1","2":"2.273989564","3":"-1.488372093","4":"-9.142857143","5":"-10.63122924","6":"0"},{"1":"x1","2":"-1.496898212","3":"-10.000000000","4":"-0.526315789","5":"-10.52631579","6":"0"},{"1":"x1","2":"-0.280059514","3":"-8.526315789","4":"-2.000000000","5":"-10.52631579","6":"0"},{"1":"x1","2":"1.884304426","3":"-2.000000000","4":"-8.526315789","5":"-10.52631579","6":"0"},{"1":"x2","2":"-1.089027029","3":"-10.000000000","4":"-0.526315789","5":"-10.52631579","6":"0"},{"1":"x1","2":"0.263437909","3":"-6.722222222","4":"-3.781250000","5":"-10.50347222","6":"0"},{"1":"x1","2":"-0.036633607","3":"-7.692307692","4":"-2.702702703","5":"-10.39501040","6":"0"},{"1":"x1","2":"1.521612332","3":"-2.702702703","4":"-7.692307692","5":"-10.39501040","6":"0"},{"1":"x1","2":"-0.007174166","3":"-7.407407407","4":"-2.739726027","5":"-10.14713343","6":"0"},{"1":"x1","2":"1.514560822","3":"-2.739726027","4":"-7.407407407","5":"-10.14713343","6":"0"},{"1":"x1","2":"1.783006599","3":"-2.025000000","4":"-8.100000000","5":"-10.12500000","6":"0"},{"1":"x1","2":"0.163314997","3":"-6.784615385","4":"-3.266666667","5":"-10.05128205","6":"0"},{"1":"x1","2":"-0.407601693","3":"-8.533333333","4":"-1.505882353","5":"-10.03921569","6":"0"},{"1":"x1","2":"2.212630657","3":"-1.505882353","4":"-8.533333333","5":"-10.03921569","6":"0"},{"1":"x1","2":"-0.698439785","3":"-8.909090909","4":"-1.101123596","5":"-10.01021450","6":"0"},{"1":"x2","2":"2.224876422","3":"-0.782608696","4":"-9.000000000","5":"-9.78260870","6":"0"},{"1":"x1","2":"1.733711767","3":"-2.050632911","4":"-7.714285714","5":"-9.76491863","6":"0"},{"1":"x1","2":"-0.073026734","3":"-7.367346939","4":"-2.390728477","5":"-9.75807542","6":"0"},{"1":"x1","2":"1.584150665","3":"-2.390728477","4":"-7.367346939","5":"-9.75807542","6":"0"},{"1":"x1","2":"-0.528861076","3":"-8.333333333","4":"-1.300578035","5":"-9.63391137","6":"0"},{"1":"x1","2":"2.287653678","3":"-1.300578035","4":"-8.333333333","5":"-9.63391137","6":"0"},{"1":"x1","2":"0.259157162","3":"-6.211267606","4":"-3.418604651","5":"-9.62987226","6":"0"},{"1":"x1","2":"1.911441246","3":"-1.773006135","4":"-7.810810811","5":"-9.58381695","6":"0"},{"1":"x1","2":"0.289113645","3":"-6.041095890","4":"-3.472440945","5":"-9.51353684","6":"0"},{"1":"x1","2":"-1.653015830","3":"-9.000000000","4":"-0.424083770","5":"-9.42408377","6":"0"},{"1":"x2","2":"-1.104715468","3":"-9.000000000","4":"-0.424083770","5":"-9.42408377","6":"0"},{"1":"x1","2":"-0.628745662","3":"-8.166666667","4":"-1.113636364","5":"-9.28030303","6":"0"},{"1":"x1","2":"-0.019714816","3":"-6.811320755","4":"-2.455782313","5":"-9.26710307","6":"0"},{"1":"x1","2":"1.843862464","3":"-1.795031056","4":"-7.410256410","5":"-9.20528747","6":"0"},{"1":"x1","2":"-0.422045625","3":"-7.758620690","4":"-1.315789474","5":"-9.07441016","6":"0"},{"1":"x1","2":"1.498537697","3":"-2.489655172","4":"-6.563636364","5":"-9.05329154","6":"0"},{"1":"x1","2":"0.198736327","3":"-6.060606061","4":"-2.985074627","5":"-9.04568069","6":"0"},{"1":"x1","2":"0.227092261","3":"-5.882352941","4":"-3.030303030","5":"-8.91265597","6":"0"},{"1":"x1","2":"0.257815490","3":"-5.714285714","4":"-3.076923077","5":"-8.79120879","6":"0"},{"1":"x2","2":"2.248765708","3":"-0.654054054","4":"-8.066666667","5":"-8.72072072","6":"0"},{"1":"x1","2":"-0.576393093","3":"-7.538461538","4":"-1.126436782","5":"-8.66489832","6":"0"},{"1":"x1","2":"2.316403943","3":"-1.126436782","4":"-7.538461538","5":"-8.66489832","6":"0"},{"1":"x1","2":"0.315386592","3":"-5.405405405","4":"-3.174603175","5":"-8.58000858","6":"0"},{"1":"x1","2":"-1.786606349","3":"-8.000000000","4":"-0.333333333","5":"-8.33333333","6":"0"},{"1":"x2","2":"-1.137641979","3":"-8.000000000","4":"-0.333333333","5":"-8.33333333","6":"0"},{"1":"x1","2":"-0.675020608","3":"-7.347826087","4":"-0.954802260","5":"-8.30262835","6":"0"},{"1":"x1","2":"0.205323125","3":"-5.388059701","4":"-2.714285714","5":"-8.10234542","6":"0"},{"1":"x1","2":"1.486126253","3":"-2.250000000","4":"-5.785714286","5":"-8.03571429","6":"0"},{"1":"x1","2":"0.252739311","3":"-5.231884058","4":"-2.755725191","5":"-7.98760925","6":"0"},{"1":"x1","2":"1.454775900","3":"-2.281690141","4":"-5.586206897","5":"-7.86789704","6":"0"},{"1":"x1","2":"-0.585701264","3":"-6.760000000","4":"-0.965714286","5":"-7.72571429","6":"0"},{"1":"x1","2":"2.343248052","3":"-0.965714286","4":"-6.760000000","5":"-7.72571429","6":"0"},{"1":"x1","2":"0.321597379","3":"-4.813333333","4":"-2.888000000","5":"-7.70133333","6":"0"},{"1":"x2","2":"2.268426277","3":"-0.537634409","4":"-7.142857143","5":"-7.68049155","6":"0"},{"1":"x1","2":"-1.878533161","3":"-7.000000000","4":"-0.253886010","5":"-7.25388601","6":"0"},{"1":"x2","2":"-1.201689745","3":"-7.000000000","4":"-0.253886010","5":"-7.25388601","6":"0"},{"1":"x1","2":"1.476557023","3":"-2.020979021","4":"-5.070175439","5":"-7.09115446","6":"0"},{"1":"x1","2":"1.439360315","3":"-2.049645390","4":"-4.898305085","5":"-6.94795047","6":"0"},{"1":"x1","2":"0.324487798","3":"-4.263157895","4":"-2.612903226","5":"-6.87606112","6":"0"},{"1":"x1","2":"2.388334977","3":"-0.818181818","4":"-6.000000000","5":"-6.81818182","6":"0"},{"1":"x2","2":"2.287594811","3":"-0.433155080","4":"-6.230769231","5":"-6.66392431","6":"0"},{"1":"x1","2":"0.573081495","3":"-3.600000000","4":"-2.945454545","5":"-6.54545455","6":"0"},{"1":"x1","2":"-1.989175226","3":"-6.000000000","4":"-0.185567010","5":"-6.18556701","6":"0"},{"1":"x2","2":"-1.277999918","3":"-6.000000000","4":"-0.185567010","5":"-6.18556701","6":"0"},{"1":"x2","2":"2.506471896","3":"-0.185567010","4":"-6.000000000","5":"-6.18556701","6":"0"},{"1":"x1","2":"0.346361728","3":"-3.753246753","4":"-2.349593496","5":"-6.10284025","6":"0"},{"1":"x1","2":"1.434207044","3":"-1.828571429","4":"-4.266666667","5":"-6.09523810","6":"0"},{"1":"x1","2":"1.405444352","3":"-1.855072464","4":"-4.129032258","5":"-5.98410472","6":"0"},{"1":"x1","2":"2.457940694","3":"-0.683615819","4":"-5.260869565","5":"-5.94448538","6":"0"},{"1":"x1","2":"0.569344825","3":"-3.247191011","4":"-2.603603604","5":"-5.85079461","6":"0"},{"1":"x1","2":"0.617098440","3":"-3.175824176","4":"-2.651376147","5":"-5.82720032","6":"0"},{"1":"x2","2":"2.463904977","3":"-0.256544503","4":"-5.444444444","5":"-5.70098895","6":"0"},{"1":"x2","2":"2.357760543","3":"-0.340425532","4":"-5.333333333","5":"-5.67375887","6":"0"},{"1":"x1","2":"0.396215077","3":"-3.282051282","4":"-2.098360656","5":"-5.38041194","6":"0"},{"1":"x1","2":"0.434042093","3":"-3.200000000","4":"-2.133333333","5":"-5.33333333","6":"0"},{"1":"x1","2":"1.425836516","3":"-1.618705036","4":"-3.688524590","5":"-5.30722963","6":"0"},{"1":"x1","2":"0.512273572","3":"-2.976744186","4":"-2.245614035","5":"-5.22235822","6":"0"},{"1":"x1","2":"1.388561623","3":"-1.642335766","4":"-3.571428571","5":"-5.21376434","6":"0"},{"1":"x1","2":"0.547757702","3":"-2.909090909","4":"-2.285714286","5":"-5.19480519","6":"0"},{"1":"x1","2":"0.673761909","3":"-2.782608696","4":"-2.370370370","5":"-5.15297907","6":"0"},{"1":"x1","2":"0.692827857","3":"-2.723404255","4":"-2.415094340","5":"-5.13849859","6":"0"},{"1":"x1","2":"-2.045444735","3":"-5.000000000","4":"-0.128205128","5":"-5.12820513","6":"0"},{"1":"x2","2":"-1.360311292","3":"-5.000000000","4":"-0.128205128","5":"-5.12820513","6":"0"},{"1":"x2","2":"2.591893200","3":"-0.128205128","4":"-5.000000000","5":"-5.12820513","6":"0"},{"1":"x1","2":"2.486374030","3":"-0.561797753","4":"-4.545454545","5":"-5.10725230","6":"0"},{"1":"x2","2":"2.427516130","3":"-0.259259259","4":"-4.454545455","5":"-4.71380471","6":"0"},{"1":"x1","2":"0.429529284","3":"-2.848101266","4":"-1.859504132","5":"-4.70760540","6":"0"},{"1":"x2","2":"2.475893727","3":"-0.187500000","4":"-4.500000000","5":"-4.68750000","6":"0"},{"1":"x1","2":"0.436021838","3":"-2.777777778","4":"-1.890756303","5":"-4.66853408","6":"0"},{"1":"x1","2":"0.463075284","3":"-2.710843373","4":"-1.923076923","5":"-4.63392030","6":"0"},{"1":"x1","2":"0.498432285","3":"-2.647058824","4":"-1.956521739","5":"-4.60358056","6":"0"},{"1":"x1","2":"0.522563585","3":"-2.586206897","4":"-1.991150442","5":"-4.57735734","6":"0"},{"1":"x1","2":"0.689918813","3":"-2.419354839","4":"-2.102803738","5":"-4.52215858","6":"0"},{"1":"x1","2":"0.700989298","3":"-2.368421053","4":"-2.142857143","5":"-4.51127820","6":"0"},{"1":"x1","2":"0.760376009","3":"-2.319587629","4":"-2.184466019","5":"-4.50405365","6":"0"},{"1":"x1","2":"1.368437577","3":"-1.441176471","4":"-3.062500000","5":"-4.50367647","6":"0"},{"1":"x1","2":"1.341555767","3":"-1.462686567","4":"-2.969696970","5":"-4.43238354","6":"0"},{"1":"x1","2":"2.490392372","3":"-0.452513966","4":"-3.857142857","5":"-4.30965682","6":"0"},{"1":"x1","2":"-2.121260103","3":"-4.000000000","4":"-0.081632653","5":"-4.08163265","6":"0"},{"1":"x2","2":"-1.420970791","3":"-4.000000000","4":"-0.081632653","5":"-4.08163265","6":"0"},{"1":"x2","2":"2.676542931","3":"-0.081632653","4":"-4.000000000","5":"-4.08163265","6":"0"},{"1":"x1","2":"0.446442078","3":"-2.390243902","4":"-1.661016949","5":"-4.05126085","6":"0"},{"1":"x1","2":"0.479777646","3":"-2.333333333","4":"-1.689655172","5":"-4.02298851","6":"0"},{"1":"x1","2":"0.730537928","3":"-2.041666667","4":"-1.884615385","5":"-3.92628205","6":"0"},{"1":"x1","2":"0.793324533","3":"-2.000000000","4":"-1.921568627","5":"-3.92156863","6":"0"},{"1":"x1","2":"0.883894829","3":"-1.921568627","4":"-2.000000000","5":"-3.92156863","6":"0"},{"1":"x1","2":"0.859702019","3":"-1.960000000","4":"-1.960000000","5":"-3.92000000","6":"0"},{"1":"x1","2":"1.349902069","3":"-1.251851852","4":"-2.600000000","5":"-3.85185185","6":"0"},{"1":"x1","2":"1.318176011","3":"-1.270676692","4":"-2.522388060","5":"-3.79306475","6":"0"},{"1":"x2","2":"2.443501766","3":"-0.189473684","4":"-3.600000000","5":"-3.78947368","6":"0"},{"1":"x2","2":"2.485775494","3":"-0.129533679","4":"-3.571428571","5":"-3.70096225","6":"0"},{"1":"x1","2":"1.274924562","3":"-1.330708661","4":"-2.315068493","5":"-3.64577715","6":"0"},{"1":"x1","2":"2.495410682","3":"-0.355555556","4":"-3.200000000","5":"-3.55555556","6":"0"},{"1":"x1","2":"0.901418015","3":"-1.640776699","4":"-1.742268041","5":"-3.38304474","6":"0"},{"1":"x1","2":"0.829563721","3":"-1.707070707","4":"-1.673267327","5":"-3.38033803","6":"0"},{"1":"x1","2":"0.879468726","3":"-1.673267327","4":"-1.707070707","5":"-3.38033803","6":"0"},{"1":"x1","2":"1.301571730","3":"-1.090909091","4":"-2.117647059","5":"-3.20855615","6":"0"},{"1":"x1","2":"1.292294579","3":"-1.107692308","4":"-2.057142857","5":"-3.16483516","6":"0"},{"1":"x1","2":"1.281219232","3":"-1.125000000","4":"-2.000000000","5":"-3.12500000","6":"0"},{"1":"x1","2":"1.269803255","3":"-1.142857143","4":"-1.945945946","5":"-3.08880309","6":"0"},{"1":"x1","2":"-2.236532118","3":"-3.000000000","4":"-0.045685279","5":"-3.04568528","6":"0"},{"1":"x2","2":"-1.518017451","3":"-3.000000000","4":"-0.045685279","5":"-3.04568528","6":"0"},{"1":"x2","2":"2.704467163","3":"-0.045685279","4":"-3.000000000","5":"-3.04568528","6":"0"},{"1":"x1","2":"0.916050111","3":"-1.384615385","4":"-1.500000000","5":"-2.88461538","6":"0"},{"1":"x1","2":"2.512967809","3":"-0.270718232","4":"-2.578947368","5":"-2.84966560","6":"0"},{"1":"x1","2":"1.299184868","3":"-0.923664122","4":"-1.753623188","5":"-2.67728731","6":"0"},{"1":"x1","2":"1.285150394","3":"-0.937984496","4":"-1.704225352","5":"-2.64220985","6":"0"},{"1":"x1","2":"1.256877675","3":"-0.968000000","4":"-1.613333333","5":"-2.58133333","6":"0"},{"1":"x1","2":"0.931503423","3":"-1.152380952","4":"-1.273684211","5":"-2.42606516","6":"0"},{"1":"x1","2":"2.538769561","3":"-0.197802198","4":"-2.000000000","5":"-2.19780220","6":"0"},{"1":"x1","2":"1.241604219","3":"-0.806451613","4":"-1.315789474","5":"-2.12224109","6":"0"},{"1":"x1","2":"1.138062757","3":"-0.833333333","4":"-1.250000000","5":"-2.08333333","6":"0"},{"1":"x1","2":"-2.390640189","3":"-2.000000000","4":"-0.020202020","5":"-2.02020202","6":"0"},{"1":"x2","2":"-1.621685596","3":"-2.000000000","4":"-0.020202020","5":"-2.02020202","6":"0"},{"1":"x2","2":"2.747784623","3":"-0.020202020","4":"-2.000000000","5":"-2.02020202","6":"0"},{"1":"x1","2":"0.948724479","3":"-0.943396226","4":"-1.063829787","5":"-2.00722601","6":"0"},{"1":"x1","2":"1.231412078","3":"-0.658536585","4":"-1.051948052","5":"-1.71048464","6":"0"},{"1":"x1","2":"1.180052603","3":"-0.669421488","4":"-1.025316456","5":"-1.69473794","6":"0"},{"1":"x1","2":"1.112689789","3":"-0.680672269","4":"-1.000000000","5":"-1.68067227","6":"0"},{"1":"x1","2":"1.082292268","3":"-0.692307692","4":"-0.975903614","5":"-1.66821131","6":"0"},{"1":"x1","2":"1.065107311","3":"-0.716814159","4":"-0.931034483","5":"-1.64784864","6":"0"},{"1":"x1","2":"1.050323185","3":"-0.729729730","4":"-0.910112360","5":"-1.63984209","6":"0"},{"1":"x1","2":"1.034580815","3":"-0.743119266","4":"-0.890109890","5":"-1.63322916","6":"0"},{"1":"x1","2":"0.952549289","3":"-0.757009346","4":"-0.870967742","5":"-1.62797709","6":"0"},{"1":"x1","2":"2.564144790","3":"-0.136612022","4":"-1.470588235","5":"-1.60720026","6":"0"},{"1":"x1","2":"1.217339330","3":"-0.524590164","4":"-0.820512821","5":"-1.34510298","6":"0"},{"1":"x1","2":"3.077549020","3":"-0.046632124","4":"-1.285714286","5":"-1.33234641","6":"0"},{"1":"x1","2":"1.091781037","3":"-0.542372881","4":"-0.780487805","5":"-1.32286069","6":"0"},{"1":"x1","2":"1.078357104","3":"-0.551724138","4":"-0.761904762","5":"-1.31362890","6":"0"},{"1":"x1","2":"1.071951001","3":"-0.561403509","4":"-0.744186047","5":"-1.30558956","6":"0"},{"1":"x1","2":"1.055768674","3":"-0.571428571","4":"-0.727272727","5":"-1.29870130","6":"0"},{"1":"x1","2":"1.044077464","3":"-0.581818182","4":"-0.711111111","5":"-1.29292929","6":"0"},{"1":"x1","2":"0.991148884","3":"-0.592592593","4":"-0.695652174","5":"-1.28824477","6":"0"},{"1":"x1","2":"2.600710697","3":"-0.086956522","4":"-1.000000000","5":"-1.08695652","6":"0"},{"1":"x1","2":"-2.499118647","3":"-1.000000000","4":"-0.005025126","5":"-1.00502513","6":"0"},{"1":"x1","2":"3.904304615","3":"-0.005025126","4":"-1.000000000","5":"-1.00502513","6":"0"},{"1":"x2","2":"-1.821435912","3":"-1.000000000","4":"-0.005025126","5":"-1.00502513","6":"0"},{"1":"x2","2":"2.815498719","3":"-0.005025126","4":"-1.000000000","5":"-1.00502513","6":"0"},{"1":"x1","2":"1.074496460","3":"-0.426086957","4":"-0.576470588","5":"-1.00255754","6":"0"},{"1":"x1","2":"3.335049005","3":"-0.020618557","4":"-0.666666667","5":"-0.68728522","6":"0"},{"1":"x1","2":"2.659257385","3":"-0.048648649","4":"-0.600000000","5":"-0.64864865","6":"0"},{"1":"x1","2":"2.958995108","3":"-0.020833333","4":"-0.500000000","5":"-0.52083333","6":"0"},{"1":"x1","2":"3.586093826","3":"-0.005076142","4":"-0.333333333","5":"-0.33840948","6":"0"},{"1":"x1","2":"2.702350180","3":"-0.021505376","4":"-0.285714286","5":"-0.30721966","6":"0"},{"1":"x1","2":"3.516195330","3":"-0.005128205","4":"-0.200000000","5":"-0.20512821","6":"0"},{"1":"x1","2":"2.910944533","3":"-0.005235602","4":"-0.111111111","5":"-0.11634671","6":"0"},{"1":"x1","2":"2.850492818","3":"-0.005291005","4":"-0.090909091","5":"-0.09620010","6":"0"},{"1":"x1","2":"2.726427990","3":"-0.005347594","4":"-0.076923077","5":"-0.08227067","6":"0"},{"1":"x1","2":"2.777565515","3":"0.000000000","4":"0.000000000","5":"0.00000000","6":"0"},{"1":"x1","2":"2.889986184","3":"0.000000000","4":"0.000000000","5":"0.00000000","6":"0"},{"1":"x1","2":"3.544938591","3":"0.000000000","4":"0.000000000","5":"0.00000000","6":"0"},{"1":"x1","2":"3.624718846","3":"0.000000000","4":"0.000000000","5":"0.00000000","6":"0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>We plot for variables <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> the <code>xgboost</code> gain for each possible split of data:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test , <span class="fu">aes</span>(<span class="at">x=</span>split_rule, <span class="at">y =</span>imp_total, <span class="at">col =</span> feature_split)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Then we initialize the root/parent node for the mixture data set in the context of Gradient/Newton boosting</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>tbl_node <span class="ot">&lt;-</span> data_mixture_example <span class="sc">%&gt;%</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y)),</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">prob =</span> <span class="fl">0.5</span>,</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">grad =</span> <span class="sc">-</span>(r <span class="sc">-</span> prob),</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">hessian =</span> prob <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prob),</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">lambda =</span> <span class="fl">0.0</span>,</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">gamma =</span> <span class="fl">0.0</span>)</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>y_name <span class="ot">&lt;-</span> <span class="fu">as.name</span>(<span class="st">"Y"</span>)</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>x_names <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"x1"</span>), <span class="fu">as.name</span>(<span class="st">"x2"</span>))</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>node <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_node,</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">"impurity"</span> <span class="ot">=</span> <span class="fl">0.5</span>,</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>             <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>             <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>             <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>             <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>,</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>             <span class="st">"value"</span> <span class="ot">=</span> <span class="dv">666</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We define a <code>break_at_boost</code> function implementing the Robust Logitboost / <code>xgboost</code> best split for a given node and returning the splitting rule (variable to split, split value):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>break_at_boost <span class="ot">&lt;-</span> <span class="cf">function</span>(node, min_leaf, midpoint, is_root){</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    tbl_node <span class="ot">&lt;-</span> node[[<span class="st">"data"</span>]]</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    y_name <span class="ot">&lt;-</span> node[[<span class="st">"target"</span>]]</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    x_names <span class="ot">&lt;-</span> node[[<span class="st">"features"</span>]]</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    break_node <span class="ot">&lt;-</span> <span class="fu">max_gain</span>(tbl_node, y_name, x_names, min_leaf, midpoint)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    break_node <span class="ot">&lt;-</span> break_node <span class="sc">%&gt;%</span> </span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(feature_split<span class="sc">!=</span><span class="st">"zzz"</span>,</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>               imp_total <span class="sc">!=</span> <span class="dv">666</span>) <span class="sc">%&gt;%</span>  <span class="co">#,</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>               <span class="co">#imp_node != 0) %&gt;% </span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>          <span class="co"># don't split when node is pure (ie 0 impurity)</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="fu">which.min</span>(imp_total))</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(break_node)</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The function below <code>conditional_split_boost</code> looks at a provided children node (left or right) to check if it is terminal given a stopping rule (either the max tree depth is attained, or there is a single element in the node). If not the tree continues to grow (ie the recursion continues and the recursive function <code>grow_decision_tree_boost</code> defined below is called). It also computes metrics (number of observations per class, node gain …) to fill the given node with useful information:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>conditional_split_boost <span class="ot">&lt;-</span> <span class="cf">function</span>(node, depth, max_depth, min_leaf, midpoint)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(node[[<span class="st">"data"</span>]]) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> depth <span class="sc">==</span> max_depth) {</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"is_leaf"</span>]] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Set final value for node</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>      val <span class="ot">&lt;-</span> node[[<span class="st">"data"</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarize</span>(<span class="at">val =</span>  <span class="sc">-</span> <span class="fu">sum</span>(grad) <span class="sc">/</span> (<span class="fu">sum</span>(hessian) <span class="sc">+</span> <span class="fu">mean</span>(lambda))) <span class="sc">%&gt;%</span> </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pull</span>(val)</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"value"</span>]] <span class="ot">&lt;-</span> val</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(node)</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="fu">grow_decision_tree_boost</span>(node, depth <span class="sc">+</span> <span class="dv">1</span>, max_depth, min_leaf, midpoint)</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>}    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally the function <code>grow_decision_tree_boost</code> implements the recursion, breaking the current node into left and right children nodes and conditionally to the stopping rule splitting each child node:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>grow_decision_tree_boost <span class="ot">&lt;-</span> <span class="cf">function</span>(node, <span class="at">depth =</span> <span class="dv">1</span>, <span class="at">max_depth =</span> <span class="dv">2</span>,</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">min_leaf =</span> <span class="dv">5</span>, <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># before split</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  tbl_node <span class="ot">&lt;-</span> node[[<span class="st">"data"</span>]]  </span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  x_names  <span class="ot">&lt;-</span> node[[<span class="st">"features"</span>]]  </span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>  y_name <span class="ot">&lt;-</span> node[[<span class="st">"target"</span>]]  </span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># split using break node function</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>  break_node <span class="ot">&lt;-</span> <span class="fu">break_at_boost</span>(node, min_leaf, midpoint)</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(break_node) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>      node[[<span class="st">"is_leaf"</span>]] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(node)}</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>  x_name_node <span class="ot">&lt;-</span> <span class="fu">as.name</span>(break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(feature_split))</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>  split_value_node <span class="ot">&lt;-</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(split_rule)</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"impurity"</span>]] <span class="ot">&lt;-</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(imp_node)</span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"split"</span>]] <span class="ot">&lt;-</span> split_value_node</span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"feature_split"</span>]] <span class="ot">&lt;-</span> x_name_node</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recursion, calling conditional split for left/right children</span></span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>  tbl_left <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name_node <span class="sc">&lt;</span> <span class="sc">!!</span>split_value_node)  </span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>  node_left <span class="ot">&lt;-</span>  <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_left,</span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"impurity"</span> <span class="ot">=</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(imp_left),</span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb116-34"><a href="#cb116-34" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>)</span>
<span id="cb116-35"><a href="#cb116-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-36"><a href="#cb116-36" aria-hidden="true" tabindex="-1"></a>  node_left <span class="ot">&lt;-</span> <span class="fu">conditional_split_boost</span>(node_left, depth, max_depth, min_leaf, midpoint)</span>
<span id="cb116-37"><a href="#cb116-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-38"><a href="#cb116-38" aria-hidden="true" tabindex="-1"></a>  tbl_right <span class="ot">&lt;-</span> tbl_node <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!!</span>x_name_node <span class="sc">&gt;=</span> <span class="sc">!!</span>split_value_node)  </span>
<span id="cb116-39"><a href="#cb116-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-40"><a href="#cb116-40" aria-hidden="true" tabindex="-1"></a>  node_right <span class="ot">&lt;-</span>  <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_right,</span>
<span id="cb116-41"><a href="#cb116-41" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb116-42"><a href="#cb116-42" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb116-43"><a href="#cb116-43" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"impurity"</span> <span class="ot">=</span> break_node <span class="sc">%&gt;%</span> <span class="fu">pull</span>(imp_right),</span>
<span id="cb116-44"><a href="#cb116-44" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb116-45"><a href="#cb116-45" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb116-46"><a href="#cb116-46" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb116-47"><a href="#cb116-47" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb116-48"><a href="#cb116-48" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>)</span>
<span id="cb116-49"><a href="#cb116-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-50"><a href="#cb116-50" aria-hidden="true" tabindex="-1"></a>  node_right <span class="ot">&lt;-</span> <span class="fu">conditional_split_boost</span>(node_right, depth, max_depth, min_leaf, midpoint)</span>
<span id="cb116-51"><a href="#cb116-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-52"><a href="#cb116-52" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"left"</span>]] <span class="ot">&lt;-</span> node_left</span>
<span id="cb116-53"><a href="#cb116-53" aria-hidden="true" tabindex="-1"></a>  node[[<span class="st">"right"</span>]] <span class="ot">&lt;-</span> node_right</span>
<span id="cb116-54"><a href="#cb116-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(node)</span>
<span id="cb116-55"><a href="#cb116-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-56"><a href="#cb116-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We also define a recursive function to print the decision tree (a plot would be better):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recursive function to print tree</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>print_regression_tree <span class="ot">&lt;-</span> <span class="cf">function</span>(grown_tree, <span class="at">shift =</span><span class="st">''</span>, <span class="at">precision =</span> <span class="dv">3</span>){</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (grown_tree<span class="sc">$</span>is_leaf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>        impurity <span class="ot">&lt;-</span> <span class="fu">round</span>(grown_tree<span class="sc">$</span>impurity,<span class="dv">3</span>)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>        n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(grown_tree<span class="sc">$</span>data)</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>        val <span class="ot">&lt;-</span> <span class="fu">round</span>(grown_tree<span class="sc">$</span>value,<span class="dv">3</span>)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'observations: {n}, gain: {impurity}, value: {val}'</span>))</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Else recurse</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First print the splitting variable and rule</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(shift <span class="sc">==</span> <span class="st">''</span>){</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">'Root'</span> , <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>        split <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>split</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>        feature_split <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>feature_split</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(glue::glue('Node {feature_split} &lt; {split} Y/N?'))</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'|&gt; {feature_split} &lt; {round(split, precision)}'</span>), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">print_regression_tree</span>(grown_tree<span class="sc">$</span>left, <span class="fu">paste0</span>(shift, <span class="st">'  '</span>)),<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'|&gt; {feature_split} &gt;= {round(split, precision)}'</span>), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">print_regression_tree</span>(grown_tree<span class="sc">$</span>right, <span class="fu">paste0</span>(shift, <span class="st">'  '</span>)), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then test the recursive algorithm on the mixture data set (using stumps, ie <code>max_depth</code> = 1):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>mixture_node_boost <span class="ot">&lt;-</span> <span class="fu">grow_decision_tree_boost</span>(node, <span class="at">max_depth =</span> <span class="dv">1</span>, <span class="at">min_leaf =</span> <span class="dv">1</span>, <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And visualize our tree:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_regression_tree</span>(mixture_node_boost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root 
   |&gt; x2 &lt; 0.144 
     observations: 52, gain: -37.231, value: -1.692 
   |&gt; x2 &gt;= 0.144 
     observations: 148, gain: -13.081, value: 0.595 </code></pre>
</div>
</div>
<p>Our toy implementation of Robust LogitBoost agrees with <code>xgboost</code> in terms of base/weak learners fitted:</p>
<p>Comparing with <code>xgboost</code> for depth 1 weak learners:</p>
<div class="cell" data-hash="Classification-trees-and-ensemble-methods_cache/html/unnamed-chunk-83_1d073ba23cc8b53f8267c10fe163d7a9">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>xgb_depth2 <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2)),</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y),</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">max.depth =</span> <span class="dv">1</span>,</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">eta =</span> <span class="dv">1</span>,</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">nthread =</span> <span class="dv">1</span>,</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">nrounds =</span> <span class="dv">1</span>,</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_child_weight =</span> <span class="dv">0</span>, </span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">objective =</span> <span class="st">"binary:logistic"</span>,</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="dv">0</span>,</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">tree_method =</span> <span class="st">"exact"</span>,</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>xgb_trees_depth2 <span class="ot">&lt;-</span> <span class="fu">xgb.dump</span>(xgb_depth2, <span class="at">with_stats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>xgb_trees_depth2[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "booster[0]"                                                      
[2] "0:[f1&lt;0.144127041] yes=1,no=2,missing=1,gain=50.3118515,cover=50"
[3] "1:leaf=-1.69230771,cover=13"                                     
[4] "2:leaf=0.594594598,cover=37"                                     </code></pre>
</div>
</div>
<p>Comparing with <code>xgboost</code> for depth 2 weak learners:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>mixture_node_boost <span class="ot">&lt;-</span> <span class="fu">grow_decision_tree_boost</span>(node, <span class="at">max_depth =</span> <span class="dv">2</span>, <span class="at">min_leaf =</span> <span class="dv">1</span>, <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print_regression_tree</span>(mixture_node_boost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root 
   |&gt; x2 &lt; 0.144 
     |&gt; x1 &lt; 2.815 
       observations: 51, gain: -39.706, value: -1.765 
     |&gt; x1 &gt;= 2.815 
       observations: 1, gain: -1, value: 2 
 
   |&gt; x2 &gt;= 0.144 
     |&gt; x1 &lt; 2.246 
       observations: 128, gain: -22.781, value: 0.844 
     |&gt; x1 &gt;= 2.246 
       observations: 20, gain: -5, value: -1 
 </code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>xgb_depth2 <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">data =</span> <span class="fu">as.matrix</span>(data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2)),</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">if_else</span>(Y<span class="sc">==</span><span class="st">"0"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y),</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">max.depth =</span> <span class="dv">2</span>,</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">eta =</span> <span class="dv">1</span>,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">nthread =</span> <span class="dv">1</span>,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">nrounds =</span> <span class="dv">1</span>,</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_child_weight =</span> <span class="dv">0</span>, </span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">objective =</span> <span class="st">"binary:logistic"</span>,</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">lambda =</span> <span class="dv">0</span>,</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">tree_method =</span> <span class="st">"exact"</span>,</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">verbose =</span> <span class="dv">0</span>)</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>xgb_trees_depth2 <span class="ot">&lt;-</span> <span class="fu">xgb.dump</span>(xgb_depth2, <span class="at">with_stats =</span> <span class="cn">TRUE</span>)</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(xgb_trees_depth2[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["xgb_trees_depth2[1:8]"],"name":[1],"type":["chr"],"align":["left"]}],"data":[{"1":"booster[0]"},{"1":"0:[f1<0.144127041] yes=1,no=2,missing=1,gain=50.3118515,cover=50"},{"1":"1:[f0<2.81501961] yes=3,no=4,missing=3,gain=3.47511292,cover=13"},{"1":"3:leaf=-1.7647059,cover=12.75"},{"1":"4:leaf=2,cover=0.25"},{"1":"2:[f0<2.24571514] yes=5,no=6,missing=5,gain=14.7001686,cover=37"},{"1":"5:leaf=0.84375,cover=32"},{"1":"6:leaf=-1,cover=5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recursive function to print tree</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>build_regression_tree_rule <span class="ot">&lt;-</span> <span class="cf">function</span>(grown_tree, list_rules){</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (grown_tree<span class="sc">$</span>is_leaf <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list_rules.append</span>()</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>        impurity <span class="ot">&lt;-</span> <span class="fu">round</span>(grown_tree<span class="sc">$</span>impurity,<span class="dv">3</span>)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>        n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(grown_tree<span class="sc">$</span>data)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>        val <span class="ot">&lt;-</span> <span class="fu">round</span>(grown_tree<span class="sc">$</span>value,<span class="dv">3</span>)</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'observations: {n}, gain: {impurity}, value: {val}'</span>))</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Else recurse</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First print the splitting variable and rule</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(shift <span class="sc">==</span> <span class="st">''</span>){</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">'Root'</span> , <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>        split <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>split</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>        feature_split <span class="ot">&lt;-</span> grown_tree<span class="sc">$</span>feature_split</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(glue::glue('Node {feature_split} &lt; {split} Y/N?'))</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'|&gt; {feature_split} &lt; {round(split, precision)}'</span>), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">print_regression_tree</span>(grown_tree<span class="sc">$</span>left, <span class="fu">paste0</span>(shift, <span class="st">'  '</span>)),<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(shift, <span class="st">'  '</span>), glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'|&gt; {feature_split} &gt;= {round(split, precision)}'</span>), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">print_regression_tree</span>(grown_tree<span class="sc">$</span>right, <span class="fu">paste0</span>(shift, <span class="st">'  '</span>)), <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We define here a function to extract decision rules at each split, it is the first brick to obtain prediction on new data with the fitted tree:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recursive function to find root-to-leaf rules and return as a list of strings</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>get_decision_tree_rule <span class="ot">&lt;-</span> <span class="cf">function</span>(node, <span class="at">curr_rule =</span> <span class="fu">list</span>()){</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current node is NULL return an empty list</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(node)) {</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>())</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current node is a leaf return the total rule</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (node<span class="sc">$</span>is_leaf) {</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    condition <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue_collapse</span>(curr_rule, <span class="at">sep =</span> <span class="st">" &amp; "</span>)</span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    value <span class="ot">&lt;-</span> node<span class="sc">$</span>value</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    rule_str <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{condition} ~ {value}"</span>)</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(rule_str))</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add current node rule to the path and collect rules from both left and right children</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>  feature_split <span class="ot">&lt;-</span> node<span class="sc">$</span>feature_split</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>  split <span class="ot">&lt;-</span> node<span class="sc">$</span>split</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>  left_rules <span class="ot">&lt;-</span> <span class="fu">get_decision_tree_rule</span>(node<span class="sc">$</span>left,</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">c</span>(curr_rule, glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{feature_split} &lt; {split}"</span>)))  </span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>  right_rules <span class="ot">&lt;-</span> <span class="fu">get_decision_tree_rule</span>(node<span class="sc">$</span>right,</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">c</span>(curr_rule, glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{feature_split} &gt;= {split}"</span>))) </span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(left_rules, right_rules))</span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>(conds <span class="ot">&lt;-</span> <span class="fu">get_decision_tree_rule</span>(mixture_node_boost))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
x2 &lt; 0.144127050260164 &amp; x1 &lt; 2.81501972474947 ~ -1.76470588235294

[[2]]
x2 &lt; 0.144127050260164 &amp; x1 &gt;= 2.81501972474947 ~ 2

[[3]]
x2 &gt;= 0.144127050260164 &amp; x1 &lt; 2.2457152633087 ~ 0.84375

[[4]]
x2 &gt;= 0.144127050260164 &amp; x1 &gt;= 2.2457152633087 ~ -1</code></pre>
</div>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>predict_decision_tree_boost <span class="ot">&lt;-</span> <span class="cf">function</span>(node, <span class="at">curr_rule =</span> <span class="fu">list</span>()){</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co"># inspiring from https://forum.posit.co/t/case-when-pattern-dynamically-generated/96790</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>caseArgs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cond =</span> conds) <span class="sc">%&gt;%</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">unnest</span>(cond) <span class="sc">%&gt;%</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(<span class="at">cond=</span>rlang<span class="sc">::</span><span class="fu">parse_exprs</span>(cond))</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>data_train <span class="sc">%&gt;%</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">predict =</span> <span class="fu">case_when</span>(<span class="sc">!!!</span>caseArgs<span class="sc">$</span>cond)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally implementing Ping Li’s Robust LogitBoost (ie <code>xgboost</code> without additional penalization and without many numerical optimisations that allow the method to scale to large data sets) by successively fitting weak learners using specific criterion/gain to split:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>fit_robust_logitboost <span class="ot">&lt;-</span> <span class="cf">function</span>(data_train, M, <span class="at">min_leaf=</span><span class="dv">1</span>,</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">max_depth =</span> <span class="dv">1</span>, <span class="at">lambda=</span><span class="dv">0</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>){</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># expect data with Y column in {0, 1}, </span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># with only additional predictors (as we will use formula Y ~ .)</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># should test unique(data %&gt;% pull(Y)) == c(0, 1) and</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># classs(data %&gt;% pull(Y)) is numeric</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Y</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data_train <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y)</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Length of training data</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(data_train)</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>  weak_learner <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Initialization of additive function f and probability p</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)             </span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, n)</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Boosting Iterations</span></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initializing the tree to be fitted</span></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>    tbl_node <span class="ot">&lt;-</span> data_mixture_example <span class="sc">%&gt;%</span></span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">r =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y)),</span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">prob =</span> prob,</span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">grad =</span> <span class="sc">-</span>(r <span class="sc">-</span> prob),</span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a> <span class="co"># Enforce a lower threshold on the Hessian: w = max(w, 2 × machine-zero)</span></span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a> <span class="co"># flooring with 2 times machine precision as suggested FHT00 p353 for Logitboost</span></span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">hessian =</span> <span class="fu">pmax</span>(prob <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> prob), .Machine<span class="sc">$</span>double.eps <span class="sc">*</span> <span class="dv">2</span>), </span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">lambda =</span> <span class="fl">0.0</span>,</span>
<span id="cb130-32"><a href="#cb130-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">gamma =</span> <span class="fl">0.0</span>)</span>
<span id="cb130-33"><a href="#cb130-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb130-34"><a href="#cb130-34" aria-hidden="true" tabindex="-1"></a>    y_name <span class="ot">&lt;-</span> <span class="fu">as.name</span>(<span class="st">"Y"</span>)</span>
<span id="cb130-35"><a href="#cb130-35" aria-hidden="true" tabindex="-1"></a>    x_names <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">as.name</span>(<span class="st">"x1"</span>), <span class="fu">as.name</span>(<span class="st">"x2"</span>))</span>
<span id="cb130-36"><a href="#cb130-36" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb130-37"><a href="#cb130-37" aria-hidden="true" tabindex="-1"></a>    node <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"data"</span> <span class="ot">=</span> tbl_node,</span>
<span id="cb130-38"><a href="#cb130-38" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"left"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb130-39"><a href="#cb130-39" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"right"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb130-40"><a href="#cb130-40" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"impurity"</span> <span class="ot">=</span> <span class="fl">0.5</span>,</span>
<span id="cb130-41"><a href="#cb130-41" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"target"</span> <span class="ot">=</span> y_name,</span>
<span id="cb130-42"><a href="#cb130-42" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"features"</span> <span class="ot">=</span> x_names,</span>
<span id="cb130-43"><a href="#cb130-43" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"split"</span> <span class="ot">=</span> <span class="dv">666</span>,</span>
<span id="cb130-44"><a href="#cb130-44" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"feature_split"</span> <span class="ot">=</span> <span class="st">""</span>,</span>
<span id="cb130-45"><a href="#cb130-45" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"is_leaf"</span> <span class="ot">=</span> <span class="cn">FALSE</span>,</span>
<span id="cb130-46"><a href="#cb130-46" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"value"</span> <span class="ot">=</span> <span class="dv">666</span>)</span>
<span id="cb130-47"><a href="#cb130-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-48"><a href="#cb130-48" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Fit the function f^m(x) by a specialized tree using </span></span>
<span id="cb130-49"><a href="#cb130-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ping Li's / xgboost like gain formula</span></span>
<span id="cb130-50"><a href="#cb130-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-51"><a href="#cb130-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  Fitting the tree</span></span>
<span id="cb130-52"><a href="#cb130-52" aria-hidden="true" tabindex="-1"></a>    mixture_node_boost <span class="ot">&lt;-</span> <span class="fu">grow_decision_tree_boost</span>(node,</span>
<span id="cb130-53"><a href="#cb130-53" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">max_depth =</span> max_depth,</span>
<span id="cb130-54"><a href="#cb130-54" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">min_leaf =</span> min_leaf,</span>
<span id="cb130-55"><a href="#cb130-55" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">midpoint =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-56"><a href="#cb130-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-57"><a href="#cb130-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extracting the rule to predict on new data</span></span>
<span id="cb130-58"><a href="#cb130-58" aria-hidden="true" tabindex="-1"></a>    conds <span class="ot">&lt;-</span> <span class="fu">get_decision_tree_rule</span>(mixture_node_boost)</span>
<span id="cb130-59"><a href="#cb130-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-60"><a href="#cb130-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store rule for predict on new data</span></span>
<span id="cb130-61"><a href="#cb130-61" aria-hidden="true" tabindex="-1"></a>    weak_learner[[m]] <span class="ot">&lt;-</span> conds</span>
<span id="cb130-62"><a href="#cb130-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-63"><a href="#cb130-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict f_m using specialized tree a la Ping Li</span></span>
<span id="cb130-64"><a href="#cb130-64" aria-hidden="true" tabindex="-1"></a>    caseArgs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cond =</span> conds) <span class="sc">%&gt;%</span></span>
<span id="cb130-65"><a href="#cb130-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(cond) <span class="sc">%&gt;%</span></span>
<span id="cb130-66"><a href="#cb130-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">cond=</span>rlang<span class="sc">::</span><span class="fu">parse_exprs</span>(cond))</span>
<span id="cb130-67"><a href="#cb130-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-68"><a href="#cb130-68" aria-hidden="true" tabindex="-1"></a>    f_m <span class="ot">&lt;-</span> data_train <span class="sc">%&gt;%</span></span>
<span id="cb130-69"><a href="#cb130-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">predict =</span> <span class="fu">case_when</span>(<span class="sc">!!!</span>caseArgs<span class="sc">$</span>cond)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(predict)</span>
<span id="cb130-70"><a href="#cb130-70" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb130-71"><a href="#cb130-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Updating Newton Boosted Stumps (ie Forward Stagewise Additive Model)</span></span>
<span id="cb130-72"><a href="#cb130-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and probabilities</span></span>
<span id="cb130-73"><a href="#cb130-73" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> f <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> f_m</span>
<span id="cb130-74"><a href="#cb130-74" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> f))</span>
<span id="cb130-75"><a href="#cb130-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-76"><a href="#cb130-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-77"><a href="#cb130-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Output list of weak learners (here stumps) for the predict function</span></span>
<span id="cb130-78"><a href="#cb130-78" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">list</span>(<span class="at">weak_learners=</span>weak_learner, <span class="at">probs=</span>prob))</span>
<span id="cb130-79"><a href="#cb130-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-80"><a href="#cb130-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-81"><a href="#cb130-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-82"><a href="#cb130-82" aria-hidden="true" tabindex="-1"></a>robust_logitboost_mixture <span class="ot">&lt;-</span> <span class="fu">fit_robust_logitboost</span>(data_train, <span class="dv">6</span>, <span class="at">min_leaf=</span><span class="dv">1</span>,</span>
<span id="cb130-83"><a href="#cb130-83" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">max_depth =</span> <span class="dv">1</span>, <span class="at">lambda=</span><span class="dv">0</span>, <span class="at">verbose=</span><span class="cn">FALSE</span>)</span>
<span id="cb130-84"><a href="#cb130-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-85"><a href="#cb130-85" aria-hidden="true" tabindex="-1"></a>check_vs <span class="ot">&lt;-</span> <span class="fu">fit_original_logitboost</span>(data_train, <span class="dv">6</span>, <span class="cn">FALSE</span>)</span>
<span id="cb130-86"><a href="#cb130-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-87"><a href="#cb130-87" aria-hidden="true" tabindex="-1"></a>predict_robust_logitboost <span class="ot">&lt;-</span> <span class="cf">function</span>(fitted_logitboost, new_data, <span class="at">num_tree =</span> <span class="sc">-</span><span class="dv">1</span>){</span>
<span id="cb130-88"><a href="#cb130-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-89"><a href="#cb130-89" aria-hidden="true" tabindex="-1"></a>  M <span class="ot">&lt;-</span> <span class="fu">length</span>(fitted_logitboost<span class="sc">$</span>weak_learners)</span>
<span id="cb130-90"><a href="#cb130-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(num_tree <span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> num_tree <span class="sc">&lt;</span> M){</span>
<span id="cb130-91"><a href="#cb130-91" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> num_tree</span>
<span id="cb130-92"><a href="#cb130-92" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb130-93"><a href="#cb130-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-94"><a href="#cb130-94" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb130-95"><a href="#cb130-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-96"><a href="#cb130-96" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Predicting on new data with Newton Boosted Stumps </span></span>
<span id="cb130-97"><a href="#cb130-97" aria-hidden="true" tabindex="-1"></a>  <span class="do">## (ie f function as Forward Stagewise Additive Model of Tress (depth 1)) and probabilities</span></span>
<span id="cb130-98"><a href="#cb130-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb130-99"><a href="#cb130-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-100"><a href="#cb130-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract rule for prediction</span></span>
<span id="cb130-101"><a href="#cb130-101" aria-hidden="true" tabindex="-1"></a>    conds <span class="ot">&lt;-</span> fitted_logitboost<span class="sc">$</span>weak_learners[[m]]</span>
<span id="cb130-102"><a href="#cb130-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb130-103"><a href="#cb130-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict f_m using specialized tree a la Ping Li</span></span>
<span id="cb130-104"><a href="#cb130-104" aria-hidden="true" tabindex="-1"></a>    caseArgs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cond =</span> conds) <span class="sc">%&gt;%</span> <span class="fu">unnest</span>(cond) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">cond=</span>rlang<span class="sc">::</span><span class="fu">parse_exprs</span>(cond))</span>
<span id="cb130-105"><a href="#cb130-105" aria-hidden="true" tabindex="-1"></a>    f_m <span class="ot">&lt;-</span> data_train <span class="sc">%&gt;%</span></span>
<span id="cb130-106"><a href="#cb130-106" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">predict =</span> <span class="fu">case_when</span>(<span class="sc">!!!</span>caseArgs<span class="sc">$</span>cond)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(predict)</span>
<span id="cb130-107"><a href="#cb130-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-108"><a href="#cb130-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Updating Newton Boosted Stumps (ie Forward Stagewise Additive Model) and probabilities</span></span>
<span id="cb130-109"><a href="#cb130-109" aria-hidden="true" tabindex="-1"></a>    f <span class="ot">&lt;-</span> f <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> f_m</span>
<span id="cb130-110"><a href="#cb130-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-111"><a href="#cb130-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-112"><a href="#cb130-112" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Get probability from Newton Boosted Stumps </span></span>
<span id="cb130-113"><a href="#cb130-113" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> f))</span>
<span id="cb130-114"><a href="#cb130-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb130-115"><a href="#cb130-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb130-116"><a href="#cb130-116" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We compare below the Robust/Original versions of LogitBoost on Mixture, they both agree with <code>xgboost</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check: Compare predict robust with original  on data_train</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>p_test <span class="ot">&lt;-</span> <span class="fu">predict_original_logitboost</span>(logitboost_mixture, data_train, <span class="dv">6</span>)</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>p_test2 <span class="ot">&lt;-</span> <span class="fu">predict_robust_logitboost</span>(robust_logitboost_mixture, data_train, <span class="dv">6</span>)</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(p_test))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(p_test2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(p_test2)<span class="sc">==</span><span class="fu">sum</span>(robust_logitboost_mixture<span class="sc">$</span>probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare xgboost prediction (without penalties etc, and using stumps) </span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with robust logitboost fit on data_train</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>pred_xgb <span class="ot">&lt;-</span> <span class="fu">predict</span>(xgb_deg, <span class="fu">as.matrix</span>(data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2)))</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(robust_logitboost_mixture<span class="sc">$</span>probs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(pred_xgb))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100.8572</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">abs</span>(<span class="fu">sum</span>(pred_xgb)<span class="sc">-</span><span class="fu">sum</span>(logitboost_mixture<span class="sc">$</span>probs))<span class="sc">&lt;</span><span class="fl">1e-6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="sec-case-study" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Case Study</h1>
<p>The article from <span class="citation" data-cites="desbois2008">Desbois (<a href="#ref-desbois2008" role="doc-biblioref">2008</a>)</span> (available <a href="https://csbigs.fr/index.php/csbigs/article/view/351">here</a> together with a sample data set) shows a complete case study around the detection of financial risks applicable to farm holdings in France. Exploratory Data Analysis is performed in particular using PCA. Linear Discriminant Analysis and Logistic Regression (plus stepwise variable selection) are used and ROC curves are used to compare the two methods.</p>
<p>The data set uses a format specific to the SPSS software, but is readable from R using the <code>foreign</code> package.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># package used to import spss file</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign)</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>don_desbois <span class="ot">&lt;-</span> <span class="fu">read.spss</span>(<span class="st">"../data/presentation_data/Agriculture Farm Lending/desbois.sav"</span>,</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">to.data.frame =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>don_desbois <span class="ot">&lt;-</span> don_desbois <span class="sc">%&gt;%</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fu">if_else</span>(DIFF<span class="sc">==</span><span class="st">'healthy'</span>, <span class="dv">0</span>, <span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>DIFF)</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(don_desbois)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,260
Columns: 30
$ CNTY    &lt;fct&gt; Eure, Eure, Eure, Eure, Eure, Eure, Eure, Eure, Eure, Eure, Eu…
$ STATUS  &lt;fct&gt; Entreprise individuelle, Entreprise individuelle, Entreprise i…
$ HECTARE &lt;dbl&gt; 166, 101, 138, 166, 137, 107, 100, 69, 176, 177, 108, 123, 87,…
$ ToF     &lt;fct&gt; cereals, cereals, dairy farm, cereals, mixed livestock, cereal…
$ OWNLAND &lt;fct&gt; yes, no, yes, yes, yes, yes, no, yes, yes, yes, yes, yes, yes,…
$ AGE     &lt;dbl&gt; 35, 35, 42, 50, 33, 45, 34, 30, 44, 39, 40, 40, 40, 52, 49, 44…
$ HARVEST &lt;fct&gt; 1988, 1988, 1988, 1988, 1988, 1988, 1988, 1988, 1988, 1988, 19…
$ r1      &lt;dbl&gt; 0.449, 0.450, 0.332, 0.363, 0.440, 0.306, 0.717, 0.566, 0.145,…
$ r2      &lt;dbl&gt; 0.622, 0.617, 0.819, 0.733, 0.650, 0.755, 0.320, 0.465, 0.881,…
$ r3      &lt;dbl&gt; 0.25500, 0.24110, 0.55680, 0.35960, 0.31420, 0.26350, 0.16280,…
$ r4      &lt;dbl&gt; 0.11450, 0.10840, 0.18510, 0.13050, 0.13820, 0.08055, 0.11680,…
$ r5      &lt;dbl&gt; 0.334, 0.341, 0.147, 0.232, 0.302, 0.225, 0.601, 0.499, 0.115,…
$ r6      &lt;dbl&gt; 0.785, 0.518, 0.700, 0.773, 0.846, 0.709, 0.894, 0.863, 0.439,…
$ r7      &lt;dbl&gt; 0.585, 0.393, 0.310, 0.495, 0.580, 0.523, 0.748, 0.761, 0.348,…
$ r8      &lt;dbl&gt; 0.20020, 0.12500, 0.38950, 0.27790, 0.26580, 0.18700, 0.14550,…
$ r11     &lt;dbl&gt; 0.6628, 0.7098, 0.4142, 0.4661, 0.7715, 0.8178, 0.6598, 0.6619…
$ r12     &lt;dbl&gt; 1.3698, 1.2534, 0.6370, 1.0698, 1.4752, 1.4682, 1.1018, 1.2360…
$ r14     &lt;dbl&gt; 0.23200, 0.14970, 0.48470, 0.37350, 0.25630, 0.18610, 0.18070,…
$ r17     &lt;dbl&gt; 0.0884, 0.0671, 0.0445, 0.0621, 0.0489, 0.0243, 0.0352, 0.0879…
$ r18     &lt;dbl&gt; 0.0694, 0.0348, 0.0311, 0.0480, 0.0414, 0.0173, 0.0315, 0.0758…
$ r19     &lt;dbl&gt; 0.1660, 0.1360, 0.1030, 0.1080, 0.1270, 0.0652, 0.1290, 0.2400…
$ r21     &lt;dbl&gt; 0.1340, 0.0802, 0.0890, 0.0851, 0.0838, 0.0390, 0.0784, 0.1630…
$ r22     &lt;dbl&gt; 0.3219, 0.3133, 0.2945, 0.1909, 0.2567, 0.1472, 0.3211, 0.5170…
$ r24     &lt;dbl&gt; 0.295, 0.365, 0.166, 0.265, 0.257, 0.191, 0.322, 0.305, 0.180,…
$ r28     &lt;dbl&gt; 0.475, 0.434, 0.350, 0.475, 0.475, 0.443, 0.401, 0.464, 0.475,…
$ r30     &lt;dbl&gt; 0.35000, 0.29780, 0.24680, 0.37590, 0.36690, 0.37590, 0.27240,…
$ r32     &lt;dbl&gt; 0.4313, 0.3989, 0.3187, 0.4313, 0.4313, 0.4257, 0.3697, 0.3886…
$ r36     &lt;dbl&gt; 0.886, 0.351, 1.300, 1.385, 0.886, 1.316, 0.441, 0.761, 2.147,…
$ r37     &lt;dbl&gt; 0.572, 0.867, 0.475, 0.470, 0.520, 0.431, 0.803, 0.656, 0.359,…
$ Y       &lt;fct&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…</code></pre>
</div>
</div>
<section id="cart" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="cart"><span class="header-section-number">3.1</span> CART</h2>
<p>Using the Agriculture Farm Lending data set:</p>
<ul>
<li><p><code>CART/rpart</code> build and plot a decision tree of you choice using <code>rpart</code>.</p>
<p>You can use default parameters, and this way learning them. (see for example 2. Building the tree <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">here</a></p></li>
</ul>
<p>Try to display class probabilities and number of observations per node/leaf (for that explore functions <code>rpart.plot</code> or <code>pdp</code> from package <code>rpart.plot</code> see <a href="http://www.milbo.org/doc/prp.pdf">vignette</a>).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>cart_default <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> don_desbois <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y, r1<span class="sc">:</span>r37))</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(cart_default)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-91-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Customizing the tree plot to show both class probabilities and number of observations per node/leaf:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(cart_default, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"red4"</span>)[cart_default<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-92-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Playing with <code>rpart</code> parameters (in particular those inside <code>rpart.control</code>), fit, plot, then compare a “large/deep” decision tree and a “smaller/shallower” tree in terms of ROC/AUC/prediction on the holdout set.</li>
</ul>
<p>For the deeper tree, we mainly play with the <code>cp</code> and <code>minbucket</code> parameters. <code>cp = 0</code> (vs default <code>0.01</code>) implies that any split marginally improving the impurity criterion will be attempted; to limit the tree size we enforce a minimum of <code>minbucket=11</code> observations per leaf (by default <code>minsplit=20</code> and <code>minbucket=round(minsplit/3)</code>):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>deep_control <span class="ot">&lt;-</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> <span class="fl">0.0</span>,</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">minbucket =</span> <span class="dv">11</span>)</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>deep_cart_default <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> don_desbois <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y, r1<span class="sc">:</span>r37),</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> deep_control)</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(deep_cart_default, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"red4"</span>)[deep_cart_default<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-93-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Conversely, using default value for <code>cp</code>, limiting tree depth to <code>maxdepth=3</code> and requesting a minimum <code>minbucket=25</code> observations per leaf yields a shallower tree:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>shallow_control <span class="ot">&lt;-</span> <span class="fu">rpart.control</span>(<span class="at">minbucket =</span> <span class="dv">25</span>,</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">maxdepth =</span> <span class="dv">3</span>)</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>shallow_cart_default <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> don_desbois <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y, r1<span class="sc">:</span>r37),</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> shallow_control)</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(shallow_cart_default, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"red4"</span>)[shallow_cart_default<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-94-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Describe in simple terms the output of the <code>printcp</code> function (see for example 4. Pruning the tree <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">here</a>. You don’t have to understand deeply the pruning process but understand what is at stake in the process.</li>
</ul>
<p>We assume here that we have fitted a complex/deep tree.</p>
<p>The <code>cp</code> parameter controls the tree building process, avoiding further splits if the impurity criterion does not improve by more than a threshold (linked to <code>cp</code>). Varying <code>cp</code> and starting from the complex tree, <code>rpart/cart</code> builds subtrees by trimming/pruning the least important leafs/splits.</p>
<p><code>rpart</code> implements a method to select using Cross-Validation a best <code>cp</code> parameter in terms of Cross-validated error.</p>
<p>This procedure is performed when fitting the tree, its outputs are displayed by <code>printcp</code> function or accessing <code>tree$cptable</code>.</p>
<p>Training error (rescaled so that error on root node is <code>1</code>) is designed by <code>rel error</code>, Cross-validated error by <code>xerror</code>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(deep_cart_default)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Classification tree:
rpart(formula = Y ~ ., data = don_desbois %&gt;% select(Y, r1:r37), 
    control = deep_control)

Variables actually used in tree construction:
[1] r1  r11 r12 r14 r21 r37 r4  r6  r8 

Root node error: 607/1260 = 0.48175

n= 1260 

         CP nsplit rel error  xerror     xstd
1 0.6787479      0   1.00000 1.00000 0.029220
2 0.0395387      1   0.32125 0.37232 0.022436
3 0.0222405      2   0.28171 0.31631 0.021017
4 0.0115321      4   0.23723 0.28501 0.020126
5 0.0049423      6   0.21417 0.26194 0.019419
6 0.0016474     10   0.19440 0.26194 0.019419
7 0.0000000     12   0.19110 0.28995 0.020272</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>deep_cart_default<span class="sc">$</span>cptable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           CP nsplit rel error    xerror       xstd
1 0.678747941      0 1.0000000 1.0000000 0.02921978
2 0.039538715      1 0.3212521 0.3723229 0.02243575
3 0.022240527      2 0.2817133 0.3163097 0.02101659
4 0.011532125      4 0.2372323 0.2850082 0.02012630
5 0.004942339      6 0.2141680 0.2619440 0.01941862
6 0.001647446     10 0.1943987 0.2619440 0.01941862
7 0.000000000     12 0.1911038 0.2899506 0.02027202</code></pre>
</div>
</div>
<ul>
<li>Choose an arbitrary terminal number of leafs and prune the tree using the <code>prune</code> function.</li>
</ul>
<p>The number of terminal leafs is linked to the number of splits by <code>terminal_leafs = nb_splits + 1</code>. Assuming we want a <code>7</code> leafs tree, and looking at the <code>printcp</code> output, we have to use a <code>cp</code> parameter over <code>0.004942339</code> (see row 5 of <code>cp</code> table):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>deep_cart_pruned <span class="ot">&lt;-</span> <span class="fu">prune</span>(deep_cart_default, <span class="at">cp =</span> <span class="fl">0.00494234</span>)</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(deep_cart_pruned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-97-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For a <code>cp</code> just below <code>0.004942339</code> the tree will have <code>11</code> leafs (see row 6 of <code>cp</code> table):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>deep_cart_pruned <span class="ot">&lt;-</span> <span class="fu">prune</span>(deep_cart_default, <span class="at">cp =</span> <span class="fl">0.004942339</span>)</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rpart.plot</span>(deep_cart_pruned)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-98-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Select the optimal <code>cp</code> parameter for your tree (you can use a plot) and compare to the “large” and “small” models in terms of AUC.</li>
</ul>
<p>Using the <code>cp</code> table, the best Cross-Validation error is given for <code>cp</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stackoverflow.com/questions/15318409/how-to-prune-a-tree-in-r/15318542#15318542</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>best_cp <span class="ot">&lt;-</span> deep_cart_default<span class="sc">$</span>cptable[<span class="fu">which.min</span>(deep_cart_default<span class="sc">$</span>cptable[,<span class="st">"xerror"</span>]),<span class="st">"CP"</span>]</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>best_cp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.004942339</code></pre>
</div>
</div>
<p>Or using <code>plotcp</code> function, keeping in mind that <code>cp</code> scale from the graph differs from <code>cp</code> used as model input:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stackoverflow.com/questions/31546895/why-are-the-cp-values-in-plotcp-chart-modified-from-the-original-table</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotcp</span>(deep_cart_default)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>cp0 <span class="ot">&lt;-</span> deep_cart_default<span class="sc">$</span>cptable[, 1L]  </span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>cp_plot <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(cp0 <span class="sc">*</span> <span class="fu">c</span>(<span class="cn">Inf</span>, cp0[<span class="sc">-</span><span class="fu">length</span>(cp0)]))</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>cp_plot[<span class="fu">which.min</span>(deep_cart_default<span class="sc">$</span>cptable[,<span class="st">"xerror"</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>          5 
0.007549548 </code></pre>
</div>
</div>
<p>We now compare deep/pruned/shallow in terms of AUC using a training / testing set (via holdout):</p>
<p>We choose 70%/30% split of the data set (training and testing set). Here the data set is balanced and train/test split using a simple random sampling shows a similar distribution of default:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using base R</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1987</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>index_1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(don_desbois), <span class="fu">round</span>(<span class="fu">nrow</span>(don_desbois) <span class="sc">*</span> <span class="fl">0.7</span>))</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>train_1 <span class="ot">&lt;-</span> don_desbois[index_1, ]</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>test_1  <span class="ot">&lt;-</span> don_desbois[<span class="sc">-</span>index_1, ]</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a><span class="co"># table(don_desbois$Y) %&gt;% prop.table()</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a><span class="co">#        0        1 </span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.518254 0.481746</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a><span class="co"># table(train_1$Y) %&gt;% prop.table()</span></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1 </span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.5136054 0.4863946 </span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a><span class="co"># table(test_1$Y) %&gt;% prop.table()</span></span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1 </span></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.5291005 0.4708995 </span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Using rsample package</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1987</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>split_1  <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">initial_split</span>(don_desbois, <span class="at">prop =</span> <span class="fl">0.7</span>)</span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>train_2  <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">training</span>(split_1)</span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>test_2   <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">testing</span>(split_1)</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a><span class="co"># table(train_2$Y) %&gt;% prop.table()</span></span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1 </span></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.5136054 0.4863946 </span></span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a><span class="co"># table(test_2$Y) %&gt;% prop.table()</span></span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1 </span></span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.5291005 0.4708995 </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In case we want to avoid the split of an already imbalanced data set to further skew distributions we may want to use <a href="https://rsample.tidymodels.org/articles/Common_Patterns.html#stratified-resampling">Stratified sampling</a>:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>split_strat  <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">initial_split</span>(don_desbois, <span class="at">prop =</span> <span class="fl">0.7</span>, </span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">strata =</span> <span class="st">"Y"</span>)</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>train_strat  <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">training</span>(split_strat)</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>test_strat   <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">testing</span>(split_strat)</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="co"># table(don_desbois$Y) %&gt;% prop.table()</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="co">#        0        1 </span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.518254 0.481746</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a><span class="co"># table(train_strat$Y) %&gt;% prop.table()</span></span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1 </span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.5187287 0.4812713  </span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a><span class="co"># table(test_1$Y) %&gt;% prop.table()</span></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1 </span></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.5171504 0.4828496 </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Use the training set defined before we fit a deep, a shallow and a pruned tree:</p>
<ul>
<li>Deep:</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>deep_control <span class="ot">&lt;-</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> <span class="fl">0.0</span>,</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">minbucket =</span> <span class="dv">11</span>)</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>deep_cart_default <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_strat <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y, r1<span class="sc">:</span>r37),</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> deep_control)</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(deep_cart_default, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"red4"</span>)[deep_cart_default<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-103-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Shallow:</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>shallow_control <span class="ot">&lt;-</span> <span class="fu">rpart.control</span>(<span class="at">minbucket =</span> <span class="dv">25</span>,</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">maxdepth =</span> <span class="dv">3</span>)</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>shallow_cart_default <span class="ot">&lt;-</span> <span class="fu">rpart</span>(Y<span class="sc">~</span>.,</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_strat <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y, r1<span class="sc">:</span>r37),</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> shallow_control)</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(shallow_cart_default, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"red4"</span>)[shallow_cart_default<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Pruned:</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>deep_cart_default<span class="sc">$</span>cptable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           CP nsplit rel error    xerror       xstd
1 0.686320755      0 1.0000000 1.0000000 0.03497738
2 0.034198113      1 0.3136792 0.3349057 0.02574024
3 0.012971698      3 0.2452830 0.2783019 0.02384237
4 0.009433962      5 0.2193396 0.2688679 0.02349613
5 0.003537736      6 0.2099057 0.2641509 0.02331945
6 0.002358491     10 0.1957547 0.2641509 0.02331945
7 0.000000000     12 0.1910377 0.2688679 0.02349613</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>deep_cart_pruned <span class="ot">&lt;-</span> <span class="fu">prune</span>(deep_cart_default, <span class="at">cp =</span> <span class="fl">0.003537736</span>)</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="fu">prp</span>(deep_cart_pruned, <span class="at">type =</span> <span class="dv">2</span>, <span class="at">extra =</span> <span class="dv">4</span>, <span class="at">fallen.leaves =</span> <span class="cn">TRUE</span>, <span class="at">digits=</span><span class="dv">3</span>,</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.col =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"red4"</span>)[shallow_cart_default<span class="sc">$</span>frame<span class="sc">$</span>yval],</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we indicate both Class 0-1 probabilities and number of observations for each node</span></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">node.fun =</span> <span class="cf">function</span>(x, labs, digits, varlen) <span class="fu">paste</span>(labs, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"B/O: "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">2</span>], <span class="st">" - "</span>, x<span class="sc">$</span>frame<span class="sc">$</span>yval2[,<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-106-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Deep tree</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>prob_deep <span class="ot">=</span> <span class="fu">predict</span>(deep_cart_default, <span class="at">newdata =</span> test_strat <span class="sc">%&gt;%</span> <span class="fu">select</span>(r1<span class="sc">:</span>r37), <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(prob_deep, <span class="fu">as.integer</span>(<span class="fu">as.character</span>(test_strat<span class="sc">$</span>Y)))</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"tpr"</span>, <span class="at">x.measure =</span> <span class="st">"fpr"</span>)</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(perf, <span class="at">main=</span><span class="st">"ROC curve Admissions"</span>, <span class="at">xlab=</span><span class="st">"Specificity"</span>,</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Sensitivity"</span>, <span class="at">col =</span> <span class="st">"darkorange"</span>)</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co">#add a 45 degree line</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a><span class="co"># compute empirical AUC with ROCR </span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>auc_deep <span class="ot">&lt;-</span> ROCR<span class="sc">::</span><span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"auc"</span>)</span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>auc_deep <span class="ot">&lt;-</span> auc_deep<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>auc_deep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9015557</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.9015557</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Shallow tree</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>prob_shallow <span class="ot">=</span> <span class="fu">predict</span>(shallow_cart_default, <span class="at">newdata =</span> test_strat <span class="sc">%&gt;%</span> <span class="fu">select</span>(r1<span class="sc">:</span>r37), <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(prob_shallow, <span class="fu">as.integer</span>(<span class="fu">as.character</span>(test_strat<span class="sc">$</span>Y)))</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"tpr"</span>, <span class="at">x.measure =</span> <span class="st">"fpr"</span>)</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(perf, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">main=</span><span class="st">"ROC curve Admissions"</span>, <span class="at">xlab=</span><span class="st">"Specificity"</span>,</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Sensitivity"</span>, <span class="at">col =</span> <span class="st">"plum4"</span>)</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="co"># compute empirical AUC with ROCR </span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>auc_shallow <span class="ot">&lt;-</span> ROCR<span class="sc">::</span><span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"auc"</span>)</span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>auc_shallow <span class="ot">&lt;-</span> auc_shallow<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>auc_shallow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8677512</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.8677512</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Pruned tree</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>prob_pruned <span class="ot">=</span> <span class="fu">predict</span>(deep_cart_pruned, <span class="at">newdata =</span> test_strat <span class="sc">%&gt;%</span> <span class="fu">select</span>(r1<span class="sc">:</span>r37), <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">prediction</span>(prob_pruned, <span class="fu">as.integer</span>(<span class="fu">as.character</span>(test_strat<span class="sc">$</span>Y)))</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>perf <span class="ot">&lt;-</span> <span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"tpr"</span>, <span class="at">x.measure =</span> <span class="st">"fpr"</span>)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(perf, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">main=</span><span class="st">"ROC curve Admissions"</span>, <span class="at">xlab=</span><span class="st">"Specificity"</span>,</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Sensitivity"</span>, <span class="at">col =</span> <span class="st">"darkolivegreen"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-107-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute empirical AUC with ROCR </span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>auc_pruned <span class="ot">&lt;-</span> ROCR<span class="sc">::</span><span class="fu">performance</span>(pred, <span class="at">measure =</span> <span class="st">"auc"</span>)</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>auc_pruned <span class="ot">&lt;-</span> auc_pruned<span class="sc">@</span>y.values[[<span class="dv">1</span>]]</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>auc_pruned</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.921699</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 0.921699</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="gradient-boosting" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="gradient-boosting"><span class="header-section-number">3.2</span> Gradient boosting</h2>
<p>Using a gradient boosting package of your choice (<code>gbm</code>, <code>xgboost</code>), play with number of boosting iterations, weak learner complexity (decision tree depth, min number of observations), learning rate. Compare also logistic loss with exponential loss (adaboost) as in the lesson.</p>
<p>Note that the data at hand is quite small (training set is around 1000 observations).</p>
<p>You can take inspiration from this graph: <a href="https://scikit-learn.org/1.5/auto_examples/ensemble/plot_gradient_boosting_regularization.html">here</a>)</p>
<p>Example usage of <code>gbm</code> (more <a href="https://cran.r-project.org/web/packages/gbm/vignettes/gbm.pdf">here</a>, see for example the Figure 3 showing Out-of-sample predictive performance by number of iterations and shrinkage):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(gbm)</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gbm_deg &lt;- gbm(Y~.,</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="co">#            data = YOUR_DATA,</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="co">#            n.trees = N, # number of boosting iterations</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="co">#            distribution = "bernoulli", # loss minimized</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="co">#            interaction.depth = 1, </span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a><span class="co">#            /!\ interaction.depth (~#{terminal nodes}+1) &lt;&gt; rpart maxdepth</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                n.minobsinnode = 1, # comparable to rpart minbucket</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="co">#            shrinkage = 1, # learning rate</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a><span class="co">#            bag.fraction = 1) # set at 1 to implement pure boosting </span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a><span class="co">#            # (otherwise stochastic boosting, ie mix of boosting and bagging)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Example usage of <code>xgboost</code> (more <a href="">here</a> or <a href="https://xgboost.readthedocs.io/en/stable/R-package/xgboostPresentation.html">here</a> for the <code>R</code> package):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(xgboost)</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_deg &lt;- xgboost(data = as.matrix(YOUR_PREDICTORS),</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a><span class="co">#            label = as.vector(YOUR_TARGET),</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co">#            max.depth = 1, # comparable to rpart maxdepth</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="co">#            eta = 1, # learning rate</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="co">#            nthread = 1,</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a><span class="co">#            nrounds = num_tree, # number of boosting iterations</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="co">#             min_child_weight = 0, # similar but not comparable to rpart minbucket</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a><span class="co">#             objective = "binary:logistic", # loss minimized</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a><span class="co">#             lambda = 0, # set at 0 to avoid L2 penalization</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a><span class="co">#             tree_method = "exact") </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="sec-appendix" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Appendix</h1>
<section id="checking-our-decision-tree-implementation-vs-scikit-learn" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="checking-our-decision-tree-implementation-vs-scikit-learn"><span class="header-section-number">4.1</span> Checking our Decision tree implementation vs scikit-learn</h2>
<p>We verify that our toy implementation of <code>CART</code> matches the <code>scikit-learn</code> implementation on the Mixture data set with comparable parameters (note that the default colors from <code>graphviz</code> are the opposite of the Mixture data set, ie Class 0 / BLUE filled in orange, Class 1 / ORANGE filled in blue):</p>
<p>We first check and set our python environment:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We import the needed python packages:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> tree</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We pass the data objects created within <code>R</code> chunks to <code>Python</code> using the <code>r</code> object (e.g.&nbsp;<code>r.x</code> would access to <code>x</code> variable created within <code>R</code> from <code>Python</code>):</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>Y_sk <span class="ot">=</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y)</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>X_sk <span class="ot">=</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1,x2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> r.X_sk</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> r.Y_sk</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>X.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         x1        x2
0  2.526093  0.321050
1  0.366954  0.031462
2  0.768219  0.717486
3  0.693436  0.777194
4 -0.019837  0.867254</code></pre>
</div>
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>Y[<span class="dv">0</span>:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Y
0  0
1  0
2  0
3  0
4  0</code></pre>
</div>
</div>
<p>We then fit a <code>scikit-learn</code> <code>DecisionTreeCLassifier</code> implementing a version of CART, for more details see <a href="https://scikit-learn.org/stable/modules/tree.html">scikit-learn User Guide</a> and <a href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html#sklearn.tree.DecisionTreeClassifier">Documentation</a>.</p>
<p>We use similar parameters as before:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> tree.DecisionTreeClassifier(max_depth<span class="op">=</span><span class="dv">4</span>, min_samples_leaf<span class="op">=</span><span class="dv">7</span>, min_samples_split<span class="op">=</span><span class="dv">7</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>clf.fit(X, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  display: none;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  display: block;
  width: 100%;
  overflow: visible;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}

.estimator-table summary {
    padding: .5rem;
    font-family: monospace;
    cursor: pointer;
}

.estimator-table details[open] {
    padding-left: 0.1rem;
    padding-right: 0.1rem;
    padding-bottom: 0.3rem;
}

.estimator-table .parameters-table {
    margin-left: auto !important;
    margin-right: auto !important;
}

.estimator-table .parameters-table tr:nth-child(odd) {
    background-color: #fff;
}

.estimator-table .parameters-table tr:nth-child(even) {
    background-color: #f6f6f6;
}

.estimator-table .parameters-table tr:hover {
    background-color: #e0e0e0;
}

.estimator-table table td {
    border: 1px solid rgba(106, 105, 104, 0.232);
}

.user-set td {
    color:rgb(255, 94, 0);
    text-align: left;
}

.user-set td.value pre {
    color:rgb(255, 94, 0) !important;
    background-color: transparent !important;
}

.default td {
    color: black;
    text-align: left;
}

.user-set td i,
.default td i {
    color: black;
}

.copy-paste-icon {
    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);
    background-repeat: no-repeat;
    background-size: 14px 14px;
    background-position: 0;
    display: inline-block;
    width: 14px;
    height: 14px;
    cursor: pointer;
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DecisionTreeClassifier(max_depth=4, min_samples_leaf=7, min_samples_split=7,
                       random_state=0)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>DecisionTreeClassifier</div></div><div><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.7/modules/generated/sklearn.tree.DecisionTreeClassifier.html">?<span>Documentation for DecisionTreeClassifier</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted" data-param-prefix="">
        <div class="estimator-table">
            <details>
                <summary>Parameters</summary>
                
<table class="parameters-table table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd default">
<td><em></em></td>
<td class="param">criterion&nbsp;</td>
<td class="value">'gini'</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">splitter&nbsp;</td>
<td class="value">'best'</td>
</tr>
<tr class="odd user-set">
<td><em></em></td>
<td class="param">max_depth&nbsp;</td>
<td class="value">4</td>
</tr>
<tr class="even user-set">
<td><em></em></td>
<td class="param">min_samples_split&nbsp;</td>
<td class="value">7</td>
</tr>
<tr class="odd user-set">
<td><em></em></td>
<td class="param">min_samples_leaf&nbsp;</td>
<td class="value">7</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">min_weight_fraction_leaf&nbsp;</td>
<td class="value">0.0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">max_features&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="even user-set">
<td><em></em></td>
<td class="param">random_state&nbsp;</td>
<td class="value">0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">max_leaf_nodes&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">min_impurity_decrease&nbsp;</td>
<td class="value">0.0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">class_weight&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">ccp_alpha&nbsp;</td>
<td class="value">0.0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">monotonic_cst&nbsp;</td>
<td class="value">None</td>
</tr>
</tbody>
</table>

            </details>
        </div>
    </div></div></div></div></div><script>function copyToClipboard(text, element) {
    // Get the parameter prefix from the closest toggleable content
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;

    const originalStyle = element.style;
    const computedStyle = window.getComputedStyle(element);
    const originalWidth = computedStyle.width;
    const originalHTML = element.innerHTML.replace('Copied!', '');

    navigator.clipboard.writeText(fullParamName)
        .then(() => {
            element.style.width = originalWidth;
            element.style.color = 'green';
            element.innerHTML = "Copied!";

            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            element.style.color = 'red';
            element.innerHTML = "Failed!";
            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        });
    return false;
}

document.querySelectorAll('.fa-regular.fa-copy').forEach(function(element) {
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const paramName = element.parentElement.nextElementSibling.textContent.trim();
    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;

    element.setAttribute('title', fullParamName);
});
</script>
</div>
</div>
<p>We then visualize the resulting decision tree:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">25</span>,<span class="dv">17</span>))</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>tree.plot_tree(clf, filled<span class="op">=</span><span class="va">True</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="co"># basic plotting export unusable images</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.savefig('../images/check_tree_mixture.svg')</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a><span class="co"># export instead rotated tree (idea from Matt Harrison XGBoost book) </span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>tree.export_graphviz(clf, <span class="st">'../images/check_tree_mixture.dot'</span>,</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>                     feature_names<span class="op">=</span>X.columns, filled<span class="op">=</span><span class="va">True</span>, rotate<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-116-1.png" class="img-fluid" width="2400"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">"dot -Tsvg ../images/check_tree_mixture.dot -o ../images/check_tree_mixture.svg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="../images/check_tree_mixture.svg" class="img-fluid"></p>
<p>It is comparable to our implementation:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_tree</span>(mixture_node, <span class="st">''</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Root 
   |&gt; x2 &lt; 0.1441 
     |&gt; x2 &lt; -0.344 
       prob 1: 0, class: 0, 0-1: 31/0, impurity: 0 
     |&gt; x2 &gt;= -0.344 
       |&gt; x2 &lt; -0.137 
         prob 1: 0.43, class: 0, 0-1: 4/3, impurity: 0.49 
       |&gt; x2 &gt;= -0.137 
         |&gt; x1 &lt; 0.993 
           prob 1: 0, class: 0, 0-1: 7/0, impurity: 0 
         |&gt; x1 &gt;= 0.993 
           prob 1: 0.14, class: 0, 0-1: 6/1, impurity: 0.245 
 
 
 
   |&gt; x2 &gt;= 0.1441 
     |&gt; x1 &lt; 2.246 
       |&gt; x2 &lt; 0.976 
         |&gt; x1 &lt; 1.017 
           prob 1: 0.24, class: 0, 0-1: 22/7, impurity: 0.366 
         |&gt; x1 &gt;= 1.017 
           prob 1: 0.95, class: 1, 0-1: 1/20, impurity: 0.091 
 
       |&gt; x2 &gt;= 0.976 
         |&gt; x1 &lt; -0.967 
           prob 1: 1, class: 1, 0-1: 0/15, impurity: 0 
         |&gt; x1 &gt;= -0.967 
           prob 1: 0.78, class: 1, 0-1: 14/49, impurity: 0.346 
 
 
     |&gt; x1 &gt;= 2.246 
       |&gt; x1 &lt; 3.078 
         prob 1: 0, class: 0, 0-1: 13/0, impurity: 0 
       |&gt; x1 &gt;= 3.078 
         prob 1: 0.71, class: 1, 0-1: 2/5, impurity: 0.408 
 
 </code></pre>
</div>
</div>
<p>Same with iris data set:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>Y_sk <span class="ot">=</span> tbl_iris<span class="sc">%&gt;%</span> <span class="fu">select</span>(Species)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>X_sk <span class="ot">=</span> tbl_iris <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>Species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> r.X_sk</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> r.Y_sk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>It is comparable to our implementation:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_party,</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">terminal_panel =</span> <span class="fu">node_terminal</span>(tree_party,</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">id =</span> <span class="cn">FALSE</span>,</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">height =</span> <span class="dv">4</span>,</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FUN =</span> <span class="cf">function</span>(node) {</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Class: {node$class}</span><span class="sc">\n</span><span class="st">Impurity: {round(node$impurity, 3)}</span><span class="sc">\n</span><span class="st">Counts: {node$counts_0}-{node$counts_1}"</span>)</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a> }))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-122-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="checking-our-adaboost-implementation-vs-r-packages-and-scikit-learn" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="checking-our-adaboost-implementation-vs-r-packages-and-scikit-learn"><span class="header-section-number">4.2</span> Checking our AdaBoost implementation vs R packages and scikit-learn</h2>
<p>Check using package <code>ada</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ada)</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>check_ada <span class="ot">&lt;-</span> ada<span class="sc">::</span><span class="fu">ada</span>(Y<span class="sc">~</span>., <span class="at">data =</span> data_ada, <span class="at">iter=</span><span class="dv">200</span>, <span class="at">bag.frac=</span><span class="dv">1</span>, <span class="at">type=</span><span class="st">"discrete"</span>, <span class="at">nu =</span> <span class="dv">1</span>,</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control=</span><span class="fu">rpart.control</span>(<span class="at">cp =</span> <span class="sc">-</span><span class="dv">1</span> , <span class="at">maxdepth =</span> <span class="dv">1</span> , <span class="at">minsplit =</span> <span class="dv">0</span>))</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>pre <span class="ot">&lt;-</span> <span class="fu">predict</span>(check_ada, data_ada)</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>Y_target <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(data_ada <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y)))</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">tibble</span>(<span class="at">pred=</span>pre, <span class="at">target=</span>Y_target)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    target
pred -1  1
  -1 88  9
  1  12 91</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>grid_precision <span class="ot">&lt;-</span> .<span class="dv">01</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.85</span>, <span class="fl">4.5</span>, grid_precision), <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.25</span>, <span class="fl">3.1</span>, grid_precision)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid, <span class="fu">tibble</span>(<span class="at">predict_ADA =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">predict</span>(check_ada, grid))))) <span class="sc">%&gt;%</span> </span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">predict_ADA =</span> <span class="fl">0.5</span> <span class="sc">*</span> (predict_ADA <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>(ada_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> grid_precision, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_ADA),</span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">-</span>grid_precision, <span class="at">col =</span> <span class="st">'black'</span>) <span class="sc">+</span> </span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_ADA), <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.99999</span>,<span class="dv">2</span>), <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))), <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y),</span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="dv">0</span>))<span class="sc">+</span></span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill=</span><span class="cn">NA</span>, <span class="at">size=</span><span class="fl">0.5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-123-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>ada_error_rate <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">tibble</span>(<span class="at">class =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">predict</span>(check_ada, new_mixture)))) <span class="sc">%&gt;%</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fl">0.5</span> <span class="sc">*</span> (class <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>(ada_risk <span class="ot">&lt;-</span> ada_error_rate  <span class="sc">%&gt;%</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2626</code></pre>
</div>
</div>
<p>Check using package <code>JOUSBoost</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(JOUSBoost)</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>check_ada <span class="ot">&lt;-</span> JOUSBoost<span class="sc">::</span><span class="fu">adaboost</span>(<span class="fu">as.matrix</span>(data_ada <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1, x2)),</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>                                 data_ada <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y=</span><span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y),</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">tree_depth =</span> <span class="dv">1</span>,</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">n_rounds =</span> <span class="dv">200</span>)</span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>pre <span class="ot">&lt;-</span> <span class="fu">predict</span>(check_ada, data_ada)</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>Y_target <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(data_ada <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Y)))</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">tibble</span>(<span class="at">pred=</span>pre, <span class="at">target=</span>Y_target)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    target
pred -1  1
  -1 88  9
  1  12 91</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.6</span>, <span class="fl">4.2</span>, .<span class="dv">05</span>), <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.0</span>, <span class="fl">2.9</span>, .<span class="dv">05</span>)) <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>()</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(grid, <span class="fu">tibble</span>(<span class="at">predict_ADA =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">predict</span>(check_ada, grid))))) <span class="sc">%&gt;%</span> </span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">predict_ADA =</span> <span class="fl">0.5</span> <span class="sc">*</span> (predict_ADA <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">predict_oracle =</span> <span class="fu">predict_oracle_V</span>(x1, x2))</span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>(ada_decision_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid) <span class="sc">+</span> </span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> <span class="fu">as.factor</span>(predict_ADA)),</span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">shape =</span> <span class="dv">20</span>, <span class="at">size =</span> .<span class="dv">05</span>, <span class="at">alpha =</span> .<span class="dv">5</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_oracle),</span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="st">'purple'</span>) <span class="sc">+</span> </span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_contour</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">z =</span> predict_ADA),</span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">breaks =</span> <span class="fl">0.05</span>, <span class="at">col =</span> <span class="st">'darkgrey'</span>) <span class="sc">+</span> </span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_point</span>(<span class="at">data =</span> data_ada <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">as.factor</span>(<span class="fl">0.5</span><span class="sc">*</span> (<span class="fu">as.integer</span>(<span class="fu">as.character</span>(Y))<span class="sc">+</span><span class="dv">1</span>))), <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">col =</span> Y),</span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">stroke =</span> <span class="dv">2</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dodgerblue"</span>, <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme_void</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-124-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>ada_error_rate <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(new_mixture,</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">tibble</span>(<span class="at">class =</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">predict</span>(check_ada, new_mixture)))) <span class="sc">%&gt;%</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">mutate</span>(<span class="at">class =</span> <span class="fl">0.5</span> <span class="sc">*</span> (class <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Y =</span> <span class="fu">if_else</span>(Y <span class="sc">==</span> <span class="st">"BLUE"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">l01 =</span> <span class="fu">if_else</span>(Y<span class="sc">==</span>class, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>(ada_risk <span class="ot">&lt;-</span> ada_error_rate  <span class="sc">%&gt;%</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">l01 =</span> <span class="fu">mean</span>(l01)) <span class="sc">%&gt;%</span> </span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(l01))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2626</code></pre>
</div>
</div>
<p>Check using <code>Python</code> package <code>scikit-learn</code>:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>Y_sk <span class="ot">=</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(Y)</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>X_sk <span class="ot">=</span> data_mixture_example <span class="sc">%&gt;%</span> <span class="fu">select</span>(x1,x2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> r.X_sk.to_numpy()</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> r.Y_sk.values.ravel().astype(<span class="bu">int</span>)</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>Y[<span class="dv">0</span>:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>array([0, 0, 0, 0, 0])</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># adapted from sciki-learn examples</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://scikit-learn.org/stable/auto_examples/ensemble/plot_adaboost_twoclass.html#sphx-glr-auto-examples-ensemble-plot-adaboost-twoclass-py</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> AdaBoostClassifier</span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> DecisionBoundaryDisplay</span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and fit an AdaBoosted decision tree</span></span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>bdt <span class="op">=</span> AdaBoostClassifier(</span>
<span id="cb205-14"><a href="#cb205-14" aria-hidden="true" tabindex="-1"></a>    DecisionTreeClassifier(max_depth<span class="op">=</span><span class="dv">1</span>), algorithm<span class="op">=</span><span class="st">"SAMME"</span>, n_estimators<span class="op">=</span>M</span>
<span id="cb205-15"><a href="#cb205-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb205-16"><a href="#cb205-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-17"><a href="#cb205-17" aria-hidden="true" tabindex="-1"></a>bdt.fit(X, Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<style>#sk-container-id-3 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-3 {
  color: var(--sklearn-color-text);
}

#sk-container-id-3 pre {
  padding: 0;
}

#sk-container-id-3 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-3 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-3 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-3 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-3 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-3 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-3 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-3 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-3 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-3 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-3 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-3 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-3 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-3 div.sk-toggleable__content {
  display: none;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  display: block;
  width: 100%;
  overflow: visible;
}

#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-3 div.sk-label label.sk-toggleable__label,
#sk-container-id-3 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-3 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-3 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-3 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-3 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-3 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-3 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-3 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-3 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-3 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}

.estimator-table summary {
    padding: .5rem;
    font-family: monospace;
    cursor: pointer;
}

.estimator-table details[open] {
    padding-left: 0.1rem;
    padding-right: 0.1rem;
    padding-bottom: 0.3rem;
}

.estimator-table .parameters-table {
    margin-left: auto !important;
    margin-right: auto !important;
}

.estimator-table .parameters-table tr:nth-child(odd) {
    background-color: #fff;
}

.estimator-table .parameters-table tr:nth-child(even) {
    background-color: #f6f6f6;
}

.estimator-table .parameters-table tr:hover {
    background-color: #e0e0e0;
}

.estimator-table table td {
    border: 1px solid rgba(106, 105, 104, 0.232);
}

.user-set td {
    color:rgb(255, 94, 0);
    text-align: left;
}

.user-set td.value pre {
    color:rgb(255, 94, 0) !important;
    background-color: transparent !important;
}

.default td {
    color: black;
    text-align: left;
}

.user-set td i,
.default td i {
    color: black;
}

.copy-paste-icon {
    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);
    background-repeat: no-repeat;
    background-size: 14px 14px;
    background-position: 0;
    display: inline-block;
    width: 14px;
    height: 14px;
    cursor: pointer;
}
</style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>AdaBoostClassifier(algorithm='SAMME',
                   estimator=DecisionTreeClassifier(max_depth=1),
                   n_estimators=200)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>AdaBoostClassifier</div></div><div><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.7/modules/generated/sklearn.ensemble.AdaBoostClassifier.html">?<span>Documentation for AdaBoostClassifier</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted" data-param-prefix="">
        <div class="estimator-table">
            <details>
                <summary>Parameters</summary>
                
<table class="parameters-table table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd user-set">
<td><em></em></td>
<td class="param">estimator&nbsp;</td>
<td class="value">DecisionTreeC...r(max_depth=1)</td>
</tr>
<tr class="even user-set">
<td><em></em></td>
<td class="param">n_estimators&nbsp;</td>
<td class="value">200</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">learning_rate&nbsp;</td>
<td class="value">1.0</td>
</tr>
<tr class="even user-set">
<td><em></em></td>
<td class="param">algorithm&nbsp;</td>
<td class="value">'SAMME'</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">random_state&nbsp;</td>
<td class="value">None</td>
</tr>
</tbody>
</table>
<div class="sk-parallel">
<div class="sk-parallel-item">
<div class="sk-item">
<div class="sk-label-container">
<div class="sk-label fitted sk-toggleable">
<div>
<div>
estimator: DecisionTreeClassifier
</div>
</div>
<div class="sk-toggleable__content fitted" data-param-prefix="estimator__">
<pre><code>DecisionTreeClassifier(max_depth=1)</code></pre>
</div>
</div>
</div>
<div class="sk-serial">
<div class="sk-item">
<div class="sk-estimator fitted sk-toggleable">
<div>
<div>
DecisionTreeClassifier
</div>
</div>
<div>
<a href="https://scikit-learn.org/1.7/modules/generated/sklearn.tree.DecisionTreeClassifier.html" class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank">?<span>Documentation for DecisionTreeClassifier</span></a>
</div>
<div class="sk-toggleable__content fitted" data-param-prefix="estimator__">
<div class="estimator-table">
Parameters
<table class="parameters-table table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd default">
<td><em></em></td>
<td class="param">criterion&nbsp;</td>
<td class="value">'gini'</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">splitter&nbsp;</td>
<td class="value">'best'</td>
</tr>
<tr class="odd user-set">
<td><em></em></td>
<td class="param">max_depth&nbsp;</td>
<td class="value">1</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">min_samples_split&nbsp;</td>
<td class="value">2</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">min_samples_leaf&nbsp;</td>
<td class="value">1</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">min_weight_fraction_leaf&nbsp;</td>
<td class="value">0.0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">max_features&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">random_state&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">max_leaf_nodes&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">min_impurity_decrease&nbsp;</td>
<td class="value">0.0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">class_weight&nbsp;</td>
<td class="value">None</td>
</tr>
<tr class="even default">
<td><em></em></td>
<td class="param">ccp_alpha&nbsp;</td>
<td class="value">0.0</td>
</tr>
<tr class="odd default">
<td><em></em></td>
<td class="param">monotonic_cst&nbsp;</td>
<td class="value">None</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

            </details>
        </div>
    </div></div></div></div></div></div></div></div></section></section><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There are ways to cope with non-linearity using Logistic Regression model. We have briefly seen in the first course that one can modify input variables with splines or with binning. Sections 5.6 <code>Nonparametric Logistic Regression</code> and 9.1 <code>Generalized Additive Models</code> of <span class="citation" data-cites="hastie2009">Hastie, Tibshirani, and Friedman (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> present methods to move beyond linearity in the context of Logistic Regression.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>In <a href="https://xgboost.readthedocs.io/en/stable/treemethod.html">XGBoost documentation</a> we find this disclaimer: ‘However, as xgboost is largely driven by community effort, the actual implementations have some differences than pure math description. Result might be slightly different than expectation, which we are currently trying to overcome.’<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>For example in the context signal processing, the matching pursuit algorithm developed by Mallat and Zhang in 1993 is equivalent to a Boosting algorithm (Mallat, S., Zhang, Z. (1993). Matching pursuits with time-frequency dictionaries)<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main></div><script>function copyToClipboard(text, element) {
    // Get the parameter prefix from the closest toggleable content
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;

    const originalStyle = element.style;
    const computedStyle = window.getComputedStyle(element);
    const originalWidth = computedStyle.width;
    const originalHTML = element.innerHTML.replace('Copied!', '');

    navigator.clipboard.writeText(fullParamName)
        .then(() => {
            element.style.width = originalWidth;
            element.style.color = 'green';
            element.innerHTML = "Copied!";

            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            element.style.color = 'red';
            element.innerHTML = "Failed!";
            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        });
    return false;
}

document.querySelectorAll('.fa-regular.fa-copy').forEach(function(element) {
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const paramName = element.parentElement.nextElementSibling.textContent.trim();
    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;

    element.setAttribute('title', fullParamName);
});
</script>

<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>plot_colors <span class="op">=</span> [<span class="st">"dodgerblue"</span>, <span class="st">"darkorange"</span>]</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>plot_step <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> [<span class="st">"BLUE"</span>, <span class="st">"ORANGE"</span>]</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the decision boundaries</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(<span class="dv">111</span>)</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>disp <span class="op">=</span> DecisionBoundaryDisplay.from_estimator(</span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>    bdt,</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>    X,</span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span>plt.cm.Paired,</span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>    response_method<span class="op">=</span><span class="st">"predict"</span>,</span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"x1"</span>,</span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"x2"</span>,</span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>x_min, x_max <span class="op">=</span> disp.xx0.<span class="bu">min</span>(), disp.xx0.<span class="bu">max</span>()</span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a>y_min, y_max <span class="op">=</span> disp.xx1.<span class="bu">min</span>(), disp.xx1.<span class="bu">max</span>()</span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"tight"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(np.float64(-3.5208196765959814), np.float64(5.170746207536664), np.float64(-2.9998534020399017), np.float64(3.8558049669193197))</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the training points</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, n, c <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">range</span>(<span class="dv">2</span>), class_names, plot_colors):</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.where(Y <span class="op">==</span> i)</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    plt.scatter(</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>        X[idx, <span class="dv">0</span>],</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>        X[idx, <span class="dv">1</span>],</span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span>c,</span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>plt.xlim(x_min, x_max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(-3.5208196765959814, 5.170746207536664)</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>plt.ylim(y_min, y_max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>(-2.9998534020399017, 3.8558049669193197)</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">"upper right"</span>)</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Decision Boundary (</span><span class="sc">{</span>M<span class="sc">}</span><span class="ss"> estimators)"</span>)</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'../images/check_adaboost.svg'</span>)</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Classification-trees-and-ensemble-methods_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid" width="960"></p>
</div>



<section id="references" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-bartlett2006" class="csl-entry" role="listitem">
Bartlett, Peter L., Michael I. Jordan, and Jon D. Mcauliffe. 2006. <span>“Convexity, Classification, and Risk Bounds.”</span> <em>Journal of the American Statistical Association</em> 101 (473): 138–56. https://doi.org/<a href="https://doi.org/10.1198/016214505000000907">https://doi.org/10.1198/016214505000000907</a>.
</div>
<div id="ref-Breiman83" class="csl-entry" role="listitem">
Breiman, L., J. H. Friedman, R. A. Olshen, and C. J and Stone. 1983. <em>Classification and Regression Trees</em>. Belmont, Ca: Wadsworth.
</div>
<div id="ref-xgboost2016" class="csl-entry" role="listitem">
Chen, Tianqi, and Carlos Guestrin. 2016. <span>“XGBoost: A Scalable Tree Boosting System,”</span> 785–94. <a href="https://doi.org/10.1145/2939672.2939785">https://doi.org/10.1145/2939672.2939785</a>.
</div>
<div id="ref-desbois2008" class="csl-entry" role="listitem">
Desbois, Dominique. 2008. <span>“<span class="nocase">Introduction to scoring methods: financial problems of farm holdings</span>.”</span> Edited by Société française de Statistique. <em><span>Case Studies in Business, Industry and Government Statistics</span></em> 2 (1): 56–76. <a href="https://hal.science/hal-01172847">https://hal.science/hal-01172847</a>.
</div>
<div id="ref-adaboost1996" class="csl-entry" role="listitem">
Freund, Y., and R. E. Schapire. 1996. <span>“Experiments with a New Boosting Algorithm,”</span> ICML’96, 148–56.
</div>
<div id="ref-gbm2001" class="csl-entry" role="listitem">
Friedman, J. 2001. <span>“Greedy Function Approximation: A Gradient Boosting Machine.”</span> <em>The Annals of Statistics</em> 29 (5): 1189–1232. <a href="https://doi.org/10.1214/aos/1013203451">https://doi.org/10.1214/aos/1013203451</a>.
</div>
<div id="ref-fht2000" class="csl-entry" role="listitem">
Friedman, J., T. Hastie, and R. Tibshirani. 2000. <span>“Additive Logistic Regression: A Statistical View of Boosting (with Discussion and a Rejoinder by the Authors).”</span> <em>The Annals of Statistics</em> 28 (2): 337–407. <a href="https://doi.org/10.1214/aos/1016218223">https://doi.org/10.1214/aos/1016218223</a>.
</div>
<div id="ref-hastie2009" class="csl-entry" role="listitem">
Hastie, T., R. Tibshirani, and J. Friedman. 2009. <em>The Elements of Statistical Learning</em>. Springer New York. <a href="https://doi.org/10.1007/978-0-387-84858-7">https://doi.org/10.1007/978-0-387-84858-7</a>.
</div>
<div id="ref-nielsen2016" class="csl-entry" role="listitem">
Nielsen, D. 2016. <span>“Tree Boosting with XGBoost - Why Does XGBoost Win "Every" Machine Learning Competition?”</span> <em>Norwegian University of Science and Technology [MSc]</em>. <a href="https://ntnuopen.ntnu.no/ntnu-xmlui/handle/11250/2433761">https://ntnuopen.ntnu.no/ntnu-xmlui/handle/11250/2433761</a>.
</div>
<div id="ref-pingli2010" class="csl-entry" role="listitem">
Ping, L. 2010. <span>“Robust Logitboost and Adaptive Base Class (ABC) Logitboost,”</span> 302–11. <a href="https://doi.org/10.5555/3023549.3023585">https://doi.org/10.5555/3023549.3023585</a>.
</div>
<div id="ref-boosting2012" class="csl-entry" role="listitem">
Schapire, Robert E., and Yoav Freund. 2012. <em>Boosting: Foundations and Algorithms</em>. The MIT Press. https://doi.org/<a href="https://doi.org/10.7551/mitpress/8291.001.0001">https://doi.org/10.7551/mitpress/8291.001.0001</a>.
</div>
</div>
</section>



<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
 <!-- /content -->



</body></html>