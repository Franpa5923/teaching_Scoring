<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exam - Take home</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="exam_take_home_files/libs/clipboard/clipboard.min.js"></script>
<script src="exam_take_home_files/libs/quarto-html/quarto.js"></script>
<script src="exam_take_home_files/libs/quarto-html/popper.min.js"></script>
<script src="exam_take_home_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="exam_take_home_files/libs/quarto-html/anchor.min.js"></script>
<link href="exam_take_home_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="exam_take_home_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="exam_take_home_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="exam_take_home_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="exam_take_home_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<link href="exam_take_home_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="exam_take_home_files/libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#exercise-lasso-choice-of-lambda-using-hold-out-cross-validation-25-total-points" id="toc-exercise-lasso-choice-of-lambda-using-hold-out-cross-validation-25-total-points" class="nav-link active" data-scroll-target="#exercise-lasso-choice-of-lambda-using-hold-out-cross-validation-25-total-points"><span class="header-section-number">1</span> Exercise: Lasso: choice of lambda using hold out / cross-validation (25% total points)</a></li>
  <li><a href="#exercise-decision-trees-35-total-points" id="toc-exercise-decision-trees-35-total-points" class="nav-link" data-scroll-target="#exercise-decision-trees-35-total-points"><span class="header-section-number">2</span> Exercise: Decision trees (35% total points)</a>
  <ul class="collapse">
  <li><a href="#cartrpart" id="toc-cartrpart" class="nav-link" data-scroll-target="#cartrpart"><span class="header-section-number">2.1</span> <code>CART/rpart</code></a></li>
  <li><a href="#gradient-boosting" id="toc-gradient-boosting" class="nav-link" data-scroll-target="#gradient-boosting"><span class="header-section-number">2.2</span> Gradient boosting</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="exam_take_home.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exam - Take home</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-2_c781f9a3176fc913f6bc0edb074ccc8a">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loading data </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>financial_data_scaled_exam <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">'data/financial_data_scaled_exam.rds'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These exercises are intentionally less directed than the in-class exam to encourage exploration and personal solution/implementation. The goal of the exercises is to explore a method together with corresponding R packages, understand their basic usage then implement it or experiment their behaviour.</p>
<section id="exercise-lasso-choice-of-lambda-using-hold-out-cross-validation-25-total-points" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Exercise: Lasso: choice of lambda using hold out / cross-validation (25% total points)</h1>
<p><strong>TO DO at-home</strong></p>
<p>The aim of this exercise is to find an optimal value of the lambda parameter for Lasso regression. You won’t use the built-in functions <code>glmnetUtils::cv.glmnet</code> or <code>glmnet::cv.glmnet</code>, as done for the exam.</p>
<ul>
<li>First assume a simpler problem where your data set is split in training and testing set (you can re-use the holdout split you made at the exam).</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-3_938bb477bcb8e1ef2eb73571cdddecd3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Fit the Lasso path (more details <a href="https://glmnet.stanford.edu/reference/glmnet.html">here</a>) on the training set making use of <code>glmnetUtils::glmnet</code> or <code>glmnet::glmnet</code> functions</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-4_fec974fcda3732b5be2116739e7e7797">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>using the <code>glmnet</code> object and <code>predict</code> function, for each lambda of the Lasso path (or better for all lambdas at once) obtain the predicted probabilities on the testing/holdout set</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-5_bcb20f90186ae7d5b675fc2be47e492b">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>using the preceding step you should be able to compute the hold-out error (or criterion if AUC) for each lambda (you can use a <code>for</code> loop), then conclude on the best lambda</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-6_9d7ffe710f5950f14c0711c4e1683185">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>going one step further, replace the hold-out approach by a K-Fold Cross Validation (for each fold of you data, compute the cross-validation error (or criterion) for each lambda (you can use two nested <code>for</code> loops)); you can then conclude on the best lambda in terms of mean cross-validation error (or criterion). Finally compare the lambda chosen using your approach with the built-in function <code>cv.glmnet</code> described <a href="https://glmnet.stanford.edu/reference/cv.glmnet.html">here</a> that was used in the BONUS exercise of the exam. If you want that <code>cv.glmnet</code> operates on the same folds/splits as you to allow a closer comparison, you can use the <code>foldid</code> parameter of <code>cv.glmnet</code> (users can explicitly control the fold that each observation is assigned to via the foldid argument).</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-7_299ab85c073a7aa2d4e0be763c974d65">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercise-decision-trees-35-total-points" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Exercise: Decision trees (35% total points)</h1>
<p><strong>TO DO at-home</strong></p>
<section id="cartrpart" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="cartrpart"><span class="header-section-number">2.1</span> <code>CART/rpart</code></h2>
<ul>
<li><p>Using the data set <code>financial_data_scaled_exam</code>, build and plot a decision tree of your choice using <code>rpart</code>. You can use default parameters or tweak it and this way learn their effect. (see for example 2. Building the treecin <code>rpart</code> vignette <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">here</a>).</p></li>
<li><p>Try to display class probabilities and number of observations per node/leaf (for that explore functions <code>rpart.plot</code> or <code>pdp</code> from package <code>rpart.plot</code> see <a href="http://www.milbo.org/doc/prp.pdf">vignette</a>).</p></li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-8_0977b0f926756a35f704b9172a66b4d4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Explain briefly how the score / probabilities / class are assigned to a single observation using the tree.</p>
<ul>
<li>Playing with <code>rpart</code> parameters (in particular those inside <code>rpart.control</code>), fit, plot, then compare a “larger/deeper” decision tree and a “smaller/shallower” tree in terms of ROC/AUC/prediction on the holdout set from the exam. Looking at the ROC curves, especially those of the smaller tree, you should remark something peculiar with the ROC curve aspect, can you explain?</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-9_2df54fdda252bcc887fd83d526de851c">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Try to understand the pruning process of a decision tree. You don’t have to understand deeply the pruning algorithm but understand what is at stake in the process (see for example 4. Pruning the tree of package <code>rpart</code> vignette <a href="https://cran.r-project.org/web/packages/rpart/vignettes/longintro.pdf">here</a> or chapter 9. Additive Models, Trees, and Related Methods, p.&nbsp;308 of <span class="citation" data-cites="hastie2009">Hastie et al. (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span>) and also how to prune a tree with in practice <code>rpart</code>. Display the output of the <code>printcp</code> function for your “larger/deeper” tree, look at the package documentation to understand the meaning of the columns:</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-10_02907d859d2ea199dfe15f64a4bc2fdd">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Choose an arbitrary terminal number of leaves (closely linked to the number of splits <code>nsplits</code>) and the corresponding <code>cp</code> parameter, then prune the tree using the <code>prune</code> function. and <code>cp</code> parameter:</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-11_b389a9699d540bf928477f2bf0e83d0f">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Select an optimal <code>cp</code> parameter for your tree (you can use a plot given by <code>plotcp</code>) and compare to the “large” and “small” models fitted before in terms of ROC curve / AUC.</li>
</ul>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-12_890bf76bf26ac889bc0d626d6578cb3c">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gradient-boosting" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="gradient-boosting"><span class="header-section-number">2.2</span> Gradient boosting</h2>
<p>Using a gradient boosting package of your choice <code>gbm</code> or <code>xgboost</code>, assess the hyperparameters (i) number of boosting iterations, (ii) learning rate and (iii) weak learner complexity (decision tree depth, min number of observations) on the financial_data_scaled_exam data. You can use learning curves (ie misclassification error or AUC on testing set versus number of iterations) or ROC curves. You can take inspiration from this short example from scikit-learn documentation <a href="https://scikit-learn.org/stable/auto_examples/ensemble/plot_gradient_boosting_regularization.html">here</a>) which reproduces figures from <span class="citation" data-cites="hastie2009">Hastie et al. (<a href="#ref-hastie2009" role="doc-biblioref">2009</a>)</span> (Chapter 10 Boosting and Additive Trees, figures 10.9/11/12). Time permitting you can also compare the logistic loss (<code>bernoulli</code>) with the exponential loss (<code>adaboost</code>).</p>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-13_805c3ef4158123b19e5460c9433e46e0">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YOUR CODE HERE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example usage of <code>gbm</code> (more <a href="https://cran.r-project.org/web/packages/gbm/vignettes/gbm.pdf">here</a>, see for example the Figure 3 showing Out-of-sample predictive performance by number of iterations and shrinkage/learning rate):</p>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-14_77502cd224d7dfe35ca85e6f564897ab">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(gbm)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gbm_deg &lt;- gbm(Y~.,</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#            data = YOUR_DATA,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#            n.trees = N, # number of boosting iterations</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#            distribution = "bernoulli", # loss minimized</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#            interaction.depth = 1, </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#            /!\ interaction.depth (~#{terminal nodes}+1) &lt;&gt; rpart maxdepth</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                n.minobsinnode = 1, # comparable to rpart minbucket</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">#            shrinkage = 1, # learning rate</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#            bag.fraction = 1) # set at 1 to implement pure boosting </span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#            # (otherwise stochastic boosting, ie mix of boosting and bagging)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example usage of <code>xgboost</code> (see <a href="https://xgboost.readthedocs.io/en/stable/R-package/xgboostPresentation.html">here</a> for the <code>R</code> package):</p>
<div class="cell" data-hash="exam_take_home_cache/html/unnamed-chunk-15_5e3abd4f94f738dd9f85414cf3399ae2">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#library(xgboost)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># xgb_deg &lt;- xgboost(data = as.matrix(YOUR_PREDICTORS),</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#            label = as.vector(YOUR_TARGET),</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#            max.depth = 1, # comparable to rpart maxdepth</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#            eta = 1, # learning rate</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#            nthread = 1,</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#            nrounds = num_tree, # number of boosting iterations</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#             min_child_weight = 0, # similar but not comparable to rpart minbucket</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#             objective = "binary:logistic", # loss minimized</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#             lambda = 0, # set at 0 to avoid L2 penalization</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#             tree_method = "exact") </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="list">
<div id="ref-hastie2009" class="csl-entry" role="listitem">
Hastie, T., Tibshirani, R., &amp; Friedman, J. (2009). <em>The elements of statistical learning</em>. Springer New York. <a href="https://doi.org/10.1007/978-0-387-84858-7">https://doi.org/10.1007/978-0-387-84858-7</a>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>